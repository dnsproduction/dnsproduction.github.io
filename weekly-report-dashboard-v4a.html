<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Report Dashboard - EPC Project Management v4 TKDN</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Plus Jakarta Sans',-apple-system,sans-serif}
        body{background:#f8fafc;min-height:100vh}
        .btn{padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;border:none;display:inline-flex;align-items:center;gap:8px;font-size:14px}
        .btn-primary{background:linear-gradient(135deg,#0d9488,#0f766e);color:white}
        .btn-primary:hover{transform:translateY(-1px)}
        .btn-secondary{background:#f1f5f9;color:#475569}
        .btn-danger{background:#fef2f2;color:#dc2626}
        .btn-sm{padding:6px 12px;font-size:12px}
        .btn-xs{padding:4px 8px;font-size:11px}
        .card{background:white;border-radius:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden}
        .input{width:100%;padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px}
        .input:focus{outline:none;border-color:#0d9488}
        .input-sm{padding:8px 12px;font-size:13px}
        .input:disabled{background:#f0fdf4;color:#16a34a;border-color:#10b981}
        .label{display:block;font-size:12px;font-weight:600;color:#475569;margin-bottom:4px}
        .select{width:100%;padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;background:white}
        .sidebar{width:240px;background:linear-gradient(180deg,#0f766e,#115e59);min-height:100vh;padding:20px 12px;position:fixed;left:0;top:0;z-index:100}
        .sidebar.collapsed{width:60px}
        .sidebar.collapsed .sidebar-text{display:none}
        .main-content{margin-left:240px;padding:20px;min-height:100vh}
        .main-content.expanded{margin-left:60px}
        .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;color:rgba(255,255,255,0.7);border-radius:8px;cursor:pointer;transition:all 0.2s;margin-bottom:2px;font-size:13px}
        .nav-item:hover{background:rgba(255,255,255,0.1);color:white}
        .nav-item.active{background:rgba(255,255,255,0.2);color:white;font-weight:600}
        .stat-card{background:white;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        .progress-bar{height:8px;background:#e2e8f0;border-radius:999px;overflow:hidden}
        .progress-fill{height:100%;border-radius:999px}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
        .modal{background:white;border-radius:16px;max-width:1100px;width:95%;max-height:90vh;overflow-y:auto}
        .toast{position:fixed;bottom:20px;right:20px;background:#0f766e;color:white;padding:14px 20px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.2);z-index:2000;display:flex;align-items:center;gap:10px;font-size:14px}
        .badge{padding:3px 10px;border-radius:999px;font-size:11px;font-weight:600}
        .badge-success{background:#dcfce7;color:#16a34a}
        .badge-warning{background:#fef3c7;color:#d97706}
        .badge-danger{background:#fee2e2;color:#dc2626}
        .badge-info{background:#dbeafe;color:#2563eb}
        .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
        .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
        .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
        .grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
        .grid-6{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
        @media(max-width:1400px){.grid-6{grid-template-columns:repeat(3,1fr)}}
        @media(max-width:1200px){.grid-4,.grid-5,.grid-6{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:768px){.grid-2,.grid-3,.grid-4,.grid-5,.grid-6{grid-template-columns:1fr}.sidebar{transform:translateX(-100%)}.main-content{margin-left:0!important}}
        .table{width:100%;border-collapse:collapse;font-size:13px}
        .table th{background:#f8fafc;padding:10px 12px;text-align:left;font-weight:600;color:#475569;border-bottom:1px solid #e2e8f0}
        .table td{padding:10px 12px;border-bottom:1px solid #f1f5f9}
        .table tr:hover{background:#f8fafc}
        .tab-btn{padding:10px 20px;border:none;background:transparent;cursor:pointer;font-weight:500;color:#64748b;border-bottom:2px solid transparent}
        .tab-btn.active{color:#0f766e;border-bottom-color:#0f766e}
        .upload-zone{border:2px dashed #cbd5e1;border-radius:10px;padding:20px;text-align:center;cursor:pointer}
        .upload-zone:hover{border-color:#0d9488;background:#f0fdfa}
        .auto-calc{background:#f0fdf4!important;border-color:#10b981!important;color:#16a34a!important}
        .formula-box{background:#fffbeb;border:1px solid #fbbf24;border-radius:8px;padding:12px;margin-top:12px}
        .metric-card{padding:10px;border-radius:8px;text-align:center}
        .metric-card.green{background:#dcfce7;border:1px solid #22c55e}
        .metric-card.yellow{background:#fef3c7;border:1px solid #f59e0b}
        .metric-card.red{background:#fee2e2;border:1px solid #ef4444}
        .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
        .status-dot.green{background:#22c55e}
        .status-dot.yellow{background:#f59e0b}
        .status-dot.red{background:#ef4444}
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useMemo}=React;

const Icons={
    Dashboard:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>,
    Report:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>,
    Project:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
    Chart:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
    Analysis:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><path d="M21 21H4.6c-.6 0-1.1-.2-1.4-.6-.4-.4-.6-.9-.6-1.4V3"/></svg>,
    Database:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
    Plus:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    Edit:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:14,height:14}}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
    Delete:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:14,height:14}}><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
    Copy:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:14,height:14}}><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
    Download:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
    Eye:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:14,height:14}}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
    Menu:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
    Check:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:14,height:14}}><polyline points="20 6 9 17 4 12"/></svg>,
    X:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:14,height:14}}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    ArrowUp:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:12,height:12}}><polyline points="18 15 12 9 6 15"/></svg>,
    ArrowDown:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:12,height:12}}><polyline points="6 9 12 15 18 9"/></svg>,
    Image:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:20,height:20}}><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
    Save:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>,
    Calculator:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:16,height:16}}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><circle cx="8" cy="10" r="1"/><circle cx="12" cy="10" r="1"/><circle cx="16" cy="10" r="1"/><circle cx="8" cy="14" r="1"/><circle cx="12" cy="14" r="1"/><circle cx="16" cy="14" r="1"/></svg>,
    DollarSign:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:18,height:18}}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
};

const SafetyPyramid=({hse})=>{
    const levels=[
        {label:'Fatality',value:hse?.lagging?.fatality||0,color:'#dc2626',bg:'#fee2e2'},
        {label:'Lost Time Injury',value:hse?.lagging?.lti||0,color:'#f97316',bg:'#ffedd5'},
        {label:'Medical Treatment',value:hse?.lagging?.medicalTreatment||0,color:'#eab308',bg:'#fef9c3'},
        {label:'First Aid',value:hse?.lagging?.firstAid||0,color:'#84cc16',bg:'#ecfccb'},
        {label:'Near Miss',value:hse?.leading?.nearMiss||0,color:'#22c55e',bg:'#dcfce7'},
        {label:'Safety Observation',value:hse?.leading?.safetyObservation||0,color:'#0d9488',bg:'#ccfbf1'}
    ];
    return(
        <div style={{textAlign:'center'}}>
            <svg viewBox="0 0 300 210" style={{width:'100%',maxWidth:380}}>
                {levels.map((l,i)=>{
                    const tw=40+i*42,bw=82+i*42,y=i*34,h=32,cx=150;
                    return(<g key={i}><path d={`M${cx-tw/2} ${y} L${cx+tw/2} ${y} L${cx+bw/2} ${y+h} L${cx-bw/2} ${y+h} Z`} fill={l.bg} stroke={l.color} strokeWidth="2"/><text x={cx} y={y+h/2+5} textAnchor="middle" fontSize="13" fontWeight="800" fill={l.color}>{l.value}</text></g>);
                })}
            </svg>
            <div style={{display:'flex',flexWrap:'wrap',gap:8,justifyContent:'center',marginTop:8}}>
                {levels.map((l,i)=>(<div key={i} style={{display:'flex',alignItems:'center',gap:4,fontSize:9}}><div style={{width:10,height:10,borderRadius:2,background:l.bg,border:`1px solid ${l.color}`}}></div><span style={{color:'#64748b'}}>{l.label}</span></div>))}
            </div>
        </div>
    );
};

const AreaChartSVG=({data,height=180})=>{
    if(!data||data.length===0)return<div style={{textAlign:'center',color:'#94a3b8',padding:30}}>No data</div>;
    const w=100,p={top:20,right:10,bottom:25,left:12},cW=w-p.left-p.right,cH=height-p.top-p.bottom;
    const maxV=Math.max(...data.flatMap(d=>[d.baseline||0,d.actual||0]),100);
    const getX=(i)=>p.left+(i/Math.max(data.length-1,1))*cW;
    const getY=(v)=>p.top+cH-(v/maxV)*cH;
    const actualPath=data.map((d,i)=>`${i===0?'M':'L'}${getX(i)},${getY(d.actual||0)}`).join(' ');
    const baselinePath=data.map((d,i)=>`${i===0?'M':'L'}${getX(i)},${getY(d.baseline||0)}`).join(' ');
    const actualArea=`${actualPath} L${getX(data.length-1)},${p.top+cH} L${p.left},${p.top+cH} Z`;
    return(
        <svg viewBox={`0 0 ${w} ${height}`} style={{width:'100%',height}}>
            <defs><linearGradient id="aG" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#0d9488" stopOpacity="0.4"/><stop offset="100%" stopColor="#0d9488" stopOpacity="0"/></linearGradient></defs>
            {[0,25,50,75,100].map(v=>(<g key={v}><line x1={p.left} y1={getY(v)} x2={w-p.right} y2={getY(v)} stroke="#e2e8f0" strokeWidth="0.2"/><text x={p.left-1} y={getY(v)} fontSize="2.5" fill="#94a3b8" textAnchor="end" dominantBaseline="middle">{v}%</text></g>))}
            <path d={actualArea} fill="url(#aG)"/><path d={baselinePath} fill="none" stroke="#94a3b8" strokeWidth="0.4" strokeDasharray="2,1"/><path d={actualPath} fill="none" stroke="#0d9488" strokeWidth="0.7"/>
            {data.map((d,i)=>(<g key={i}><circle cx={getX(i)} cy={getY(d.actual||0)} r="1" fill="#0d9488"/><text x={getX(i)} y={height-6} fontSize="2.5" fill="#64748b" textAnchor="middle">{d.week}</text></g>))}
        </svg>
    );
};

const GaugeChart=({value,label,color='#0d9488'})=>(
    <div style={{textAlign:'center'}}>
        <svg width="90" height="55" viewBox="0 0 90 55">
            <path d="M 10 50 A 35 35 0 0 1 80 50" fill="none" stroke="#e2e8f0" strokeWidth="7" strokeLinecap="round"/>
            <path d="M 10 50 A 35 35 0 0 1 80 50" fill="none" stroke={color} strokeWidth="7" strokeLinecap="round" strokeDasharray={`${Math.min(value/1.5,1)*110} 110`}/>
            <text x="45" y="48" textAnchor="middle" fontSize="13" fontWeight="700" fill="#0f172a">{value.toFixed(2)}</text>
        </svg>
        <p style={{fontSize:10,color:'#64748b'}}>{label}</p>
    </div>
);

const CashFlowChart=({cashFlow})=>{
    if(!cashFlow)return<div style={{textAlign:'center',color:'#94a3b8',padding:20,fontSize:12}}>No data</div>;
    const{revenue,cashOut,billing,cashIn}=cashFlow;
    const maxVal=Math.max(revenue||0,cashOut||0,billing||0,cashIn||0,1);
    const bars=[
        {label:'Revenue',value:revenue||0,color:'#10b981'},
        {label:'Cash Out',value:cashOut||0,color:'#ef4444'},
        {label:'Billing',value:billing||0,color:'#3b82f6'},
        {label:'Cash In',value:cashIn||0,color:'#8b5cf6'}
    ];
    return(
        <div style={{display:'flex',gap:8,alignItems:'flex-end',height:100,padding:'10px 0'}}>
            {bars.map((b,i)=>(
                <div key={i} style={{flex:1,textAlign:'center'}}>
                    <div style={{height:60,display:'flex',alignItems:'flex-end',justifyContent:'center'}}>
                        <div style={{width:'100%',maxWidth:35,height:`${(b.value/maxVal)*100}%`,minHeight:4,background:b.color,borderRadius:'4px 4px 0 0'}}></div>
                    </div>
                    <p style={{fontSize:9,fontWeight:700,marginTop:4}}>${(b.value/1e6).toFixed(1)}M</p>
                    <p style={{fontSize:8,color:'#64748b'}}>{b.label}</p>
                </div>
            ))}
        </div>
    );
};

// Cash Flow Performance Indicator Component
const CashFlowIndicator=({label,value,unit='',threshold,inverse=false,formula})=>{
    let status='green';
    if(threshold){
        if(inverse){
            status=value<=threshold.green?'green':value<=threshold.yellow?'yellow':'red';
        }else{
            status=value>=threshold.green?'green':value>=threshold.yellow?'yellow':'red';
        }
    }
    const emoji=status==='green'?'üü¢':status==='yellow'?'üü°':'üî¥';
    return(
        <div className={`metric-card ${status}`}>
            <p style={{fontSize:9,color:'#64748b',marginBottom:2}}>{label}</p>
            <p style={{fontSize:16,fontWeight:800}}>{typeof value==='number'?value.toFixed(2):value}{unit}</p>
            <p style={{fontSize:10}}>{emoji}</p>
            {formula&&<p style={{fontSize:8,color:'#64748b',marginTop:2}}>{formula}</p>}
        </div>
    );
};

// Quality AFI Stacked Bar Chart
const QualityAFIChart=({data,title,color})=>{
    const disciplines=['Process','Mechanical','Piping','Electrical','Instrument','Civil'];
    const maxVal=Math.max(...data.map(d=>(d.fail||0)+(d.ongoing||0)+(d.pass||0)),1);
    return(
        <div style={{background:'#f8fafc',padding:12,borderRadius:8}}>
            <p style={{fontSize:11,fontWeight:600,marginBottom:10,color}}>{title}</p>
            <div style={{display:'flex',flexDirection:'column',gap:6}}>
                {disciplines.map((disc,i)=>{
                    const d=data[i]||{};
                    const total=(d.fail||0)+(d.ongoing||0)+(d.pass||0);
                    const failW=total>0?((d.fail||0)/maxVal)*100:0;
                    const ongoingW=total>0?((d.ongoing||0)/maxVal)*100:0;
                    const passW=total>0?((d.pass||0)/maxVal)*100:0;
                    return(
                        <div key={disc} style={{display:'flex',alignItems:'center',gap:8}}>
                            <span style={{fontSize:9,width:55,color:'#64748b'}}>{disc}</span>
                            <div style={{flex:1,height:14,background:'#e2e8f0',borderRadius:4,overflow:'hidden',display:'flex'}}>
                                {failW>0&&<div style={{width:`${failW}%`,background:'#ef4444',height:'100%'}}></div>}
                                {ongoingW>0&&<div style={{width:`${ongoingW}%`,background:'#f59e0b',height:'100%'}}></div>}
                                {passW>0&&<div style={{width:`${passW}%`,background:'#22c55e',height:'100%'}}></div>}
                            </div>
                            <span style={{fontSize:9,fontWeight:600,width:25,textAlign:'right'}}>{total}</span>
                        </div>
                    );
                })}
            </div>
            <div style={{display:'flex',justifyContent:'center',gap:12,marginTop:8}}>
                <span style={{fontSize:8,display:'flex',alignItems:'center',gap:3}}><span style={{width:8,height:8,background:'#ef4444',borderRadius:2}}></span>Fail</span>
                <span style={{fontSize:8,display:'flex',alignItems:'center',gap:3}}><span style={{width:8,height:8,background:'#f59e0b',borderRadius:2}}></span>Ongoing</span>
                <span style={{fontSize:8,display:'flex',alignItems:'center',gap:3}}><span style={{width:8,height:8,background:'#22c55e',borderRadius:2}}></span>Pass</span>
            </div>
        </div>
    );
};

// Quality NCR/Punch Comparison Chart
const QualityNCRPunchChart=({ncrData,punchData,title})=>{
    const disciplines=['Proc','Mech','Pipe','Elec','Inst','Civil'];
    return(
        <div style={{background:'#f8fafc',padding:12,borderRadius:8}}>
            <p style={{fontSize:11,fontWeight:600,marginBottom:10,color:'#dc2626'}}>{title}</p>
            <div style={{display:'flex',gap:16}}>
                <div style={{flex:1}}>
                    <p style={{fontSize:9,color:'#64748b',marginBottom:6,textAlign:'center'}}>NCR Open/Closed</p>
                    <svg viewBox="0 0 120 70" style={{width:'100%',height:70}}>
                        {disciplines.map((d,i)=>{
                            const ncr=ncrData[i]||{open:0,closed:0};
                            const x=10+i*18;
                            const maxH=50;
                            const openH=Math.min((ncr.open||0)*8,maxH);
                            const closedH=Math.min((ncr.closed||0)*4,maxH);
                            return(
                                <g key={d}>
                                    <rect x={x} y={60-openH} width={6} height={openH} fill="#ef4444" rx="1"/>
                                    <rect x={x+7} y={60-closedH} width={6} height={closedH} fill="#22c55e" rx="1"/>
                                    <text x={x+6} y={68} fontSize="6" fill="#64748b" textAnchor="middle">{d}</text>
                                </g>
                            );
                        })}
                    </svg>
                </div>
                <div style={{flex:1}}>
                    <p style={{fontSize:9,color:'#64748b',marginBottom:6,textAlign:'center'}}>Punch Open/Closed</p>
                    <svg viewBox="0 0 120 70" style={{width:'100%',height:70}}>
                        {disciplines.map((d,i)=>{
                            const pl=punchData[i]||{open:0,closed:0};
                            const x=10+i*18;
                            const maxH=50;
                            const openH=Math.min((pl.open||0)*5,maxH);
                            const closedH=Math.min((pl.closed||0)*3,maxH);
                            return(
                                <g key={d}>
                                    <rect x={x} y={60-openH} width={6} height={openH} fill="#f59e0b" rx="1"/>
                                    <rect x={x+7} y={60-closedH} width={6} height={closedH} fill="#22c55e" rx="1"/>
                                    <text x={x+6} y={68} fontSize="6" fill="#64748b" textAnchor="middle">{d}</text>
                                </g>
                            );
                        })}
                    </svg>
                </div>
            </div>
            <div style={{display:'flex',justifyContent:'center',gap:12,marginTop:4}}>
                <span style={{fontSize:8,display:'flex',alignItems:'center',gap:3}}><span style={{width:8,height:8,background:'#ef4444',borderRadius:2}}></span>NCR Open</span>
                <span style={{fontSize:8,display:'flex',alignItems:'center',gap:3}}><span style={{width:8,height:8,background:'#f59e0b',borderRadius:2}}></span>Punch Open</span>
                <span style={{fontSize:8,display:'flex',alignItems:'center',gap:3}}><span style={{width:8,height:8,background:'#22c55e',borderRadius:2}}></span>Closed</span>
            </div>
        </div>
    );
};

// Welding Performance Gauge
const WeldingGauge=({accepted,rejected,targetRate})=>{
    const total=accepted+rejected;
    const actualRate=total>0?(rejected/total)*100:0;
    const passRate=total>0?(accepted/total)*100:0;
    const status=actualRate<=targetRate?'Pass':actualRate<=targetRate*1.5?'Warning':'Fail';
    const gaugeColor=status==='Pass'?'#22c55e':status==='Warning'?'#f59e0b':'#ef4444';
    const angle=Math.min((actualRate/(targetRate*2))*180,180);
    
    return(
        <div style={{background:status==='Pass'?'#f0fdf4':status==='Warning'?'#fffbeb':'#fef2f2',padding:12,borderRadius:8,textAlign:'center'}}>
            <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:gaugeColor}}>üîß Welding Performance</p>
            <svg viewBox="0 0 100 60" style={{width:120,height:72}}>
                <defs>
                    <linearGradient id="weldGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stopColor="#22c55e"/>
                        <stop offset="50%" stopColor="#f59e0b"/>
                        <stop offset="100%" stopColor="#ef4444"/>
                    </linearGradient>
                </defs>
                <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke="#e2e8f0" strokeWidth="8" strokeLinecap="round"/>
                <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke="url(#weldGrad)" strokeWidth="8" strokeLinecap="round" strokeDasharray="126" strokeDashoffset="0"/>
                <line x1="50" y1="55" x2={50+35*Math.cos((180-angle)*Math.PI/180)} y2={55-35*Math.sin((180-angle)*Math.PI/180)} stroke={gaugeColor} strokeWidth="2" strokeLinecap="round"/>
                <circle cx="50" cy="55" r="4" fill={gaugeColor}/>
                <text x="50" y="48" textAnchor="middle" fontSize="10" fontWeight="700" fill={gaugeColor}>{actualRate.toFixed(1)}%</text>
                <text x="10" y="58" fontSize="6" fill="#22c55e">0%</text>
                <text x="50" y="12" fontSize="6" fill="#f59e0b" textAnchor="middle">{targetRate}%</text>
                <text x="85" y="58" fontSize="6" fill="#ef4444">{targetRate*2}%</text>
            </svg>
            <div style={{display:'flex',justifyContent:'space-around',marginTop:8}}>
                <div><p style={{fontSize:9,color:'#64748b'}}>Accepted</p><p style={{fontSize:14,fontWeight:700,color:'#22c55e'}}>{accepted}</p></div>
                <div><p style={{fontSize:9,color:'#64748b'}}>Rejected</p><p style={{fontSize:14,fontWeight:700,color:'#ef4444'}}>{rejected}</p></div>
                <div><p style={{fontSize:9,color:'#64748b'}}>Total</p><p style={{fontSize:14,fontWeight:700}}>{total}</p></div>
            </div>
            <div style={{marginTop:8,padding:6,background:gaugeColor,borderRadius:6}}>
                <p style={{fontSize:12,fontWeight:700,color:'white'}}>{status==='Pass'?'‚úÖ PASS':status==='Warning'?'‚ö†Ô∏è WARNING':'‚ùå FAIL'}</p>
            </div>
        </div>
    );
};

// Quality Donut Chart
const QualityDonutChart=({open,closed,title,openColor='#ef4444',closedColor='#22c55e'})=>{
    const total=open+closed;
    const openPct=total>0?(open/total)*100:0;
    const closedPct=total>0?(closed/total)*100:0;
    const circumference=2*Math.PI*35;
    const openDash=(openPct/100)*circumference;
    const closedDash=(closedPct/100)*circumference;
    
    return(
        <div style={{textAlign:'center'}}>
            <p style={{fontSize:10,fontWeight:600,marginBottom:4,color:'#475569'}}>{title}</p>
            <svg viewBox="0 0 100 100" style={{width:80,height:80}}>
                <circle cx="50" cy="50" r="35" fill="none" stroke="#e2e8f0" strokeWidth="10"/>
                <circle cx="50" cy="50" r="35" fill="none" stroke={closedColor} strokeWidth="10" 
                    strokeDasharray={`${closedDash} ${circumference}`} strokeDashoffset="0" transform="rotate(-90 50 50)"/>
                <circle cx="50" cy="50" r="35" fill="none" stroke={openColor} strokeWidth="10" 
                    strokeDasharray={`${openDash} ${circumference}`} strokeDashoffset={-closedDash} transform="rotate(-90 50 50)"/>
                <text x="50" y="47" textAnchor="middle" fontSize="14" fontWeight="700" fill="#0f172a">{total}</text>
                <text x="50" y="58" textAnchor="middle" fontSize="8" fill="#64748b">Total</text>
            </svg>
            <div style={{display:'flex',justifyContent:'center',gap:8,marginTop:4}}>
                <span style={{fontSize:8,color:openColor,fontWeight:600}}>{open} Open</span>
                <span style={{fontSize:8,color:closedColor,fontWeight:600}}>{closed} Closed</span>
            </div>
        </div>
    );
};

// Certificate Progress Chart
const CertificateChart=({notYetApplied,underApplication,completed})=>{
    const total=(notYetApplied||0)+(underApplication||0)+(completed||0);
    const completedPct=total>0?(completed/total)*100:0;
    const underAppPct=total>0?(underApplication/total)*100:0;
    const notYetPct=total>0?(notYetApplied/total)*100:0;
    
    return(
        <div style={{background:'linear-gradient(135deg,#faf5ff,#f3e8ff)',padding:16,borderRadius:12,border:'1px solid #a855f7'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
                <h4 style={{fontSize:13,fontWeight:700,color:'#7c3aed'}}>üìú Certificate Status</h4>
                <span style={{background:'#7c3aed',color:'white',padding:'4px 10px',borderRadius:20,fontSize:11,fontWeight:700}}>{total} Total</span>
            </div>
            
            {/* Progress Bar */}
            <div style={{height:24,background:'#e2e8f0',borderRadius:12,overflow:'hidden',display:'flex',marginBottom:12}}>
                {completedPct>0&&<div style={{width:`${completedPct}%`,background:'linear-gradient(90deg,#22c55e,#16a34a)',display:'flex',alignItems:'center',justifyContent:'center'}}><span style={{fontSize:9,color:'white',fontWeight:600}}>{completed}</span></div>}
                {underAppPct>0&&<div style={{width:`${underAppPct}%`,background:'linear-gradient(90deg,#f59e0b,#d97706)',display:'flex',alignItems:'center',justifyContent:'center'}}><span style={{fontSize:9,color:'white',fontWeight:600}}>{underApplication}</span></div>}
                {notYetPct>0&&<div style={{width:`${notYetPct}%`,background:'linear-gradient(90deg,#94a3b8,#64748b)',display:'flex',alignItems:'center',justifyContent:'center'}}><span style={{fontSize:9,color:'white',fontWeight:600}}>{notYetApplied}</span></div>}
            </div>
            
            {/* Stats Grid */}
            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8}}>
                <div style={{background:'white',padding:10,borderRadius:8,textAlign:'center',border:'2px solid #22c55e'}}>
                    <p style={{fontSize:9,color:'#64748b'}}>‚úÖ Completed</p>
                    <p style={{fontSize:20,fontWeight:800,color:'#22c55e'}}>{completed||0}</p>
                    <p style={{fontSize:10,color:'#16a34a',fontWeight:600}}>{completedPct.toFixed(1)}%</p>
                </div>
                <div style={{background:'white',padding:10,borderRadius:8,textAlign:'center',border:'2px solid #f59e0b'}}>
                    <p style={{fontSize:9,color:'#64748b'}}>‚è≥ Under App.</p>
                    <p style={{fontSize:20,fontWeight:800,color:'#f59e0b'}}>{underApplication||0}</p>
                    <p style={{fontSize:10,color:'#d97706',fontWeight:600}}>{underAppPct.toFixed(1)}%</p>
                </div>
                <div style={{background:'white',padding:10,borderRadius:8,textAlign:'center',border:'2px solid #94a3b8'}}>
                    <p style={{fontSize:9,color:'#64748b'}}>üìã Not Yet</p>
                    <p style={{fontSize:20,fontWeight:800,color:'#64748b'}}>{notYetApplied||0}</p>
                    <p style={{fontSize:10,color:'#475569',fontWeight:600}}>{notYetPct.toFixed(1)}%</p>
                </div>
            </div>
            
            {/* Legend */}
            <div style={{display:'flex',justifyContent:'center',gap:16,marginTop:10}}>
                <span style={{fontSize:9,display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,background:'#22c55e',borderRadius:2}}></span>Completed</span>
                <span style={{fontSize:9,display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,background:'#f59e0b',borderRadius:2}}></span>Under Application</span>
                <span style={{fontSize:9,display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,background:'#94a3b8',borderRadius:2}}></span>Not Yet Applied</span>
            </div>
        </div>
    );
};

// TKDN Gauge Component
const TKDNGauge=({plan,actual,title='TKDN'})=>{
    const variance=actual-plan;
    const status=actual>=plan?'Pass':actual>=plan*0.9?'Warning':'Fail';
    const gaugeColor=status==='Pass'?'#22c55e':status==='Warning'?'#f59e0b':'#ef4444';
    const maxVal=100;
    const angle=Math.min((actual/maxVal)*180,180);
    const planAngle=Math.min((plan/maxVal)*180,180);
    
    return(
        <div style={{background:status==='Pass'?'#f0fdf4':status==='Warning'?'#fffbeb':'#fef2f2',padding:16,borderRadius:12,textAlign:'center',border:`2px solid ${gaugeColor}`}}>
            <p style={{fontSize:13,fontWeight:700,marginBottom:10,color:gaugeColor}}>üè≠ {title}</p>
            <svg viewBox="0 0 100 65" style={{width:140,height:91}}>
                <defs>
                    <linearGradient id="tkdnGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stopColor="#ef4444"/>
                        <stop offset="50%" stopColor="#f59e0b"/>
                        <stop offset="100%" stopColor="#22c55e"/>
                    </linearGradient>
                </defs>
                {/* Background arc */}
                <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke="#e2e8f0" strokeWidth="8" strokeLinecap="round"/>
                {/* Gradient arc */}
                <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke="url(#tkdnGrad)" strokeWidth="8" strokeLinecap="round"/>
                {/* Plan indicator line */}
                <line x1="50" y1="55" x2={50+32*Math.cos((180-planAngle)*Math.PI/180)} y2={55-32*Math.sin((180-planAngle)*Math.PI/180)} stroke="#3b82f6" strokeWidth="2" strokeDasharray="3,2"/>
                {/* Actual indicator needle */}
                <line x1="50" y1="55" x2={50+38*Math.cos((180-angle)*Math.PI/180)} y2={55-38*Math.sin((180-angle)*Math.PI/180)} stroke={gaugeColor} strokeWidth="3" strokeLinecap="round"/>
                <circle cx="50" cy="55" r="5" fill={gaugeColor}/>
                {/* Labels */}
                <text x="50" y="45" textAnchor="middle" fontSize="14" fontWeight="800" fill={gaugeColor}>{actual.toFixed(1)}%</text>
                <text x="8" y="62" fontSize="6" fill="#ef4444">0%</text>
                <text x="50" y="10" fontSize="6" fill="#64748b" textAnchor="middle">Target: {plan}%</text>
                <text x="88" y="62" fontSize="6" fill="#22c55e">100%</text>
            </svg>
            <div style={{display:'flex',justifyContent:'space-around',marginTop:10,gap:8}}>
                <div style={{background:'white',padding:8,borderRadius:6,flex:1}}>
                    <p style={{fontSize:9,color:'#3b82f6',fontWeight:600}}>Plan/Target</p>
                    <p style={{fontSize:16,fontWeight:800,color:'#3b82f6'}}>{plan}%</p>
                </div>
                <div style={{background:'white',padding:8,borderRadius:6,flex:1}}>
                    <p style={{fontSize:9,color:gaugeColor,fontWeight:600}}>Actual</p>
                    <p style={{fontSize:16,fontWeight:800,color:gaugeColor}}>{actual.toFixed(1)}%</p>
                </div>
                <div style={{background:'white',padding:8,borderRadius:6,flex:1}}>
                    <p style={{fontSize:9,color:variance>=0?'#22c55e':'#ef4444',fontWeight:600}}>Variance</p>
                    <p style={{fontSize:16,fontWeight:800,color:variance>=0?'#22c55e':'#ef4444'}}>{variance>=0?'+':''}{variance.toFixed(1)}%</p>
                </div>
            </div>
            <div style={{marginTop:10,padding:8,background:gaugeColor,borderRadius:8}}>
                <p style={{fontSize:13,fontWeight:700,color:'white'}}>{status==='Pass'?'‚úÖ MEMENUHI TARGET':status==='Warning'?'‚ö†Ô∏è PERLU PERHATIAN':'‚ùå TIDAK MEMENUHI'}</p>
            </div>
        </div>
    );
};

// TKDN Trend Chart Component
const TKDNTrendChart=({data,height=180})=>{
    if(!data||data.length===0)return<div style={{textAlign:'center',color:'#94a3b8',padding:40}}>No TKDN trend data available</div>;
    
    const w=300,h=height,p={top:25,right:20,bottom:35,left:45};
    const chartW=w-p.left-p.right;
    const chartH=h-p.top-p.bottom;
    
    const maxVal=Math.max(...data.map(d=>Math.max(d.plan||0,d.actual||0)),100);
    const minVal=Math.min(...data.map(d=>Math.min(d.plan||0,d.actual||0)),0);
    
    const getX=(i)=>p.left+(i/(data.length-1||1))*chartW;
    const getY=(v)=>p.top+chartH-((v-minVal)/(maxVal-minVal||1))*chartH;
    
    const planPath=data.map((d,i)=>`${i===0?'M':'L'}${getX(i)},${getY(d.plan||0)}`).join(' ');
    const actualPath=data.map((d,i)=>`${i===0?'M':'L'}${getX(i)},${getY(d.actual||0)}`).join(' ');
    const actualArea=actualPath+` L${getX(data.length-1)},${p.top+chartH} L${p.left},${p.top+chartH} Z`;
    
    return(
        <div style={{background:'#f8fafc',padding:12,borderRadius:8}}>
            <p style={{fontSize:12,fontWeight:700,marginBottom:10,color:'#0891b2'}}>üìà TKDN Trend Analysis</p>
            <svg viewBox={`0 0 ${w} ${h}`} style={{width:'100%',height}}>
                <defs>
                    <linearGradient id="tkdnAreaGrad" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stopColor="#0891b2" stopOpacity="0.4"/>
                        <stop offset="100%" stopColor="#0891b2" stopOpacity="0.05"/>
                    </linearGradient>
                </defs>
                
                {/* Grid lines */}
                {[0,25,50,75,100].map((pct,i)=>{
                    const y=getY(pct);
                    return(
                        <g key={i}>
                            <line x1={p.left} y1={y} x2={w-p.right} y2={y} stroke="#e2e8f0" strokeWidth="0.5"/>
                            <text x={p.left-4} y={y} fontSize="8" fill="#94a3b8" textAnchor="end" dominantBaseline="middle">{pct}%</text>
                        </g>
                    );
                })}
                
                {/* Actual area */}
                <path d={actualArea} fill="url(#tkdnAreaGrad)"/>
                
                {/* Plan line (dashed) */}
                <path d={planPath} fill="none" stroke="#3b82f6" strokeWidth="2" strokeDasharray="5,3"/>
                
                {/* Actual line */}
                <path d={actualPath} fill="none" stroke="#0891b2" strokeWidth="2.5"/>
                
                {/* Points */}
                {data.map((d,i)=>(
                    <g key={i}>
                        <circle cx={getX(i)} cy={getY(d.plan||0)} r="4" fill="#3b82f6" stroke="white" strokeWidth="1.5"/>
                        <circle cx={getX(i)} cy={getY(d.actual||0)} r="4" fill="#0891b2" stroke="white" strokeWidth="1.5"/>
                        <text x={getX(i)} y={h-10} fontSize="8" fill="#64748b" textAnchor="middle">{d.week}</text>
                    </g>
                ))}
            </svg>
            
            {/* Legend */}
            <div style={{display:'flex',justifyContent:'center',gap:16,marginTop:8}}>
                <span style={{fontSize:10,display:'flex',alignItems:'center',gap:4}}>
                    <span style={{width:16,height:3,background:'#3b82f6',borderRadius:2}}></span>
                    Plan/Target
                </span>
                <span style={{fontSize:10,display:'flex',alignItems:'center',gap:4}}>
                    <span style={{width:16,height:3,background:'#0891b2',borderRadius:2}}></span>
                    Actual
                </span>
            </div>
        </div>
    );
};

// TKDN Summary Card Component
const TKDNSummaryCard=({tkdn})=>{
    const plan=tkdn?.plan||0;
    const actual=tkdn?.actual||0;
    const variance=actual-plan;
    const status=actual>=plan?'green':actual>=plan*0.9?'yellow':'red';
    const statusColor=status==='green'?'#22c55e':status==='yellow'?'#f59e0b':'#ef4444';
    
    return(
        <div className="stat-card" style={{background:`linear-gradient(135deg,${status==='green'?'#f0fdf4,#dcfce7':status==='yellow'?'#fffbeb,#fef3c7':'#fef2f2,#fee2e2'})`}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                <div>
                    <p style={{fontSize:12,color:statusColor,fontWeight:600}}>üè≠ TKDN</p>
                    <p style={{fontSize:28,fontWeight:800,color:statusColor}}>{actual.toFixed(1)}%</p>
                    <p style={{fontSize:11,color:'#64748b'}}>Target: {plan}%</p>
                </div>
                <div style={{textAlign:'right'}}>
                    <span style={{background:statusColor,color:'white',padding:'4px 10px',borderRadius:20,fontSize:11,fontWeight:700}}>
                        {status==='green'?'‚úì OK':status==='yellow'?'‚ö† MONITOR':'‚úó RISK'}
                    </span>
                    <p style={{fontSize:18,fontWeight:800,color:variance>=0?'#22c55e':'#ef4444',marginTop:8}}>{variance>=0?'+':''}{variance.toFixed(1)}%</p>
                    <p style={{fontSize:9,color:'#64748b'}}>Variance</p>
                </div>
            </div>
        </div>
    );
};

// Certificate Donut Chart for Dashboard
const CertificateDonut=({notYetApplied,underApplication,completed})=>{
    const total=(notYetApplied||0)+(underApplication||0)+(completed||0);
    const circumference=2*Math.PI*40;
    const completedDash=total>0?((completed||0)/total)*circumference:0;
    const underAppDash=total>0?((underApplication||0)/total)*circumference:0;
    const notYetDash=total>0?((notYetApplied||0)/total)*circumference:0;
    const completedPct=total>0?((completed||0)/total)*100:0;
    
    return(
        <div style={{textAlign:'center'}}>
            <svg viewBox="0 0 100 100" style={{width:100,height:100}}>
                <circle cx="50" cy="50" r="40" fill="none" stroke="#e2e8f0" strokeWidth="12"/>
                <circle cx="50" cy="50" r="40" fill="none" stroke="#22c55e" strokeWidth="12" 
                    strokeDasharray={`${completedDash} ${circumference}`} strokeDashoffset="0" transform="rotate(-90 50 50)" strokeLinecap="round"/>
                <circle cx="50" cy="50" r="40" fill="none" stroke="#f59e0b" strokeWidth="12" 
                    strokeDasharray={`${underAppDash} ${circumference}`} strokeDashoffset={-completedDash} transform="rotate(-90 50 50)" strokeLinecap="round"/>
                <circle cx="50" cy="50" r="40" fill="none" stroke="#94a3b8" strokeWidth="12" 
                    strokeDasharray={`${notYetDash} ${circumference}`} strokeDashoffset={-(completedDash+underAppDash)} transform="rotate(-90 50 50)" strokeLinecap="round"/>
                <text x="50" y="45" textAnchor="middle" fontSize="16" fontWeight="800" fill="#0f172a">{total}</text>
                <text x="50" y="58" textAnchor="middle" fontSize="8" fill="#64748b">Certificates</text>
            </svg>
            <div style={{display:'flex',justifyContent:'center',gap:6,marginTop:6,flexWrap:'wrap'}}>
                <span style={{fontSize:8,background:'#dcfce7',color:'#16a34a',padding:'2px 6px',borderRadius:4,fontWeight:600}}>‚úÖ{completed}</span>
                <span style={{fontSize:8,background:'#fef3c7',color:'#d97706',padding:'2px 6px',borderRadius:4,fontWeight:600}}>‚è≥{underApplication}</span>
                <span style={{fontSize:8,background:'#f1f5f9',color:'#475569',padding:'2px 6px',borderRadius:4,fontWeight:600}}>üìã{notYetApplied}</span>
            </div>
        </div>
    );
};

// Trend Line Chart Component
const TrendLineChart=({data,lines,title,yLabel,height=180})=>{
    if(!data||data.length===0)return<div style={{textAlign:'center',color:'#94a3b8',padding:40}}>No trend data available</div>;
    
    const w=300,h=height,p={top:25,right:20,bottom:35,left:45};
    const chartW=w-p.left-p.right;
    const chartH=h-p.top-p.bottom;
    
    // Calculate min/max across all lines
    let allValues=[];
    lines.forEach(line=>{
        data.forEach(d=>{if(d[line.key]!==undefined)allValues.push(d[line.key]);});
    });
    const minVal=Math.min(...allValues);
    const maxVal=Math.max(...allValues);
    const range=maxVal-minVal||1;
    const yMin=minVal-range*0.1;
    const yMax=maxVal+range*0.1;
    
    const getX=i=>p.left+(i/(data.length-1||1))*chartW;
    const getY=v=>p.top+chartH-(((v-yMin)/(yMax-yMin))*chartH);
    
    return(
        <div style={{background:'#f8fafc',padding:12,borderRadius:8}}>
            <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#334155'}}>{title}</p>
            <svg viewBox={`0 0 ${w} ${h}`} style={{width:'100%',height}}>
                <defs>
                    {lines.map((line,idx)=>(
                        <linearGradient key={idx} id={`grad-${line.key}`} x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stopColor={line.color} stopOpacity="0.3"/>
                            <stop offset="100%" stopColor={line.color} stopOpacity="0.05"/>
                        </linearGradient>
                    ))}
                </defs>
                
                {/* Grid lines */}
                {[0,0.25,0.5,0.75,1].map((pct,i)=>{
                    const y=p.top+chartH*pct;
                    const val=yMax-(yMax-yMin)*pct;
                    return(
                        <g key={i}>
                            <line x1={p.left} y1={y} x2={w-p.right} y2={y} stroke="#e2e8f0" strokeWidth="0.5"/>
                            <text x={p.left-4} y={y} fontSize="7" fill="#94a3b8" textAnchor="end" dominantBaseline="middle">
                                {val>=1000000?(val/1e6).toFixed(1)+'M':val>=1000?(val/1e3).toFixed(0)+'K':val.toFixed(2)}
                            </text>
                        </g>
                    );
                })}
                
                {/* Lines and areas */}
                {lines.map((line,idx)=>{
                    const points=data.map((d,i)=>({x:getX(i),y:getY(d[line.key]||0)}));
                    const pathD=points.map((pt,i)=>`${i===0?'M':'L'}${pt.x},${pt.y}`).join(' ');
                    const areaD=pathD+` L${points[points.length-1].x},${p.top+chartH} L${points[0].x},${p.top+chartH} Z`;
                    return(
                        <g key={idx}>
                            {line.fill&&<path d={areaD} fill={`url(#grad-${line.key})`}/>}
                            <path d={pathD} fill="none" stroke={line.color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                            {points.map((pt,i)=><circle key={i} cx={pt.x} cy={pt.y} r="3" fill={line.color} stroke="white" strokeWidth="1"/>)}
                        </g>
                    );
                })}
                
                {/* X-axis labels */}
                {data.map((d,i)=>(
                    <text key={i} x={getX(i)} y={h-10} fontSize="7" fill="#64748b" textAnchor="middle">{d.week}</text>
                ))}
                
                {/* Y-axis label */}
                <text x={12} y={h/2} fontSize="8" fill="#64748b" textAnchor="middle" transform={`rotate(-90,12,${h/2})`}>{yLabel}</text>
            </svg>
            
            {/* Legend */}
            <div style={{display:'flex',justifyContent:'center',gap:12,marginTop:8,flexWrap:'wrap'}}>
                {lines.map((line,idx)=>(
                    <span key={idx} style={{fontSize:9,display:'flex',alignItems:'center',gap:4}}>
                        <span style={{width:12,height:3,background:line.color,borderRadius:2}}></span>
                        {line.label}
                    </span>
                ))}
            </div>
        </div>
    );
};

// Trend Bar Chart Component
const TrendBarChart=({data,bars,title,height=180})=>{
    if(!data||data.length===0)return<div style={{textAlign:'center',color:'#94a3b8',padding:40}}>No trend data available</div>;
    
    const w=300,h=height,p={top:25,right:20,bottom:35,left:45};
    const chartW=w-p.left-p.right;
    const chartH=h-p.top-p.bottom;
    
    let maxVal=0;
    bars.forEach(bar=>{
        data.forEach(d=>{if(d[bar.key]>maxVal)maxVal=d[bar.key];});
    });
    maxVal=maxVal||1;
    
    const groupW=chartW/data.length;
    const barW=(groupW-8)/bars.length;
    
    return(
        <div style={{background:'#f8fafc',padding:12,borderRadius:8}}>
            <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#334155'}}>{title}</p>
            <svg viewBox={`0 0 ${w} ${h}`} style={{width:'100%',height}}>
                {/* Grid lines */}
                {[0,0.25,0.5,0.75,1].map((pct,i)=>{
                    const y=p.top+chartH*(1-pct);
                    const val=maxVal*pct;
                    return(
                        <g key={i}>
                            <line x1={p.left} y1={y} x2={w-p.right} y2={y} stroke="#e2e8f0" strokeWidth="0.5"/>
                            <text x={p.left-4} y={y} fontSize="7" fill="#94a3b8" textAnchor="end" dominantBaseline="middle">
                                {val>=1000?(val/1e3).toFixed(0)+'K':val.toFixed(0)}
                            </text>
                        </g>
                    );
                })}
                
                {/* Bars */}
                {data.map((d,i)=>{
                    const groupX=p.left+i*groupW+4;
                    return(
                        <g key={i}>
                            {bars.map((bar,j)=>{
                                const barH=(d[bar.key]||0)/maxVal*chartH;
                                return(
                                    <rect key={j} x={groupX+j*barW} y={p.top+chartH-barH} width={barW-2} height={barH} fill={bar.color} rx="2"/>
                                );
                            })}
                            <text x={groupX+groupW/2-4} y={h-10} fontSize="7" fill="#64748b" textAnchor="middle">{d.week}</text>
                        </g>
                    );
                })}
            </svg>
            
            {/* Legend */}
            <div style={{display:'flex',justifyContent:'center',gap:12,marginTop:8,flexWrap:'wrap'}}>
                {bars.map((bar,idx)=>(
                    <span key={idx} style={{fontSize:9,display:'flex',alignItems:'center',gap:4}}>
                        <span style={{width:10,height:10,background:bar.color,borderRadius:2}}></span>
                        {bar.label}
                    </span>
                ))}
            </div>
        </div>
    );
};

// Combined Line and Bar Chart
const TrendComboChart=({data,lines,bars,title,height=180})=>{
    if(!data||data.length===0)return<div style={{textAlign:'center',color:'#94a3b8',padding:40}}>No trend data available</div>;
    
    const w=300,h=height,p={top:25,right:45,bottom:35,left:45};
    const chartW=w-p.left-p.right;
    const chartH=h-p.top-p.bottom;
    
    // Bar scale (left axis)
    let maxBar=0;
    bars.forEach(bar=>{data.forEach(d=>{if(d[bar.key]>maxBar)maxBar=d[bar.key];});});
    maxBar=maxBar||1;
    
    // Line scale (right axis)
    let allLineVals=[];
    lines.forEach(line=>{data.forEach(d=>{if(d[line.key]!==undefined)allLineVals.push(d[line.key]);});});
    const minLine=Math.min(...allLineVals);
    const maxLine=Math.max(...allLineVals);
    const lineRange=maxLine-minLine||1;
    
    const groupW=chartW/data.length;
    const barW=(groupW-12)/bars.length;
    
    const getLineY=v=>p.top+chartH-(((v-minLine+lineRange*0.1)/(lineRange*1.2))*chartH);
    
    return(
        <div style={{background:'#f8fafc',padding:12,borderRadius:8}}>
            <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#334155'}}>{title}</p>
            <svg viewBox={`0 0 ${w} ${h}`} style={{width:'100%',height}}>
                {/* Grid lines */}
                {[0,0.25,0.5,0.75,1].map((pct,i)=>{
                    const y=p.top+chartH*(1-pct);
                    const barVal=maxBar*pct;
                    const lineVal=minLine+(maxLine-minLine)*pct;
                    return(
                        <g key={i}>
                            <line x1={p.left} y1={y} x2={w-p.right} y2={y} stroke="#e2e8f0" strokeWidth="0.5"/>
                            <text x={p.left-4} y={y} fontSize="6" fill="#94a3b8" textAnchor="end" dominantBaseline="middle">
                                {barVal>=1e6?(barVal/1e6).toFixed(1)+'M':barVal>=1000?(barVal/1e3).toFixed(0)+'K':barVal.toFixed(0)}
                            </text>
                            <text x={w-p.right+4} y={y} fontSize="6" fill="#8b5cf6" textAnchor="start" dominantBaseline="middle">
                                {lineVal.toFixed(2)}
                            </text>
                        </g>
                    );
                })}
                
                {/* Bars */}
                {data.map((d,i)=>{
                    const groupX=p.left+i*groupW+6;
                    return(
                        <g key={i}>
                            {bars.map((bar,j)=>{
                                const barH=(d[bar.key]||0)/maxBar*chartH;
                                return<rect key={j} x={groupX+j*barW} y={p.top+chartH-barH} width={barW-2} height={barH} fill={bar.color} rx="2" opacity="0.7"/>;
                            })}
                        </g>
                    );
                })}
                
                {/* Lines */}
                {lines.map((line,idx)=>{
                    const points=data.map((d,i)=>({x:p.left+i*groupW+groupW/2,y:getLineY(d[line.key]||0)}));
                    const pathD=points.map((pt,i)=>`${i===0?'M':'L'}${pt.x},${pt.y}`).join(' ');
                    return(
                        <g key={idx}>
                            <path d={pathD} fill="none" stroke={line.color} strokeWidth="2.5" strokeLinecap="round"/>
                            {points.map((pt,i)=><circle key={i} cx={pt.x} cy={pt.y} r="4" fill={line.color} stroke="white" strokeWidth="1.5"/>)}
                        </g>
                    );
                })}
                
                {/* X-axis labels */}
                {data.map((d,i)=>(
                    <text key={i} x={p.left+i*groupW+groupW/2} y={h-10} fontSize="7" fill="#64748b" textAnchor="middle">{d.week}</text>
                ))}
            </svg>
            
            {/* Legend */}
            <div style={{display:'flex',justifyContent:'center',gap:10,marginTop:8,flexWrap:'wrap'}}>
                {bars.map((bar,idx)=>(
                    <span key={`bar-${idx}`} style={{fontSize:8,display:'flex',alignItems:'center',gap:3}}>
                        <span style={{width:10,height:10,background:bar.color,borderRadius:2}}></span>{bar.label}
                    </span>
                ))}
                {lines.map((line,idx)=>(
                    <span key={`line-${idx}`} style={{fontSize:8,display:'flex',alignItems:'center',gap:3}}>
                        <span style={{width:12,height:3,background:line.color,borderRadius:2}}></span>{line.label}
                    </span>
                ))}
            </div>
        </div>
    );
};

const App=()=>{
    const[activeMenu,setActiveMenu]=useState('dashboard');
    const[sidebarCollapsed,setSidebarCollapsed]=useState(false);
    const[showModal,setShowModal]=useState(null);
    const[notification,setNotification]=useState(null);
    const[imageViewer,setImageViewer]=useState(null);
    const[selectedReportId,setSelectedReportId]=useState(null);
    const[formData,setFormData]=useState({});
    const[editingId,setEditingId]=useState(null);
    const[activeTab,setActiveTab]=useState('general');
    const[viewReportData,setViewReportData]=useState(null);

    const defaultHSE={lagging:{fatality:0,lti:0,medicalTreatment:0,firstAid:0},leading:{nearMiss:0,safetyObservation:0,hsseInspection:0,hsseTraining:0},manpower:{office:0,siteSubcontractor:0,total:0},safeHours:0,trir:0};
    const defaultActivities={engineering:[''],procurement:[''],construction:[''],precommissioning:['']};
    const defaultCashFlow={revenue:0,cashOut:0,billing:0,cashIn:0,weekNo:1,cashFlowBalance:0,billingCoverageRatio:0,cashCollectionRatio:0,cashAdequacyRatio:0,cashBurnRate:0,earnedCashRatio:0,billingLag:0,cashGap:0,overallScore:0,overallStatus:'green'};
    const defaultTKDN={plan:40,actual:0};

    const[projects,setProjects]=useState([{id:1,name:'SALAK UNIT 7 DEVELOPMENT PROJECT',owner:'PT Pertamina Geothermal Energy',contractor:'PT REKAYASA INDUSTRI',technologyProvider:'Mitsubishi Power Ltd',contractType:'EPC Turnkey',termOfPayment:'Progress Payment & Milestone',contractPrice:125000000,bac:125000000,ldDelay:50000,ldPerformance:100000,scopeByOwner:'Site preparation, access road, temporary facilities',startDate:'2024-02-01',finishDate:'2026-10-01',guaranteedPower:45,ntpDate:'2024-02-01',codDate:'2026-10-01',status:'Active'}]);

    const[reports,setReports]=useState([{
        id:1,projectId:1,weekNo:52,docNo:'SEGSK7PMGN00RPW0052',periodStart:'2025-11-22',periodEnd:'2025-11-28',preparedBy:'Project Team',checkedBy:'Project Manager',approvedBy:'Project Director',approvalStatus:'Approved',status:'Issued',
        evm:{bcws:48987500,bcwp:49112500,acwp:50125000,bac:125000000,spiValue:1.003,cpiValue:0.98,eac:127551020,eacTypical:127551020,eacAtypical:126012500,eacCombined:125891327,vac:-2551020,sv:125000,cv:-1012500},
        epcc:{engineering:{weight:3.85,plan:87.58,actual:87.68},procurement:{weight:65,plan:52.01,actual:52.31},construction:{weight:30,plan:5.84,actual:6.37},commissioning:{weight:1.15,plan:0,actual:0}},
        overallProgress:{plan:39.19,actual:39.29,variance:0.10},
        actualForecastPower:44.5,
        hse:{lagging:{fatality:0,lti:0,medicalTreatment:0,firstAid:0},leading:{nearMiss:5,safetyObservation:2403,hsseInspection:613,hsseTraining:6508},manpower:{office:122,siteSubcontractor:370,total:492},safeHours:245000,trir:0},
        quality:{
            headOffice:{
                afi:{process:{fail:0,ongoing:2,pass:15},mechanical:{fail:1,ongoing:3,pass:25},piping:{fail:0,ongoing:5,pass:30},electrical:{fail:0,ongoing:2,pass:18},instrument:{fail:0,ongoing:1,pass:12},civil:{fail:0,ongoing:0,pass:8}},
                ncr:{ownerToContractor:{process:{open:0,closed:2},mechanical:{open:1,closed:3},piping:{open:0,closed:5},electrical:{open:0,closed:1},instrument:{open:0,closed:1},civil:{open:0,closed:0}},contractorToVendor:{process:{open:0,closed:1},mechanical:{open:2,closed:5},piping:{open:1,closed:8},electrical:{open:0,closed:2},instrument:{open:0,closed:1},civil:{open:0,closed:0}}},
                punchList:{ownerToContractor:{process:{open:0,closed:5},mechanical:{open:2,closed:10},piping:{open:3,closed:15},electrical:{open:1,closed:8},instrument:{open:0,closed:3},civil:{open:0,closed:2}},contractorToVendor:{process:{open:0,closed:3},mechanical:{open:1,closed:8},piping:{open:2,closed:12},electrical:{open:0,closed:5},instrument:{open:0,closed:2},civil:{open:0,closed:1}}}
            },
            siteOffice:{
                afi:{process:{fail:0,ongoing:1,pass:8},mechanical:{fail:0,ongoing:2,pass:12},piping:{fail:1,ongoing:4,pass:20},electrical:{fail:0,ongoing:1,pass:10},instrument:{fail:0,ongoing:0,pass:5},civil:{fail:0,ongoing:3,pass:15}},
                ncr:{ownerToContractor:{process:{open:0,closed:1},mechanical:{open:0,closed:2},piping:{open:1,closed:4},electrical:{open:0,closed:1},instrument:{open:0,closed:0},civil:{open:0,closed:1}},contractorToVendor:{process:{open:0,closed:0},mechanical:{open:1,closed:3},piping:{open:0,closed:5},electrical:{open:0,closed:1},instrument:{open:0,closed:0},civil:{open:0,closed:1}}},
                punchList:{ownerToContractor:{process:{open:0,closed:2},mechanical:{open:1,closed:5},piping:{open:2,closed:10},electrical:{open:0,closed:4},instrument:{open:0,closed:1},civil:{open:1,closed:3}},contractorToVendor:{process:{open:0,closed:1},mechanical:{open:0,closed:3},piping:{open:1,closed:7},electrical:{open:0,closed:2},instrument:{open:0,closed:0},civil:{open:0,closed:2}}},
                welding:{ndtAccepted:450,ndtRejected:5,rejectionRatePlan:2}
            },
            certificate:{notYetApplied:12,underApplication:8,completed:45}
        },
        cashFlow:{revenue:49112500,cashOut:45000000,billing:47000000,cashIn:42000000,weekNo:52},
        tkdn:{plan:40,actual:42.5},
        thisWeekActivities:{engineering:['Finalisasi P&ID sistem cooling'],procurement:['Pengiriman valve batch 3'],construction:['Pengecoran foundation area B'],precommissioning:['Persiapan prosedur pre-comm']},
        nextWeekPlan:{engineering:['Issuance IFC drawing'],procurement:['Material expediting'],construction:['Pipe rack erection'],precommissioning:['Koordinasi vendor']},
        milestonesSchedule:[{no:1,description:'Engineering Completion',planDate:'2025-03-31',actualForecastDate:'2025-04-05',status:'On Track'}],
        milestonesPayment:[{no:1,description:'Down Payment (20%)',planDate:'2024-02-15',actualForecastDate:'2024-02-15',status:'Completed'}],
        sCurveData:[{week:'W47',baseline:36.9,actual:37.2},{week:'W48',baseline:37.6,actual:37.9},{week:'W49',baseline:38.2,actual:38.5},{week:'W50',baseline:38.7,actual:39.0},{week:'W51',baseline:39.0,actual:39.1},{week:'W52',baseline:39.19,actual:39.29}],
        trendData:{
            schedule:[
                {week:'W47',spi:1.008,planProgress:36.9,actualProgress:37.2,variance:0.3},
                {week:'W48',spi:1.008,planProgress:37.6,actualProgress:37.9,variance:0.3},
                {week:'W49',spi:1.008,planProgress:38.2,actualProgress:38.5,variance:0.3},
                {week:'W50',spi:1.008,planProgress:38.7,actualProgress:39.0,variance:0.3},
                {week:'W51',spi:1.003,planProgress:39.0,actualProgress:39.1,variance:0.1},
                {week:'W52',spi:1.003,planProgress:39.19,actualProgress:39.29,variance:0.1}
            ],
            cost:[
                {week:'W47',cpi:0.99,bcws:45500000,bcwp:45800000,acwp:46262626,cv:-462626},
                {week:'W48',cpi:0.98,bcws:46500000,bcwp:46900000,acwp:47857143,cv:-957143},
                {week:'W49',cpi:0.98,bcws:47200000,bcwp:47650000,acwp:48622449,cv:-972449},
                {week:'W50',cpi:0.98,bcws:47900000,bcwp:48400000,acwp:49387755,cv:-987755},
                {week:'W51',cpi:0.98,bcws:48450000,bcwp:48750000,acwp:49744898,cv:-994898},
                {week:'W52',cpi:0.98,bcws:48987500,bcwp:49112500,acwp:50125000,cv:-1012500}
            ],
            cashFlow:[
                {week:'W47',cashIn:38000000,cashOut:41000000,billing:43000000,balance:-3000000},
                {week:'W48',cashIn:39000000,cashOut:42000000,billing:44000000,balance:-3000000},
                {week:'W49',cashIn:40000000,cashOut:43000000,billing:45000000,balance:-3000000},
                {week:'W50',cashIn:40500000,cashOut:43500000,billing:45500000,balance:-3000000},
                {week:'W51',cashIn:41000000,cashOut:44000000,billing:46000000,balance:-3000000},
                {week:'W52',cashIn:42000000,cashOut:45000000,billing:47000000,balance:-3000000}
            ],
            safety:[
                {week:'W47',trir:0,nearMiss:3,observations:2100,safeHours:220000,manpower:470},
                {week:'W48',trir:0,nearMiss:4,observations:2150,safeHours:225000,manpower:475},
                {week:'W49',trir:0,nearMiss:2,observations:2250,safeHours:230000,manpower:480},
                {week:'W50',trir:0,nearMiss:6,observations:2300,safeHours:235000,manpower:485},
                {week:'W51',trir:0,nearMiss:4,observations:2350,safeHours:240000,manpower:488},
                {week:'W52',trir:0,nearMiss:5,observations:2403,safeHours:245000,manpower:492}
            ],
            quality:[
                {week:'W47',ncrOpen:8,ncrClosed:35,punchOpen:15,punchClosed:60,weldRejectRate:1.2,certCompleted:38},
                {week:'W48',ncrOpen:7,ncrClosed:38,punchOpen:14,punchClosed:65,weldRejectRate:1.1,certCompleted:40},
                {week:'W49',ncrOpen:6,ncrClosed:40,punchOpen:13,punchClosed:70,weldRejectRate:1.0,certCompleted:41},
                {week:'W50',ncrOpen:5,ncrClosed:42,punchOpen:12,punchClosed:75,weldRejectRate:1.1,certCompleted:43},
                {week:'W51',ncrOpen:4,ncrClosed:44,punchOpen:11,punchClosed:78,weldRejectRate:1.0,certCompleted:44},
                {week:'W52',ncrOpen:4,ncrClosed:46,punchOpen:10,punchClosed:82,weldRejectRate:1.1,certCompleted:45}
            ],
            tkdn:[
                {week:'W47',plan:40,actual:38.5},
                {week:'W48',plan:40,actual:39.2},
                {week:'W49',plan:40,actual:40.1},
                {week:'W50',plan:40,actual:41.0},
                {week:'W51',plan:40,actual:41.8},
                {week:'W52',plan:40,actual:42.5}
            ]
        },
        uploads:{}
    }]);

    const selectedReport=useMemo(()=>reports.find(r=>r.id===selectedReportId)||reports[0],[reports,selectedReportId]);
    const selectedProject=useMemo(()=>projects.find(p=>p.id===selectedReport?.projectId),[projects,selectedReport]);

    useEffect(()=>{const s=localStorage.getItem('epcDashV17');if(s){try{const d=JSON.parse(s);if(d.projects)setProjects(d.projects);if(d.reports)setReports(d.reports);if(d.selectedReportId)setSelectedReportId(d.selectedReportId);}catch(e){}}},[]);
    useEffect(()=>{localStorage.setItem('epcDashV17',JSON.stringify({projects,reports,selectedReportId}));},[projects,reports,selectedReportId]);

    const showNotif=(msg,type='success')=>{setNotification({msg,type});setTimeout(()=>setNotification(null),3000);};

    // Calculate Schedule Duration in days
    const calculateScheduleDuration=(startDate,finishDate)=>{
        if(!startDate||!finishDate)return 0;
        const start=new Date(startDate);
        const finish=new Date(finishDate);
        const diffTime=Math.abs(finish-start);
        return Math.ceil(diffTime/(1000*60*60*24));
    };

    // Calculate Estimated Completion Date based on SPI
    const calculateEstimatedCompletion=(startDate,finishDate,spi,actualProgress)=>{
        if(!startDate||!finishDate||!spi||spi<=0)return finishDate||'';
        const start=new Date(startDate);
        const finish=new Date(finishDate);
        const totalDuration=Math.ceil((finish-start)/(1000*60*60*24));
        const estimatedDuration=Math.ceil(totalDuration/spi);
        const estimatedDate=new Date(start);
        estimatedDate.setDate(estimatedDate.getDate()+estimatedDuration);
        return estimatedDate.toISOString().split('T')[0];
    };

    // Calculate Delay Days
    const calculateDelayDays=(finishDate,estimatedDate)=>{
        if(!finishDate||!estimatedDate)return 0;
        const finish=new Date(finishDate);
        const estimated=new Date(estimatedDate);
        const diffTime=estimated-finish;
        const delayDays=Math.ceil(diffTime/(1000*60*60*24));
        return delayDays>0?delayDays:0;
    };

    // Calculate LD Delay
    const calculateLDDelay=(delayDays,ldDelayRate)=>{
        return delayDays*(ldDelayRate||0);
    };

    // Calculate LD Performance
    const calculateLDPerformance=(guaranteedPower,actualPower,ldPerformanceRate)=>{
        if(!guaranteedPower||!actualPower||actualPower>=guaranteedPower)return 0;
        const powerShortfall=(guaranteedPower-actualPower)*1000; // Convert MW to kW
        return powerShortfall*(ldPerformanceRate||0);
    };

    // EVM Auto Calculations
    const calculateEVM=(bcws,bcwp,acwp,bac)=>{
        const spi=bcws>0?bcwp/bcws:0;
        const cpi=acwp>0?bcwp/acwp:0;
        const sv=bcwp-bcws;
        const cv=bcwp-acwp;
        const eacTypical=cpi>0?bac/cpi:0;
        const eacAtypical=acwp+(bac-bcwp);
        const eacCombined=(cpi>0&&spi>0)?acwp+(bac-bcwp)/(cpi*spi):0;
        const vac=bac-eacTypical;
        return{spiValue:spi,cpiValue:cpi,sv,cv,eac:eacTypical,eacTypical,eacAtypical,eacCombined,vac};
    };

    // Cash Flow Performance Calculations - UPDATED
    const calculateCashFlowPerformance=(revenue,cashOut,billing,cashIn,weekNo=1)=>{
        // A. Cash Flow Balance = Cash In - Cash Out
        const cashFlowBalance=cashIn-cashOut;
        
        // B. Billing Coverage Ratio = Billing / Revenue (BCWP)
        const billingCoverageRatio=revenue>0?billing/revenue:0;
        
        // C. Cash Collection Ratio = Cash In / Billing
        const cashCollectionRatio=billing>0?cashIn/billing:0;
        
        // D. Cash Adequacy Ratio = Cash In / Cash Out
        const cashAdequacyRatio=cashOut>0?cashIn/cashOut:0;
        
        // E. Cash Burn Rate = Cash Out / Period (weeks)
        const cashBurnRate=weekNo>0?cashOut/weekNo:0;
        
        // F. Earned Cash Ratio (ECR) = Cash In / BCWP
        const earnedCashRatio=revenue>0?cashIn/revenue:0;
        
        // G. Billing Lag = BCWP - Billing
        const billingLag=revenue-billing;
        
        // H. Cash Gap = Cash Out - Cash In
        const cashGap=cashOut-cashIn;
        
        // Calculate Overall Score
        const scores=[];
        // Cash Flow Balance: >=0 is green
        scores.push(cashFlowBalance>=0?1:0);
        // Billing Coverage: >=0.95 is green, >=0.85 yellow
        scores.push(billingCoverageRatio>=0.95?1:billingCoverageRatio>=0.85?0.5:0);
        // Collection Ratio: >=0.9 is green, >=0.8 yellow
        scores.push(cashCollectionRatio>=0.9?1:cashCollectionRatio>=0.8?0.5:0);
        // Cash Adequacy: >=1.0 is green, >=0.9 yellow
        scores.push(cashAdequacyRatio>=1.0?1:cashAdequacyRatio>=0.9?0.5:0);
        
        const overallScore=scores.reduce((a,b)=>a+b,0)/scores.length;
        const overallStatus=overallScore>=0.75?'green':overallScore>=0.5?'yellow':'red';
        
        return{
            revenue,cashOut,billing,cashIn,weekNo,
            cashFlowBalance,billingCoverageRatio,cashCollectionRatio,
            cashAdequacyRatio,cashBurnRate,earnedCashRatio,
            billingLag,cashGap,overallScore,overallStatus
        };
    };

    const handleEVMChange=(field,value)=>{
        const evm={...(formData.evm||{}),[field]:Number(value)};
        const bac=evm.bac||selectedProject?.bac||selectedProject?.contractPrice||0;
        if(evm.bcws!==undefined&&evm.bcwp!==undefined&&evm.acwp!==undefined){
            const calculated=calculateEVM(evm.bcws,evm.bcwp,evm.acwp,bac);
            // Update cash flow revenue from BCWP
            const cf=formData.cashFlow||defaultCashFlow;
            const cfCalc=calculateCashFlowPerformance(evm.bcwp,cf.cashOut||0,cf.billing||0,cf.cashIn||0,cf.weekNo||formData.weekNo||1);
            setFormData({...formData,evm:{...evm,...calculated,bac},cashFlow:cfCalc});
        }else{
            setFormData({...formData,evm:{...evm,bac}});
        }
    };

    const handleCashFlowChange=(field,value)=>{
        const cf={...(formData.cashFlow||defaultCashFlow),[field]:Number(value)};
        const revenue=formData.evm?.bcwp||0;
        const weekNo=formData.weekNo||cf.weekNo||1;
        const calculated=calculateCashFlowPerformance(revenue,cf.cashOut||0,cf.billing||0,cf.cashIn||0,weekNo);
        setFormData({...formData,cashFlow:calculated});
    };

    // Get computed cash flow metrics for display
    const getCashFlowMetrics=(report)=>{
        if(!report?.cashFlow)return null;
        const cf=report.cashFlow;
        const revenue=report.evm?.bcwp||cf.revenue||0;
        return calculateCashFlowPerformance(revenue,cf.cashOut||0,cf.billing||0,cf.cashIn||0,cf.weekNo||report.weekNo||1);
    };

    const saveProject=()=>{if(editingId)setProjects(projects.map(p=>p.id===editingId?{...p,...formData}:p));else setProjects([...projects,{...formData,id:Date.now(),status:'Active'}]);showNotif('Saved!');setShowModal(null);setFormData({});setEditingId(null);};

    const saveReport=()=>{
        const rd={...formData,projectId:formData.projectId||selectedProject?.id,status:formData.status||'Issued',hse:formData.hse||defaultHSE,thisWeekActivities:formData.thisWeekActivities||defaultActivities,nextWeekPlan:formData.nextWeekPlan||defaultActivities,milestonesSchedule:formData.milestonesSchedule||[],milestonesPayment:formData.milestonesPayment||[],cashFlow:formData.cashFlow||defaultCashFlow};
        if(editingId)setReports(reports.map(r=>r.id===editingId?{...r,...rd}:r));
        else{const nr={...rd,id:Date.now(),docNo:formData.docNo||`RPT${String(formData.weekNo||1).padStart(4,'0')}`};setReports([...reports,nr]);setSelectedReportId(nr.id);}
        showNotif('Report saved!');setShowModal(null);setFormData({});setEditingId(null);
    };

    const deleteReport=(id)=>{if(confirm('Delete?')){setReports(reports.filter(r=>r.id!==id));showNotif('Deleted');}};
    const copyReport=(r)=>{const newWeek=r.weekNo+1;const nr={...r,id:Date.now(),weekNo:newWeek,docNo:r.docNo?r.docNo.replace(/\d+$/,String(newWeek).padStart(4,'0')):`RPT${String(newWeek).padStart(4,'0')}`,status:'Draft'};setReports([...reports,nr]);showNotif('Duplicated');};
    const updateReportUpload=(reportId,field,file)=>{if(file){const reader=new FileReader();reader.onload=(e)=>{setReports(reports.map(r=>r.id===reportId?{...r,uploads:{...r.uploads,[field]:{name:file.name,data:e.target.result}}}:r));showNotif('Uploaded!');};reader.readAsDataURL(file);}};
    const handleFileUpload=(field,e)=>{const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=(ev)=>{setFormData(prev=>({...prev,uploads:{...(prev.uploads||{}),[field]:{name:file.name,data:ev.target.result}}}));};reader.readAsDataURL(file);}};
    const exportData=()=>{const blob=new Blob([JSON.stringify({projects,reports},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`epc-data-${new Date().toISOString().split('T')[0]}.json`;a.click();showNotif('Exported!');};
    const importData=(e)=>{const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=(ev)=>{try{const d=JSON.parse(ev.target.result);if(d.projects)setProjects(d.projects);if(d.reports)setReports(d.reports);showNotif('Imported!');}catch{showNotif('Invalid!','error');}};reader.readAsText(file);}};

    const calculateRisks=()=>{
        if(!selectedReport)return[];
        const risks=[],{evm,hse,quality,overallProgress,tkdn}=selectedReport;
        const cfMetrics=getCashFlowMetrics(selectedReport);
        if(evm?.spiValue<0.95)risks.push({category:'Schedule',level:'High',description:`SPI ${evm.spiValue.toFixed(3)}`,recommendation:'Recovery schedule'});
        else if(evm?.spiValue<1.0)risks.push({category:'Schedule',level:'Medium',description:`SPI ${evm.spiValue.toFixed(3)}`,recommendation:'Monitor'});
        if(evm?.cpiValue<0.95)risks.push({category:'Cost',level:'High',description:`CPI ${evm.cpiValue.toFixed(2)}`,recommendation:'Cost control'});
        else if(evm?.cpiValue<1.0)risks.push({category:'Cost',level:'Medium',description:`CPI ${evm.cpiValue.toFixed(2)}`,recommendation:'Monitor'});
        if(cfMetrics?.overallStatus==='red')risks.push({category:'Cash Flow',level:'High',description:'Critical cash position',recommendation:'Immediate action needed'});
        else if(cfMetrics?.overallStatus==='yellow')risks.push({category:'Cash Flow',level:'Medium',description:'Cash flow at risk',recommendation:'Review billing & collection'});
        if(hse?.lagging?.lti>0)risks.push({category:'Safety',level:'High',description:`LTI: ${hse.lagging.lti}`,recommendation:'Safety stand-down'});
        // TKDN Risk Assessment
        if(tkdn?.plan>0 && tkdn?.actual>0){
            const tkdnRatio=tkdn.actual/tkdn.plan;
            if(tkdnRatio<0.9)risks.push({category:'TKDN',level:'High',description:`TKDN ${tkdn.actual.toFixed(1)}% vs Target ${tkdn.plan}% (Gap: ${(tkdn.actual-tkdn.plan).toFixed(1)}%)`,recommendation:'Increase local content sourcing, review supplier strategy'});
            else if(tkdnRatio<1.0)risks.push({category:'TKDN',level:'Medium',description:`TKDN ${tkdn.actual.toFixed(1)}% vs Target ${tkdn.plan}% (Gap: ${(tkdn.actual-tkdn.plan).toFixed(1)}%)`,recommendation:'Monitor local content progress, prepare mitigation'});
        }
        return risks.length>0?risks:[{category:'Overall',level:'Low',description:'Performance OK',recommendation:'Continue monitoring'}];
    };

    const updateActivity=(type,cat,idx,val)=>{setFormData(prev=>{const acts={...(prev[type]||defaultActivities)};const items=[...(acts[cat]||[''])];items[idx]=val;return{...prev,[type]:{...acts,[cat]:items}};});};
    const addActivityItem=(type,cat)=>{setFormData(prev=>{const acts={...(prev[type]||defaultActivities)};const items=[...(acts[cat]||['']),''];return{...prev,[type]:{...acts,[cat]:items}};});};
    const removeActivityItem=(type,cat,idx)=>{setFormData(prev=>{const acts={...(prev[type]||defaultActivities)};const items=[...(acts[cat]||[''])];items.splice(idx,1);if(items.length===0)items.push('');return{...prev,[type]:{...acts,[cat]:items}};});};
    const addMilestone=(type)=>{const field=type==='schedule'?'milestonesSchedule':'milestonesPayment';setFormData(prev=>{const ms=[...(prev[field]||[])];ms.push({no:ms.length+1,description:'',planDate:'',actualForecastDate:'',status:'On Track'});return{...prev,[field]:ms};});};
    const updateMilestone=(type,idx,key,val)=>{const field=type==='schedule'?'milestonesSchedule':'milestonesPayment';setFormData(prev=>{const ms=[...(prev[field]||[])];ms[idx]={...ms[idx],[key]:val};return{...prev,[field]:ms};});};
    const removeMilestone=(type,idx)=>{const field=type==='schedule'?'milestonesSchedule':'milestonesPayment';setFormData(prev=>{const ms=[...(prev[field]||[])];ms.splice(idx,1);return{...prev,[field]:ms.map((m,i)=>({...m,no:i+1}))};});};

    // Dashboard Render with Cash Flow Performance
    const renderDashboard=()=>{
        if(!selectedReport)return<div style={{padding:40,textAlign:'center'}}>No report</div>;
        const{evm,epcc,overallProgress,hse,quality,sCurveData,uploads,milestonesSchedule,milestonesPayment,actualForecastPower}=selectedReport;
        const hseSafe=hse||defaultHSE;
        const cfMetrics=getCashFlowMetrics(selectedReport);
        const cf=cfMetrics||defaultCashFlow;
        
        // Calculate schedule and LD
        const scheduleDuration=calculateScheduleDuration(selectedProject?.startDate,selectedProject?.finishDate);
        const estimatedCompletion=calculateEstimatedCompletion(selectedProject?.startDate,selectedProject?.finishDate,evm?.spiValue,overallProgress?.actual);
        const delayDays=calculateDelayDays(selectedProject?.finishDate,estimatedCompletion);
        const ldDelay=calculateLDDelay(delayDays,selectedProject?.ldDelay);
        const ldPerformance=calculateLDPerformance(selectedProject?.guaranteedPower,actualForecastPower,selectedProject?.ldPerformance);
        const totalLD=ldDelay+ldPerformance;
        
        return(
            <div>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
                    <div><h1 style={{fontSize:24,fontWeight:800}}>{selectedProject?.name}</h1><p style={{color:'#64748b',fontSize:14}}>Week {selectedReport.weekNo} | {selectedReport.periodStart} - {selectedReport.periodEnd}</p></div>
                    <div style={{display:'flex',gap:12,alignItems:'center'}}>
                        <select className="select" style={{width:200}} value={selectedReportId||''} onChange={e=>setSelectedReportId(Number(e.target.value))}>{reports.map(r=><option key={r.id} value={r.id}>Week {r.weekNo} - {r.docNo}</option>)}</select>
                    </div>
                </div>
                
                {/* Project Information Card */}
                <div className="card" style={{padding:20,marginBottom:20,background:'linear-gradient(135deg,#f0fdfa,#ecfeff)'}}>
                    <h3 style={{fontSize:16,fontWeight:700,marginBottom:16,color:'#0f766e'}}>üìã Project Information</h3>
                    <div className="grid-4" style={{gap:12,marginBottom:12}}>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Owner</p><p style={{fontWeight:600,fontSize:12}}>{selectedProject?.owner||'-'}</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Contractor</p><p style={{fontWeight:600,fontSize:12}}>{selectedProject?.contractor||'-'}</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Contract Type</p><p style={{fontWeight:600,fontSize:12}}>{selectedProject?.contractType||'-'}</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Term of Payment</p><p style={{fontWeight:600,fontSize:12}}>{selectedProject?.termOfPayment||'-'}</p></div>
                    </div>
                    <div className="grid-5" style={{gap:12,marginBottom:12}}>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Contract Price</p><p style={{fontWeight:700,fontSize:14,color:'#0f766e'}}>${((selectedProject?.contractPrice||0)/1e6).toFixed(2)}M</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Start Date</p><p style={{fontWeight:600,fontSize:12}}>{selectedProject?.startDate||'-'}</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Finish Date</p><p style={{fontWeight:600,fontSize:12}}>{selectedProject?.finishDate||'-'}</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Duration</p><p style={{fontWeight:600,fontSize:12}}>{scheduleDuration} days</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Guaranteed Power</p><p style={{fontWeight:700,fontSize:14,color:'#3b82f6'}}>{selectedProject?.guaranteedPower||0} MW</p></div>
                    </div>
                    <div className="grid-3" style={{gap:12}}>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>LD Delay Rate</p><p style={{fontWeight:600,fontSize:12}}>${(selectedProject?.ldDelay||0).toLocaleString()}/day</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>LD Performance Rate</p><p style={{fontWeight:600,fontSize:12}}>${(selectedProject?.ldPerformance||0).toLocaleString()}/kW</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Scope by Owner</p><p style={{fontWeight:600,fontSize:11}}>{selectedProject?.scopeByOwner||'-'}</p></div>
                    </div>
                </div>
                
                {/* KPI Cards */}
                <div className="grid-6" style={{marginBottom:20}}>
                    <div className="stat-card" style={{borderLeft:'4px solid #0d9488'}}><p style={{color:'#64748b',fontSize:11}}>Overall Progress</p><p style={{fontSize:24,fontWeight:800}}>{overallProgress?.actual?.toFixed(2)||0}%</p><div style={{display:'flex',alignItems:'center',gap:4}}>{(overallProgress?.variance||0)>=0?<Icons.ArrowUp/>:<Icons.ArrowDown/>}<span style={{color:(overallProgress?.variance||0)>=0?'#10b981':'#ef4444',fontSize:12}}>{(overallProgress?.variance||0)>=0?'+':''}{overallProgress?.variance?.toFixed(2)||0}%</span></div></div>
                    <div className="stat-card" style={{borderLeft:'4px solid #3b82f6'}}><p style={{color:'#64748b',fontSize:11}}>SPI</p><p style={{fontSize:24,fontWeight:800,color:(evm?.spiValue||1)>=1?'#10b981':'#ef4444'}}>{evm?.spiValue?.toFixed(3)||'1.000'}</p><p style={{fontSize:10,color:'#64748b'}}>{(evm?.spiValue||1)>=1?'On Schedule':'Behind'}</p></div>
                    <div className="stat-card" style={{borderLeft:'4px solid #f59e0b'}}><p style={{color:'#64748b',fontSize:11}}>CPI</p><p style={{fontSize:24,fontWeight:800,color:(evm?.cpiValue||1)>=1?'#10b981':'#f59e0b'}}>{evm?.cpiValue?.toFixed(2)||'1.00'}</p><p style={{fontSize:10,color:'#64748b'}}>{(evm?.cpiValue||1)>=1?'Under Budget':'Over Budget'}</p></div>
                    <div className="stat-card" style={{borderLeft:'4px solid #8b5cf6'}}><p style={{color:'#64748b',fontSize:11}}>EAC (Typical)</p><p style={{fontSize:24,fontWeight:800}}>${((evm?.eac||0)/1e6).toFixed(1)}M</p><p style={{fontSize:10,color:(evm?.vac||0)>=0?'#10b981':'#ef4444'}}>VAC: ${((evm?.vac||0)/1e6).toFixed(2)}M</p></div>
                    <div className="stat-card" style={{borderLeft:'4px solid #10b981'}}><p style={{color:'#64748b',fontSize:11}}>Safe Hours</p><p style={{fontSize:24,fontWeight:800}}>{((hseSafe.safeHours||0)/1000).toFixed(0)}K</p><p style={{fontSize:10,color:'#10b981'}}>LTI: {hseSafe.lagging?.lti||0}</p></div>
                    <div className="stat-card" style={{borderLeft:`4px solid ${cf.overallStatus==='green'?'#22c55e':cf.overallStatus==='yellow'?'#f59e0b':'#ef4444'}`}}><p style={{color:'#64748b',fontSize:11}}>Cash Flow Status</p><p style={{fontSize:20,fontWeight:800}}>{cf.overallStatus==='green'?'üü¢ Healthy':cf.overallStatus==='yellow'?'üü° At Risk':'üî¥ Critical'}</p><p style={{fontSize:10,color:'#64748b'}}>Score: {(cf.overallScore*100).toFixed(0)}%</p></div>
                </div>
                
                {/* Schedule & LD Estimation */}
                <div className="card" style={{padding:20,marginBottom:20,background:totalLD>0?'linear-gradient(135deg,#fef2f2,#fff1f2)':'linear-gradient(135deg,#f0fdf4,#ecfdf5)'}}>
                    <h3 style={{fontSize:16,fontWeight:700,marginBottom:16,color:totalLD>0?'#dc2626':'#16a34a'}}>‚è±Ô∏è Schedule & LD Estimation</h3>
                    <div className="grid-4" style={{gap:12}}>
                        <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Planned Finish</p><p style={{fontWeight:700,fontSize:13}}>{selectedProject?.finishDate||'-'}</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Estimated Completion</p><p style={{fontWeight:700,fontSize:13,color:delayDays>0?'#dc2626':'#16a34a'}}>{estimatedCompletion||'-'}</p></div>
                        <div style={{background:delayDays>0?'#fee2e2':'#dcfce7',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Delay Days</p><p style={{fontWeight:800,fontSize:18,color:delayDays>0?'#dc2626':'#16a34a'}}>{delayDays} days</p></div>
                        <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Actual/FC Power</p><p style={{fontWeight:700,fontSize:14,color:(actualForecastPower||0)<(selectedProject?.guaranteedPower||0)?'#dc2626':'#16a34a'}}>{actualForecastPower||0} MW</p></div>
                    </div>
                    <div className="grid-3" style={{gap:12,marginTop:12}}>
                        <div style={{background:ldDelay>0?'#fee2e2':'#dcfce7',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>LD Delay Estimation</p><p style={{fontWeight:800,fontSize:16,color:ldDelay>0?'#dc2626':'#16a34a'}}>${ldDelay.toLocaleString()}</p><p style={{fontSize:9,color:'#64748b'}}>{delayDays} days √ó ${(selectedProject?.ldDelay||0).toLocaleString()}/day</p></div>
                        <div style={{background:ldPerformance>0?'#fee2e2':'#dcfce7',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>LD Performance Estimation</p><p style={{fontWeight:800,fontSize:16,color:ldPerformance>0?'#dc2626':'#16a34a'}}>${ldPerformance.toLocaleString()}</p><p style={{fontSize:9,color:'#64748b'}}>{((selectedProject?.guaranteedPower||0)-(actualForecastPower||0)).toFixed(1)} MW shortfall</p></div>
                        <div style={{background:totalLD>0?'#dc2626':'#16a34a',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'white',opacity:0.9}}>Total LD Estimation</p><p style={{fontWeight:800,fontSize:20,color:'white'}}>${totalLD.toLocaleString()}</p></div>
                    </div>
                </div>
                
                {/* S-Curve & EVM */}
                <div className="grid-2" style={{marginBottom:20}}>
                    <div className="card" style={{padding:20}}><h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>üìà S-Curve Progress</h3>{uploads?.sCurveGeneral?<div style={{cursor:'pointer'}} onClick={()=>setImageViewer({src:uploads.sCurveGeneral.data,title:'S-Curve'})}><img src={uploads.sCurveGeneral.data} alt="S-Curve" style={{width:'100%',height:180,objectFit:'contain',borderRadius:8,background:'#f8fafc'}}/></div>:<AreaChartSVG data={sCurveData||[]} height={180}/>}</div>
                    <div className="card" style={{padding:20}}>
                        <h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>üí∞ Cost Performance (EVM)</h3>
                        <div className="grid-3" style={{gap:10,marginBottom:12}}>
                            <div style={{textAlign:'center',padding:10,background:'#f8fafc',borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>BCWS</p><p style={{fontSize:14,fontWeight:700}}>${((evm?.bcws||0)/1e6).toFixed(2)}M</p></div>
                            <div style={{textAlign:'center',padding:10,background:'#f0fdf4',borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>BCWP</p><p style={{fontSize:14,fontWeight:700,color:'#16a34a'}}>${((evm?.bcwp||0)/1e6).toFixed(2)}M</p></div>
                            <div style={{textAlign:'center',padding:10,background:'#fef3c7',borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>ACWP</p><p style={{fontSize:14,fontWeight:700,color:'#d97706'}}>${((evm?.acwp||0)/1e6).toFixed(2)}M</p></div>
                        </div>
                        <div style={{display:'flex',justifyContent:'space-around'}}><GaugeChart value={evm?.spiValue||1} label="SPI" color={(evm?.spiValue||1)>=1?'#10b981':'#ef4444'}/><GaugeChart value={evm?.cpiValue||1} label="CPI" color={(evm?.cpiValue||1)>=1?'#10b981':'#f59e0b'}/></div>
                        <div className="formula-box" style={{marginTop:12}}>
                            <p style={{fontSize:11,fontWeight:600,color:'#92400e',marginBottom:8}}>üìä EAC Formulas</p>
                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,fontSize:10}}>
                                <div style={{background:'#fef3c7',padding:6,borderRadius:4,display:'flex',justifyContent:'space-between'}}><span>Typical (BAC/CPI)</span><strong>${((evm?.eacTypical||0)/1e6).toFixed(2)}M</strong></div>
                                <div style={{background:'#dbeafe',padding:6,borderRadius:4,display:'flex',justifyContent:'space-between'}}><span>Atypical</span><strong>${((evm?.eacAtypical||0)/1e6).toFixed(2)}M</strong></div>
                                <div style={{background:'#f3e8ff',padding:6,borderRadius:4,display:'flex',justifyContent:'space-between'}}><span>Combined</span><strong>${((evm?.eacCombined||0)/1e6).toFixed(2)}M</strong></div>
                                <div style={{background:(evm?.vac||0)>=0?'#dcfce7':'#fee2e2',padding:6,borderRadius:4,display:'flex',justifyContent:'space-between'}}><span>VAC</span><strong style={{color:(evm?.vac||0)>=0?'#16a34a':'#dc2626'}}>${((evm?.vac||0)/1e6).toFixed(2)}M</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {/* Cash Flow Section - UPDATED */}
                <div className="card" style={{padding:20,marginBottom:20}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
                        <h3 style={{fontSize:16,fontWeight:700}}>üíµ Cash Flow Performance Dashboard</h3>
                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                            <span style={{fontSize:12,color:'#64748b'}}>Overall Status:</span>
                            <span style={{fontSize:14,fontWeight:700}}>{cf.overallStatus==='green'?'üü¢ Healthy':cf.overallStatus==='yellow'?'üü° At Risk':'üî¥ Critical'}</span>
                            <span className={`badge ${cf.overallStatus==='green'?'badge-success':cf.overallStatus==='yellow'?'badge-warning':'badge-danger'}`}>{(cf.overallScore*100).toFixed(0)}%</span>
                        </div>
                    </div>
                    
                    <div className="grid-3" style={{gap:16,marginBottom:16}}>
                        {/* Cash Flow Chart */}
                        <div style={{background:'#f8fafc',padding:12,borderRadius:8}}>
                            <h4 style={{fontSize:12,fontWeight:600,marginBottom:8}}>Cash Flow Chart</h4>
                            {uploads?.cashFlow?<img src={uploads.cashFlow.data} style={{width:'100%',height:100,objectFit:'contain',borderRadius:6}}/>:<CashFlowChart cashFlow={cf}/>}
                        </div>
                        
                        {/* Primary Metrics */}
                        <div style={{background:'#f8fafc',padding:12,borderRadius:8}}>
                            <h4 style={{fontSize:12,fontWeight:600,marginBottom:8}}>Primary Input</h4>
                            <div style={{display:'grid',gap:4}}>
                                <div style={{display:'flex',justifyContent:'space-between',fontSize:11}}><span>Revenue (BCWP)</span><strong style={{color:'#16a34a'}}>${((cf.revenue||0)/1e6).toFixed(2)}M</strong></div>
                                <div style={{display:'flex',justifyContent:'space-between',fontSize:11}}><span>Cash Out</span><strong style={{color:'#dc2626'}}>${((cf.cashOut||0)/1e6).toFixed(2)}M</strong></div>
                                <div style={{display:'flex',justifyContent:'space-between',fontSize:11}}><span>Billing</span><strong style={{color:'#2563eb'}}>${((cf.billing||0)/1e6).toFixed(2)}M</strong></div>
                                <div style={{display:'flex',justifyContent:'space-between',fontSize:11}}><span>Cash In</span><strong style={{color:'#7c3aed'}}>${((cf.cashIn||0)/1e6).toFixed(2)}M</strong></div>
                            </div>
                        </div>
                        
                        {/* QR Codes */}
                        <div style={{background:'#f8fafc',padding:12,borderRadius:8}}>
                            <h4 style={{fontSize:12,fontWeight:600,marginBottom:8}}>üì± QR Codes</h4>
                            <div style={{display:'flex',justifyContent:'space-around'}}>
                                {[{key:'qrPhotos',label:'Photos',color:'#3b82f6'},{key:'qrVideos',label:'Videos',color:'#8b5cf6'},{key:'qrReport',label:'Report',color:'#0d9488'}].map(qr=>(
                                    <div key={qr.key} style={{textAlign:'center'}}>
                                        {uploads?.[qr.key]?<img src={uploads[qr.key].data} style={{width:50,height:50,objectFit:'cover',borderRadius:4,border:`2px solid ${qr.color}`}}/>:<div style={{width:50,height:50,background:'#e2e8f0',borderRadius:4,display:'flex',alignItems:'center',justifyContent:'center'}}>üì∑</div>}
                                        <p style={{fontSize:8,color:qr.color,fontWeight:600,marginTop:2}}>{qr.label}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    {/* Cash Flow KPIs - NEW */}
                    <div className="grid-4" style={{gap:12,marginBottom:16}}>
                        <CashFlowIndicator label="A. Cash Flow Balance" value={(cf.cashFlowBalance||0)/1e6} unit="M" threshold={{green:0,yellow:-1}} formula="Cash In - Cash Out"/>
                        <CashFlowIndicator label="B. Billing Coverage" value={cf.billingCoverageRatio||0} threshold={{green:0.95,yellow:0.85}} formula="Billing / Revenue"/>
                        <CashFlowIndicator label="C. Collection Ratio" value={cf.cashCollectionRatio||0} threshold={{green:0.9,yellow:0.8}} formula="Cash In / Billing"/>
                        <CashFlowIndicator label="D. Cash Adequacy" value={cf.cashAdequacyRatio||0} threshold={{green:1.0,yellow:0.9}} formula="Cash In / Cash Out"/>
                    </div>
                    
                    {/* EVM Integration Metrics */}
                    <div className="grid-4" style={{gap:12}}>
                        <CashFlowIndicator label="E. Cash Burn Rate" value={(cf.cashBurnRate||0)/1e6} unit="M/wk" formula="Cash Out / Week"/>
                        <CashFlowIndicator label="F. Earned Cash Ratio" value={cf.earnedCashRatio||0} threshold={{green:1.0,yellow:0.85}} formula="Cash In / BCWP"/>
                        <CashFlowIndicator label="G. Billing Lag" value={(cf.billingLag||0)/1e6} unit="M" threshold={{green:0,yellow:2}} inverse={true} formula="BCWP - Billing"/>
                        <CashFlowIndicator label="H. Cash Gap" value={(cf.cashGap||0)/1e6} unit="M" threshold={{green:0,yellow:2}} inverse={true} formula="Cash Out - Cash In"/>
                    </div>
                </div>
                
                {/* TKDN Section - NEW */}
                {(()=>{
                    const tkdn=selectedReport?.tkdn||{plan:0,actual:0};
                    const trend=selectedReport?.trendData?.tkdn||[];
                    const hasData=tkdn.plan>0||tkdn.actual>0||trend.length>0;
                    if(!hasData)return null;
                    return(
                        <div className="card" style={{padding:20,marginBottom:20,background:'linear-gradient(135deg,#ecfeff,#f0fdfa)'}}>
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
                                <h3 style={{fontSize:16,fontWeight:700,color:'#0891b2'}}>üè≠ TKDN Performance (Tingkat Komponen Dalam Negeri)</h3>
                                <div style={{display:'flex',alignItems:'center',gap:8}}>
                                    <span style={{fontSize:12,color:'#64748b'}}>Status:</span>
                                    {(()=>{
                                        const status=tkdn.actual>=tkdn.plan?'green':tkdn.actual>=tkdn.plan*0.9?'yellow':'red';
                                        return(
                                            <span className={`badge ${status==='green'?'badge-success':status==='yellow'?'badge-warning':'badge-danger'}`}>
                                                {status==='green'?'‚úì Memenuhi Target':status==='yellow'?'‚ö† Perlu Perhatian':'‚úó Tidak Memenuhi'}
                                            </span>
                                        );
                                    })()}
                                </div>
                            </div>
                            
                            <div className="grid-2" style={{gap:20}}>
                                {/* TKDN Gauge */}
                                <TKDNGauge plan={tkdn.plan||0} actual={tkdn.actual||0}/>
                                
                                {/* TKDN Trend */}
                                {trend.length>0?
                                    <TKDNTrendChart data={trend}/>
                                    :<div style={{background:'white',padding:20,borderRadius:12,textAlign:'center',display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center'}}>
                                        <p style={{fontSize:12,color:'#94a3b8',marginBottom:8}}>No TKDN trend data available</p>
                                        <p style={{fontSize:11,color:'#64748b'}}>Trend data akan muncul setelah beberapa minggu pelaporan</p>
                                    </div>
                                }
                            </div>
                            
                            {/* TKDN Info Box */}
                            <div style={{marginTop:16,padding:12,background:'white',borderRadius:8,border:'1px solid #0891b2'}}>
                                <div className="grid-4" style={{gap:12}}>
                                    <div style={{textAlign:'center'}}>
                                        <p style={{fontSize:10,color:'#64748b'}}>üìã Target Minimum</p>
                                        <p style={{fontSize:22,fontWeight:800,color:'#3b82f6'}}>{tkdn.plan||0}%</p>
                                    </div>
                                    <div style={{textAlign:'center'}}>
                                        <p style={{fontSize:10,color:'#64748b'}}>üìä Realisasi Aktual</p>
                                        <p style={{fontSize:22,fontWeight:800,color:'#0891b2'}}>{(tkdn.actual||0).toFixed(1)}%</p>
                                    </div>
                                    <div style={{textAlign:'center'}}>
                                        <p style={{fontSize:10,color:'#64748b'}}>üìà Variance</p>
                                        <p style={{fontSize:22,fontWeight:800,color:(tkdn.actual-tkdn.plan)>=0?'#22c55e':'#ef4444'}}>
                                            {(tkdn.actual-tkdn.plan)>=0?'+':''}{(tkdn.actual-tkdn.plan).toFixed(1)}%
                                        </p>
                                    </div>
                                    <div style={{textAlign:'center'}}>
                                        <p style={{fontSize:10,color:'#64748b'}}>üìâ Achievement Rate</p>
                                        <p style={{fontSize:22,fontWeight:800,color:tkdn.plan>0?(tkdn.actual/tkdn.plan*100>=100?'#22c55e':'#f59e0b'):'#64748b'}}>
                                            {tkdn.plan>0?(tkdn.actual/tkdn.plan*100).toFixed(1):0}%
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                })()}
                
                {/* Safety & Quality Summary */}
                <div className="grid-2" style={{marginBottom:20}}>
                    <div className="card" style={{padding:20}}><h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>ü¶∫ Safety Pyramid</h3><SafetyPyramid hse={hseSafe}/><div style={{display:'flex',justifyContent:'space-around',marginTop:16,padding:12,background:'#f8fafc',borderRadius:8}}><div style={{textAlign:'center'}}><p style={{fontSize:18,fontWeight:800,color:'#0f766e'}}>{hseSafe.manpower?.office||0}</p><p style={{fontSize:10,color:'#64748b'}}>Office</p></div><div style={{textAlign:'center'}}><p style={{fontSize:18,fontWeight:800,color:'#3b82f6'}}>{hseSafe.manpower?.siteSubcontractor||0}</p><p style={{fontSize:10,color:'#64748b'}}>Site</p></div><div style={{textAlign:'center'}}><p style={{fontSize:18,fontWeight:800,color:'#0f172a'}}>{hseSafe.manpower?.total||0}</p><p style={{fontSize:10,color:'#64748b'}}>Total</p></div></div></div>
                    <div className="card" style={{padding:20}}><h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>üîç Quality Summary</h3>
                        {(()=>{
                            const q=quality||{};
                            const ho=q.headOffice||{};
                            const so=q.siteOffice||{};
                            const disciplines=['process','mechanical','piping','electrical','instrument','civil'];
                            
                            // Calculate totals
                            let hoAfiTotal=0,hoAfiPass=0,hoNcrOpen=0,hoNcrClosed=0,hoPunchOpen=0,hoPunchClosed=0;
                            let soAfiTotal=0,soAfiPass=0,soNcrOpen=0,soNcrClosed=0,soPunchOpen=0,soPunchClosed=0;
                            disciplines.forEach(d=>{
                                const hoAfi=ho.afi?.[d]||{};hoAfiTotal+=(hoAfi.fail||0)+(hoAfi.ongoing||0)+(hoAfi.pass||0);hoAfiPass+=(hoAfi.pass||0);
                                const soAfi=so.afi?.[d]||{};soAfiTotal+=(soAfi.fail||0)+(soAfi.ongoing||0)+(soAfi.pass||0);soAfiPass+=(soAfi.pass||0);
                                ['ownerToContractor','contractorToVendor'].forEach(src=>{
                                    const hoNcr=ho.ncr?.[src]?.[d]||{};hoNcrOpen+=(hoNcr.open||0);hoNcrClosed+=(hoNcr.closed||0);
                                    const soNcr=so.ncr?.[src]?.[d]||{};soNcrOpen+=(soNcr.open||0);soNcrClosed+=(soNcr.closed||0);
                                    const hoPl=ho.punchList?.[src]?.[d]||{};hoPunchOpen+=(hoPl.open||0);hoPunchClosed+=(hoPl.closed||0);
                                    const soPl=so.punchList?.[src]?.[d]||{};soPunchOpen+=(soPl.open||0);soPunchClosed+=(soPl.closed||0);
                                });
                            });
                            const welding=so.welding||{};
                            const ndtTotal=(welding.ndtAccepted||0)+(welding.ndtRejected||0);
                            const rejRate=ndtTotal>0?((welding.ndtRejected||0)/ndtTotal)*100:0;
                            const weldStatus=rejRate<=(welding.rejectionRatePlan||2)?'Pass':rejRate<=(welding.rejectionRatePlan||2)*1.5?'Warning':'Fail';
                            
                            return(<div>
                                <div className="grid-2" style={{gap:10,marginBottom:12}}>
                                    <div style={{background:'#f0fdfa',padding:10,borderRadius:8}}>
                                        <p style={{fontSize:10,fontWeight:600,color:'#0f766e',marginBottom:6}}>üè¢ Head Office</p>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:6,fontSize:10}}>
                                            <div><span style={{color:'#64748b'}}>AFI Pass:</span> <strong>{hoAfiPass}/{hoAfiTotal}</strong></div>
                                            <div><span style={{color:'#64748b'}}>NCR Open:</span> <strong style={{color:hoNcrOpen>0?'#dc2626':'#16a34a'}}>{hoNcrOpen}</strong></div>
                                            <div><span style={{color:'#64748b'}}>Punch Open:</span> <strong style={{color:hoPunchOpen>0?'#f59e0b':'#16a34a'}}>{hoPunchOpen}</strong></div>
                                        </div>
                                    </div>
                                    <div style={{background:'#faf5ff',padding:10,borderRadius:8}}>
                                        <p style={{fontSize:10,fontWeight:600,color:'#7c3aed',marginBottom:6}}>üèóÔ∏è Site Office</p>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:6,fontSize:10}}>
                                            <div><span style={{color:'#64748b'}}>AFI Pass:</span> <strong>{soAfiPass}/{soAfiTotal}</strong></div>
                                            <div><span style={{color:'#64748b'}}>NCR Open:</span> <strong style={{color:soNcrOpen>0?'#dc2626':'#16a34a'}}>{soNcrOpen}</strong></div>
                                            <div><span style={{color:'#64748b'}}>Punch Open:</span> <strong style={{color:soPunchOpen>0?'#f59e0b':'#16a34a'}}>{soPunchOpen}</strong></div>
                                        </div>
                                    </div>
                                </div>
                                <div style={{background:weldStatus==='Pass'?'#dcfce7':weldStatus==='Warning'?'#fef3c7':'#fee2e2',padding:10,borderRadius:8,textAlign:'center'}}>
                                    <p style={{fontSize:10,color:'#64748b'}}>Welding Performance</p>
                                    <p style={{fontSize:16,fontWeight:800,color:weldStatus==='Pass'?'#16a34a':weldStatus==='Warning'?'#d97706':'#dc2626'}}>{weldStatus==='Pass'?'‚úÖ':weldStatus==='Warning'?'‚ö†Ô∏è':'‚ùå'} {rejRate.toFixed(2)}% reject</p>
                                    <p style={{fontSize:9,color:'#64748b'}}>Target: ‚â§{welding.rejectionRatePlan||2}% | NDT: {welding.ndtAccepted||0} acc / {welding.ndtRejected||0} rej</p>
                                </div>
                            </div>);
                        })()}
                    </div>
                </div>
                
                {/* Quality Performance Dashboard with Charts */}
                <div className="card" style={{padding:20,marginBottom:20}}>
                    <h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>üîç Quality Performance Dashboard</h3>
                    {(()=>{
                        const q=quality||{};
                        const ho=q.headOffice||{};
                        const so=q.siteOffice||{};
                        const disciplines=['process','mechanical','piping','electrical','instrument','civil'];
                        
                        // Prepare AFI data for charts
                        const hoAfiData=disciplines.map(d=>ho.afi?.[d]||{fail:0,ongoing:0,pass:0});
                        const soAfiData=disciplines.map(d=>so.afi?.[d]||{fail:0,ongoing:0,pass:0});
                        
                        // Prepare NCR data for charts
                        const hoNcrData=disciplines.map(d=>{
                            const o2c=ho.ncr?.ownerToContractor?.[d]||{};
                            const c2v=ho.ncr?.contractorToVendor?.[d]||{};
                            return{open:(o2c.open||0)+(c2v.open||0),closed:(o2c.closed||0)+(c2v.closed||0)};
                        });
                        const soNcrData=disciplines.map(d=>{
                            const o2c=so.ncr?.ownerToContractor?.[d]||{};
                            const c2v=so.ncr?.contractorToVendor?.[d]||{};
                            return{open:(o2c.open||0)+(c2v.open||0),closed:(o2c.closed||0)+(c2v.closed||0)};
                        });
                        
                        // Prepare Punch data for charts
                        const hoPunchData=disciplines.map(d=>{
                            const o2c=ho.punchList?.ownerToContractor?.[d]||{};
                            const c2v=ho.punchList?.contractorToVendor?.[d]||{};
                            return{open:(o2c.open||0)+(c2v.open||0),closed:(o2c.closed||0)+(c2v.closed||0)};
                        });
                        const soPunchData=disciplines.map(d=>{
                            const o2c=so.punchList?.ownerToContractor?.[d]||{};
                            const c2v=so.punchList?.contractorToVendor?.[d]||{};
                            return{open:(o2c.open||0)+(c2v.open||0),closed:(o2c.closed||0)+(c2v.closed||0)};
                        });
                        
                        // Calculate totals for donut charts
                        const hoNcrTotal=hoNcrData.reduce((a,c)=>({open:a.open+c.open,closed:a.closed+c.closed}),{open:0,closed:0});
                        const soNcrTotal=soNcrData.reduce((a,c)=>({open:a.open+c.open,closed:a.closed+c.closed}),{open:0,closed:0});
                        const hoPunchTotal=hoPunchData.reduce((a,c)=>({open:a.open+c.open,closed:a.closed+c.closed}),{open:0,closed:0});
                        const soPunchTotal=soPunchData.reduce((a,c)=>({open:a.open+c.open,closed:a.closed+c.closed}),{open:0,closed:0});
                        
                        const welding=so.welding||{};
                        
                        return(<div>
                            {/* AFI Charts Row */}
                            <div className="grid-2" style={{gap:16,marginBottom:16}}>
                                <QualityAFIChart data={hoAfiData} title="üè¢ Head Office - AFI Status" color="#0f766e"/>
                                <QualityAFIChart data={soAfiData} title="üèóÔ∏è Site Office - AFI Status" color="#7c3aed"/>
                            </div>
                            
                            {/* NCR & Punch Charts Row */}
                            <div className="grid-2" style={{gap:16,marginBottom:16}}>
                                <QualityNCRPunchChart ncrData={hoNcrData} punchData={hoPunchData} title="üè¢ Head Office - NCR & Punch List"/>
                                <QualityNCRPunchChart ncrData={soNcrData} punchData={soPunchData} title="üèóÔ∏è Site Office - NCR & Punch List"/>
                            </div>
                            
                            {/* Summary Donuts & Welding Gauge */}
                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr 1.5fr',gap:16,marginBottom:16}}>
                                <QualityDonutChart open={hoNcrTotal.open} closed={hoNcrTotal.closed} title="HO NCR"/>
                                <QualityDonutChart open={hoPunchTotal.open} closed={hoPunchTotal.closed} title="HO Punch" openColor="#f59e0b"/>
                                <QualityDonutChart open={soNcrTotal.open} closed={soNcrTotal.closed} title="Site NCR"/>
                                <QualityDonutChart open={soPunchTotal.open} closed={soPunchTotal.closed} title="Site Punch" openColor="#f59e0b"/>
                                <WeldingGauge accepted={welding.ndtAccepted||0} rejected={welding.ndtRejected||0} targetRate={welding.rejectionRatePlan||2}/>
                            </div>
                            
                            {/* Certificate Status */}
                            <div style={{display:'grid',gridTemplateColumns:'1fr 2fr',gap:16}}>
                                <CertificateDonut notYetApplied={q.certificate?.notYetApplied||0} underApplication={q.certificate?.underApplication||0} completed={q.certificate?.completed||0}/>
                                <CertificateChart notYetApplied={q.certificate?.notYetApplied||0} underApplication={q.certificate?.underApplication||0} completed={q.certificate?.completed||0}/>
                            </div>
                        </div>);
                    })()}
                </div>
                
                {/* EPCC Progress */}
                <div className="card" style={{padding:20,marginBottom:20}}><h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>üèóÔ∏è EPCC Progress</h3><div className="grid-4">{Object.entries(epcc||{}).map(([key,val])=>(<div key={key} style={{background:'#f8fafc',padding:12,borderRadius:8}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:6}}><span style={{fontWeight:600,textTransform:'capitalize',fontSize:12}}>{key}</span><span style={{fontSize:11,color:'#64748b'}}>{val?.weight||0}%</span></div><p style={{fontSize:20,fontWeight:800,color:'#0f766e'}}>{val?.actual?.toFixed(2)||0}%</p><div className="progress-bar"><div className="progress-fill" style={{width:`${val?.actual||0}%`,background:'linear-gradient(90deg,#0d9488,#14b8a6)'}}></div></div><p style={{fontSize:10,color:'#64748b',marginTop:4}}>Plan: {val?.plan?.toFixed(2)||0}%</p></div>))}</div></div>
                
                {/* Milestones Status Section */}
                <div className="grid-2" style={{marginBottom:20}}>
                    <div className="card" style={{padding:20}}>
                        <h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>üìÖ Schedule Milestones</h3>
                        <div style={{maxHeight:200,overflowY:'auto'}}>
                            <table className="table">
                                <thead><tr><th style={{width:30}}>#</th><th>Description</th><th style={{width:85}}>Plan</th><th style={{width:85}}>Actual/FC</th><th style={{width:85}}>Status</th></tr></thead>
                                <tbody>
                                    {(milestonesSchedule||[]).map((m,i)=>(<tr key={i}><td style={{fontWeight:600}}>{m.no}</td><td style={{fontSize:11}}>{m.description}</td><td style={{fontSize:10}}>{m.planDate||m.targetPlan||'-'}</td><td style={{fontSize:10}}>{m.actualForecastDate||'-'}</td><td><span style={{background:m.status==='Completed'?'#dcfce7':m.status==='On Track'?'#fef3c7':'#fee2e2',color:m.status==='Completed'?'#16a34a':m.status==='On Track'?'#d97706':'#dc2626',padding:'2px 6px',borderRadius:999,fontSize:9,fontWeight:600}}>{m.status==='Completed'?'üü¢':m.status==='On Track'?'üü°':'üî¥'} {m.status}</span></td></tr>))}
                                    {(!milestonesSchedule||milestonesSchedule.length===0)&&<tr><td colSpan={5} style={{textAlign:'center',color:'#94a3b8',fontSize:11}}>No milestones</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div className="card" style={{padding:20}}>
                        <h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>üí∞ Payment Milestones</h3>
                        <div style={{maxHeight:200,overflowY:'auto'}}>
                            <table className="table">
                                <thead><tr><th style={{width:30}}>#</th><th>Description</th><th style={{width:85}}>Plan</th><th style={{width:85}}>Actual/FC</th><th style={{width:85}}>Status</th></tr></thead>
                                <tbody>
                                    {(milestonesPayment||[]).map((m,i)=>(<tr key={i}><td style={{fontWeight:600}}>{m.no}</td><td style={{fontSize:11}}>{m.description}</td><td style={{fontSize:10}}>{m.planDate||m.targetPlan||'-'}</td><td style={{fontSize:10}}>{m.actualForecastDate||'-'}</td><td><span style={{background:m.status==='Completed'?'#dcfce7':m.status==='On Track'?'#fef3c7':'#fee2e2',color:m.status==='Completed'?'#16a34a':m.status==='On Track'?'#d97706':'#dc2626',padding:'2px 6px',borderRadius:999,fontSize:9,fontWeight:600}}>{m.status==='Completed'?'üü¢':m.status==='On Track'?'üü°':'üî¥'} {m.status}</span></td></tr>))}
                                    {(!milestonesPayment||milestonesPayment.length===0)&&<tr><td colSpan={5} style={{textAlign:'center',color:'#94a3b8',fontSize:11}}>No milestones</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                {/* Milestones & Activities */}
                <div className="grid-2">
                    <div className="card" style={{padding:20}}><h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>üìã This Week Activities</h3>{Object.entries(selectedReport.thisWeekActivities||{}).map(([cat,items])=>(<div key={cat} style={{marginBottom:10}}><p style={{fontWeight:600,fontSize:12,color:'#0f766e',textTransform:'capitalize'}}>{cat}</p><ul style={{paddingLeft:16,margin:0}}>{(Array.isArray(items)?items:[]).filter(i=>i).map((item,j)=><li key={j} style={{fontSize:12,color:'#475569'}}>{item}</li>)}</ul></div>))}</div>
                    <div className="card" style={{padding:20}}><h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>üìÖ Next Week Plan</h3>{Object.entries(selectedReport.nextWeekPlan||{}).map(([cat,items])=>(<div key={cat} style={{marginBottom:10}}><p style={{fontWeight:600,fontSize:12,color:'#3b82f6',textTransform:'capitalize'}}>{cat}</p><ul style={{paddingLeft:16,margin:0}}>{(Array.isArray(items)?items:[]).filter(i=>i).map((item,j)=><li key={j} style={{fontSize:12,color:'#475569'}}>{item}</li>)}</ul></div>))}</div>
                </div>
            </div>
        );
    };

    const renderProjects=()=>(<div><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}><h1 style={{fontSize:24,fontWeight:800}}>Projects</h1><button className="btn btn-primary" onClick={()=>{setFormData({});setEditingId(null);setShowModal('project');}}><Icons.Plus/> Add</button></div><div className="grid-2">{projects.map(p=>(<div key={p.id} className="card"><div style={{background:'linear-gradient(135deg,#0d9488,#0f766e)',padding:16,color:'white'}}><h3 style={{fontSize:16,fontWeight:700}}>{p.name}</h3><p style={{opacity:0.9,fontSize:12}}>{p.contractor}</p></div><div style={{padding:16}}><div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:8,fontSize:12,marginBottom:12}}><div><span style={{color:'#64748b'}}>Owner:</span><br/><strong>{p.owner}</strong></div><div><span style={{color:'#64748b'}}>BAC:</span><br/><strong>${((p.bac||p.contractPrice||0)/1e6).toFixed(2)}M</strong></div></div><div style={{display:'flex',gap:8}}><button className="btn btn-secondary btn-sm" style={{flex:1}} onClick={()=>{setFormData(p);setEditingId(p.id);setShowModal('project');}}><Icons.Edit/> Edit</button><button className="btn btn-danger btn-sm" onClick={()=>{if(confirm('Delete?'))setProjects(projects.filter(x=>x.id!==p.id));}}><Icons.Delete/></button></div></div></div>))}</div></div>);

    const renderReports=()=>(<div><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}><h1 style={{fontSize:24,fontWeight:800}}>Weekly Reports</h1><button className="btn btn-primary" onClick={()=>{setFormData({projectId:projects[0]?.id,weekNo:(reports.length>0?Math.max(...reports.map(r=>r.weekNo))+1:1),docNo:`RPT${String((reports.length>0?Math.max(...reports.map(r=>r.weekNo))+1:1)).padStart(4,'0')}`,hse:defaultHSE,thisWeekActivities:defaultActivities,nextWeekPlan:defaultActivities,milestonesSchedule:[],milestonesPayment:[],cashFlow:defaultCashFlow,tkdn:defaultTKDN});setEditingId(null);setActiveTab('general');setShowModal('report');}}><Icons.Plus/> Create</button></div>{reports.map(r=>{const proj=projects.find(p=>p.id===r.projectId);const cfm=getCashFlowMetrics(r);return(<div key={r.id} className="card" style={{padding:16,marginBottom:12}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><div style={{display:'flex',alignItems:'center',gap:12}}><div style={{width:44,height:44,borderRadius:10,background:'linear-gradient(135deg,#0d9488,#0f766e)',display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:800,fontSize:16}}>{r.weekNo}</div><div><h3 style={{fontWeight:700,fontSize:14}}>{r.docNo}</h3><p style={{color:'#64748b',fontSize:12}}>{proj?.name}</p></div></div><div style={{display:'flex',alignItems:'center',gap:8}}><span style={{fontSize:12}}>{cfm?.overallStatus==='green'?'üü¢':cfm?.overallStatus==='yellow'?'üü°':'üî¥'}</span><span className={`badge ${r.status==='Issued'?'badge-success':'badge-warning'}`}>{r.status}</span><button className="btn btn-secondary btn-xs" onClick={()=>{setViewReportData(r);setShowModal('viewReport');}} title="View Report Data"><Icons.Eye/> View</button><button className="btn btn-secondary btn-xs" onClick={()=>{setFormData({...r,hse:r.hse||defaultHSE,thisWeekActivities:r.thisWeekActivities||defaultActivities,nextWeekPlan:r.nextWeekPlan||defaultActivities,cashFlow:r.cashFlow||defaultCashFlow,tkdn:r.tkdn||defaultTKDN});setEditingId(r.id);setActiveTab('general');setShowModal('report');}} title="Edit Report"><Icons.Edit/></button><button className="btn btn-secondary btn-xs" onClick={()=>copyReport(r)} title="Duplicate"><Icons.Copy/></button><button className="btn btn-danger btn-xs" onClick={()=>deleteReport(r.id)} title="Delete"><Icons.Delete/></button></div></div></div>);})}</div>);

    const renderSCurve=()=>{if(!selectedReport)return<div style={{padding:40,textAlign:'center'}}>Select a report</div>;const u=selectedReport.uploads||{};return(<div><h1 style={{fontSize:24,fontWeight:800,marginBottom:20}}>S-Curve & Cash Flow - Week {selectedReport.weekNo}</h1><div className="grid-3" style={{marginBottom:20}}>{[{key:'sCurveGeneral',label:'S-Curve General EPCC',color:'#0d9488'},{key:'sCurveEngineering',label:'S-Curve Engineering',color:'#3b82f6'},{key:'sCurveProcurement',label:'S-Curve Procurement',color:'#f59e0b'},{key:'sCurveConstruction',label:'S-Curve Construction',color:'#8b5cf6'},{key:'sCurveCommissioning',label:'S-Curve Commissioning',color:'#ec4899'},{key:'cashFlow',label:'Cash Flow',color:'#10b981'}].map(cat=>(<div key={cat.key} className="card"><div style={{background:cat.color,padding:10,color:'white'}}><h4 style={{fontWeight:600,fontSize:12}}>{cat.label}</h4></div><div style={{padding:12}}>{u[cat.key]?<div><img src={u[cat.key].data} style={{width:'100%',height:100,objectFit:'cover',borderRadius:6,marginBottom:8,cursor:'pointer'}} onClick={()=>setImageViewer({src:u[cat.key].data,title:cat.label})}/><button className="btn btn-danger btn-xs" style={{width:'100%'}} onClick={()=>setReports(reports.map(r=>r.id===selectedReport.id?{...r,uploads:{...r.uploads,[cat.key]:null}}:r))}><Icons.Delete/></button></div>:<label className="upload-zone" style={{display:'block',padding:16}}><input type="file" accept="image/*" style={{display:'none'}} onChange={e=>updateReportUpload(selectedReport.id,cat.key,e.target.files[0])}/><Icons.Image/><p style={{marginTop:4,color:'#64748b',fontSize:11}}>Upload</p></label>}</div></div>))}</div><h2 style={{fontSize:18,fontWeight:700,marginBottom:16}}>QR Code</h2><div className="grid-3">{[{key:'qrPhotos',label:'Photos',color:'#3b82f6'},{key:'qrVideos',label:'Videos',color:'#8b5cf6'},{key:'qrReport',label:'Report',color:'#0d9488'}].map(qr=>(<div key={qr.key} className="card"><div style={{background:qr.color,padding:10,color:'white',textAlign:'center'}}><h4 style={{fontWeight:600,fontSize:12}}>{qr.label}</h4></div><div style={{padding:12}}>{u[qr.key]?<div><img src={u[qr.key].data} style={{width:'100%',height:80,objectFit:'cover',borderRadius:6,marginBottom:8,cursor:'pointer'}} onClick={()=>setImageViewer({src:u[qr.key].data,title:qr.label})}/><button className="btn btn-danger btn-xs" style={{width:'100%'}} onClick={()=>setReports(reports.map(r=>r.id===selectedReport.id?{...r,uploads:{...r.uploads,[qr.key]:null}}:r))}><Icons.Delete/></button></div>:<label className="upload-zone" style={{display:'block',padding:12}}><input type="file" accept="image/*" style={{display:'none'}} onChange={e=>updateReportUpload(selectedReport.id,qr.key,e.target.files[0])}/><Icons.Image/></label>}</div></div>))}</div></div>);};

    const renderAnalysis=()=>{
        const risks=calculateRisks();
        const cfm=getCashFlowMetrics(selectedReport);
        const trend=selectedReport?.trendData||{};
        const q=selectedReport?.quality||{};
        const so=q.siteOffice||{};
        const welding=so.welding||{};
        const ndtTotal=(welding.ndtAccepted||0)+(welding.ndtRejected||0);
        const rejRate=ndtTotal>0?((welding.ndtRejected||0)/ndtTotal)*100:0;
        
        return(<div>
            <h1 style={{fontSize:24,fontWeight:800,marginBottom:20}}>üìä Risk Analysis & Trend - Week {selectedReport?.weekNo}</h1>
            
            {/* Risk Summary Cards */}
            <div className="grid-6" style={{marginBottom:20}}>
                <div className="stat-card" style={{background:'linear-gradient(135deg,#f0fdf4,#dcfce7)'}}>
                    <p style={{fontSize:12,color:'#16a34a',fontWeight:600}}>üìÖ Schedule</p>
                    <p style={{fontSize:20,fontWeight:800,color:(selectedReport?.evm?.spiValue||1)>=1?'#16a34a':'#dc2626'}}>{(selectedReport?.evm?.spiValue||1)>=1?'OK':'AT RISK'}</p>
                    <p style={{fontSize:10,color:'#64748b'}}>SPI: {(selectedReport?.evm?.spiValue||1).toFixed(3)}</p>
                </div>
                <div className="stat-card" style={{background:'linear-gradient(135deg,#fefce8,#fef3c7)'}}>
                    <p style={{fontSize:12,color:'#ca8a04',fontWeight:600}}>üí∞ Cost</p>
                    <p style={{fontSize:20,fontWeight:800,color:(selectedReport?.evm?.cpiValue||1)>=1?'#16a34a':'#f59e0b'}}>{(selectedReport?.evm?.cpiValue||1)>=1?'OK':'MONITOR'}</p>
                    <p style={{fontSize:10,color:'#64748b'}}>CPI: {(selectedReport?.evm?.cpiValue||1).toFixed(3)}</p>
                </div>
                <div className="stat-card" style={{background:'linear-gradient(135deg,#fdf2f8,#fce7f3)'}}>
                    <p style={{fontSize:12,color:'#be185d',fontWeight:600}}>üíµ Cash Flow</p>
                    <p style={{fontSize:20,fontWeight:800,color:cfm?.overallStatus==='green'?'#16a34a':cfm?.overallStatus==='yellow'?'#f59e0b':'#dc2626'}}>{cfm?.overallStatus==='green'?'HEALTHY':cfm?.overallStatus==='yellow'?'AT RISK':'CRITICAL'}</p>
                    <p style={{fontSize:10,color:'#64748b'}}>Score: {((cfm?.overallScore||0)*100).toFixed(0)}%</p>
                </div>
                <div className="stat-card" style={{background:'linear-gradient(135deg,#f0f9ff,#dbeafe)'}}>
                    <p style={{fontSize:12,color:'#2563eb',fontWeight:600}}>ü¶∫ Safety</p>
                    <p style={{fontSize:20,fontWeight:800,color:(selectedReport?.hse?.lagging?.lti||0)===0?'#16a34a':'#dc2626'}}>{(selectedReport?.hse?.lagging?.lti||0)===0?'GREEN':'RED'}</p>
                    <p style={{fontSize:10,color:'#64748b'}}>TRIR: {(selectedReport?.hse?.trir||0).toFixed(2)}</p>
                </div>
                <div className="stat-card" style={{background:'linear-gradient(135deg,#faf5ff,#f3e8ff)'}}>
                    <p style={{fontSize:12,color:'#7c3aed',fontWeight:600}}>üîç Quality</p>
                    <p style={{fontSize:20,fontWeight:800,color:rejRate<=(welding.rejectionRatePlan||2)?'#16a34a':'#f59e0b'}}>{rejRate<=(welding.rejectionRatePlan||2)?'OK':'MONITOR'}</p>
                    <p style={{fontSize:10,color:'#64748b'}}>Weld Rej: {rejRate.toFixed(2)}%</p>
                </div>
                {/* TKDN Risk Card - NEW */}
                {(()=>{
                    const tkdn=selectedReport?.tkdn||{plan:0,actual:0};
                    const tkdnStatus=tkdn.actual>=tkdn.plan?'green':tkdn.actual>=tkdn.plan*0.9?'yellow':'red';
                    return(
                        <div className="stat-card" style={{background:`linear-gradient(135deg,${tkdnStatus==='green'?'#ecfeff,#cffafe':tkdnStatus==='yellow'?'#fffbeb,#fef3c7':'#fef2f2,#fee2e2'})`}}>
                            <p style={{fontSize:12,color:'#0891b2',fontWeight:600}}>üè≠ TKDN</p>
                            <p style={{fontSize:20,fontWeight:800,color:tkdnStatus==='green'?'#16a34a':tkdnStatus==='yellow'?'#f59e0b':'#dc2626'}}>{tkdnStatus==='green'?'OK':tkdnStatus==='yellow'?'MONITOR':'AT RISK'}</p>
                            <p style={{fontSize:10,color:'#64748b'}}>Act: {(tkdn.actual||0).toFixed(1)}% / Plan: {tkdn.plan||0}%</p>
                        </div>
                    );
                })()}
            </div>
            
            {/* Trend Analysis Section */}
            <div className="card" style={{padding:20,marginBottom:20}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
                    <h3 style={{fontSize:18,fontWeight:700}}>üìà Trend Analysis</h3>
                    <span style={{fontSize:11,color:'#64748b'}}>Last 6 weeks performance trend</span>
                </div>
                
                {/* Schedule Trend */}
                <div style={{marginBottom:24}}>
                    <h4 style={{fontSize:14,fontWeight:600,marginBottom:12,color:'#16a34a',borderBottom:'2px solid #16a34a',paddingBottom:6}}>üìÖ Schedule Performance Trend</h4>
                    <div className="grid-2" style={{gap:16}}>
                        <TrendLineChart 
                            data={trend.schedule||[]} 
                            lines={[
                                {key:'planProgress',label:'Plan Progress (%)',color:'#94a3b8',fill:false},
                                {key:'actualProgress',label:'Actual Progress (%)',color:'#16a34a',fill:true}
                            ]} 
                            title="Progress Plan vs Actual" 
                            yLabel="Progress %"
                        />
                        <TrendComboChart 
                            data={trend.schedule||[]} 
                            bars={[{key:'variance',label:'Variance (%)',color:'#86efac'}]}
                            lines={[{key:'spi',label:'SPI',color:'#7c3aed'}]} 
                            title="Schedule Variance & SPI Trend"
                        />
                    </div>
                </div>
                
                {/* Cost Trend */}
                <div style={{marginBottom:24}}>
                    <h4 style={{fontSize:14,fontWeight:600,marginBottom:12,color:'#f59e0b',borderBottom:'2px solid #f59e0b',paddingBottom:6}}>üí∞ Cost Performance Trend</h4>
                    <div className="grid-2" style={{gap:16}}>
                        <TrendLineChart 
                            data={trend.cost||[]} 
                            lines={[
                                {key:'bcws',label:'BCWS (Plan)',color:'#94a3b8',fill:false},
                                {key:'bcwp',label:'BCWP (Earned)',color:'#16a34a',fill:false},
                                {key:'acwp',label:'ACWP (Actual)',color:'#ef4444',fill:false}
                            ]} 
                            title="EVM Cost Curves (BCWS vs BCWP vs ACWP)" 
                            yLabel="Cost ($)"
                        />
                        <TrendComboChart 
                            data={trend.cost||[]} 
                            bars={[{key:'cv',label:'Cost Variance ($)',color:'#fbbf24'}]}
                            lines={[{key:'cpi',label:'CPI',color:'#8b5cf6'}]} 
                            title="Cost Variance & CPI Trend"
                        />
                    </div>
                </div>
                
                {/* Cash Flow Trend */}
                <div style={{marginBottom:24}}>
                    <h4 style={{fontSize:14,fontWeight:600,marginBottom:12,color:'#ec4899',borderBottom:'2px solid #ec4899',paddingBottom:6}}>üíµ Cash Flow Trend</h4>
                    <div className="grid-2" style={{gap:16}}>
                        <TrendBarChart 
                            data={trend.cashFlow||[]} 
                            bars={[
                                {key:'cashIn',label:'Cash In',color:'#22c55e'},
                                {key:'cashOut',label:'Cash Out',color:'#ef4444'},
                                {key:'billing',label:'Billing',color:'#3b82f6'}
                            ]} 
                            title="Cash Flow Components"
                        />
                        <TrendLineChart 
                            data={trend.cashFlow||[]} 
                            lines={[{key:'balance',label:'Cash Balance',color:'#ec4899',fill:true}]} 
                            title="Cash Flow Balance Trend" 
                            yLabel="Balance ($)"
                        />
                    </div>
                </div>
                
                {/* Safety Trend */}
                <div style={{marginBottom:24}}>
                    <h4 style={{fontSize:14,fontWeight:600,marginBottom:12,color:'#3b82f6',borderBottom:'2px solid #3b82f6',paddingBottom:6}}>ü¶∫ Safety Performance Trend</h4>
                    <div className="grid-2" style={{gap:16}}>
                        <TrendBarChart 
                            data={trend.safety||[]} 
                            bars={[
                                {key:'nearMiss',label:'Near Miss',color:'#f59e0b'},
                                {key:'observations',label:'Safety Observations',color:'#22c55e'}
                            ]} 
                            title="Safety Leading Indicators"
                        />
                        <TrendComboChart 
                            data={trend.safety||[]} 
                            bars={[{key:'safeHours',label:'Safe Man-Hours',color:'#60a5fa'}]}
                            lines={[{key:'manpower',label:'Manpower',color:'#f97316'}]} 
                            title="Safe Hours & Manpower Trend"
                        />
                    </div>
                </div>
                
                {/* Quality Trend */}
                <div style={{marginBottom:24}}>
                    <h4 style={{fontSize:14,fontWeight:600,marginBottom:12,color:'#8b5cf6',borderBottom:'2px solid #8b5cf6',paddingBottom:6}}>üîç Quality Performance Trend</h4>
                    <div className="grid-3" style={{gap:16}}>
                        <TrendBarChart 
                            data={trend.quality||[]} 
                            bars={[
                                {key:'ncrOpen',label:'NCR Open',color:'#ef4444'},
                                {key:'ncrClosed',label:'NCR Closed',color:'#22c55e'}
                            ]} 
                            title="NCR Status Trend"
                        />
                        <TrendBarChart 
                            data={trend.quality||[]} 
                            bars={[
                                {key:'punchOpen',label:'Punch Open',color:'#f59e0b'},
                                {key:'punchClosed',label:'Punch Closed',color:'#22c55e'}
                            ]} 
                            title="Punch List Status Trend"
                        />
                        <TrendComboChart 
                            data={trend.quality||[]} 
                            bars={[{key:'certCompleted',label:'Certificates',color:'#a78bfa'}]}
                            lines={[{key:'weldRejectRate',label:'Weld Reject %',color:'#ef4444'}]} 
                            title="Welding & Certificate Trend"
                        />
                    </div>
                </div>
                
                {/* TKDN Trend - NEW */}
                {(trend.tkdn?.length>0 || (selectedReport?.tkdn?.plan>0 || selectedReport?.tkdn?.actual>0)) && (
                <div>
                    <h4 style={{fontSize:14,fontWeight:600,marginBottom:12,color:'#0891b2',borderBottom:'2px solid #0891b2',paddingBottom:6}}>üè≠ TKDN Performance Trend (Tingkat Komponen Dalam Negeri)</h4>
                    <div className="grid-2" style={{gap:16}}>
                        {/* TKDN Line Chart */}
                        <TKDNTrendChart data={trend.tkdn||[]}/>
                        
                        {/* TKDN Summary Box */}
                        <div style={{background:'linear-gradient(135deg,#ecfeff,#cffafe)',padding:16,borderRadius:8,border:'1px solid #0891b2'}}>
                            <p style={{fontSize:13,fontWeight:700,marginBottom:12,color:'#0891b2'}}>üìä TKDN Current Status</p>
                            {(()=>{
                                const tkdn=selectedReport?.tkdn||{plan:0,actual:0};
                                const variance=tkdn.actual-tkdn.plan;
                                const status=tkdn.actual>=tkdn.plan?'green':tkdn.actual>=tkdn.plan*0.9?'yellow':'red';
                                const statusColor=status==='green'?'#22c55e':status==='yellow'?'#f59e0b':'#ef4444';
                                return(
                                    <div>
                                        <div className="grid-2" style={{gap:12,marginBottom:12}}>
                                            <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}>
                                                <p style={{fontSize:10,color:'#64748b'}}>Target Minimum</p>
                                                <p style={{fontSize:26,fontWeight:800,color:'#3b82f6'}}>{tkdn.plan||0}%</p>
                                            </div>
                                            <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}>
                                                <p style={{fontSize:10,color:'#64748b'}}>Realisasi Aktual</p>
                                                <p style={{fontSize:26,fontWeight:800,color:'#0891b2'}}>{(tkdn.actual||0).toFixed(1)}%</p>
                                            </div>
                                        </div>
                                        <div className="grid-2" style={{gap:12}}>
                                            <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}>
                                                <p style={{fontSize:10,color:'#64748b'}}>Variance</p>
                                                <p style={{fontSize:22,fontWeight:800,color:variance>=0?'#22c55e':'#ef4444'}}>
                                                    {variance>=0?'+':''}{variance.toFixed(1)}%
                                                </p>
                                            </div>
                                            <div style={{background:statusColor,padding:12,borderRadius:8,textAlign:'center'}}>
                                                <p style={{fontSize:10,color:'white',opacity:0.9}}>Status</p>
                                                <p style={{fontSize:14,fontWeight:800,color:'white'}}>
                                                    {status==='green'?'‚úÖ MEMENUHI':status==='yellow'?'‚ö†Ô∏è MONITOR':'‚ùå RISK'}
                                                </p>
                                            </div>
                                        </div>
                                        <div style={{marginTop:12,padding:10,background:'white',borderRadius:6}}>
                                            <p style={{fontSize:10,color:'#64748b',marginBottom:4}}>Achievement Rate:</p>
                                            <div style={{display:'flex',alignItems:'center',gap:8}}>
                                                <div style={{flex:1,height:12,background:'#e2e8f0',borderRadius:6,overflow:'hidden'}}>
                                                    <div style={{height:'100%',width:`${Math.min((tkdn.actual/tkdn.plan||0)*100,100)}%`,background:`linear-gradient(90deg,${statusColor},${status==='green'?'#16a34a':'#f97316'})`,borderRadius:6}}></div>
                                                </div>
                                                <span style={{fontSize:12,fontWeight:700,color:statusColor}}>{tkdn.plan>0?(tkdn.actual/tkdn.plan*100).toFixed(0):0}%</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                    </div>
                </div>
                )}
            </div>
            
            {/* Risk Register */}
            <div className="card" style={{padding:20}}>
                <h3 style={{fontSize:16,fontWeight:700,marginBottom:16}}>‚ö†Ô∏è Risk Register</h3>
                <table className="table">
                    <thead><tr><th>Category</th><th>Level</th><th>Description</th><th>Recommendation</th></tr></thead>
                    <tbody>{risks.map((r,i)=>(<tr key={i}><td><strong>{r.category}</strong></td><td><span className={`badge ${r.level==='High'||r.level==='Critical'?'badge-danger':r.level==='Medium'?'badge-warning':'badge-success'}`}>{r.level}</span></td><td>{r.description}</td><td style={{fontSize:12}}>{r.recommendation}</td></tr>))}</tbody>
                </table>
            </div>
        </div>);
    };

    const [exportingPDF, setExportingPDF] = useState(false);
    const [pdfProgress, setPdfProgress] = useState('');

    const exportToPDF = async (pageType) => {
        setExportingPDF(true);
        setPdfProgress('Preparing...');
        
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;
            const contentWidth = pageWidth - (margin * 2);
            
            // Store current menu
            const currentMenu = activeMenu;
            
            // Function to capture a page
            const capturePage = async (menuName, title) => {
                setPdfProgress('Capturing ' + title + '...');
                setActiveMenu(menuName);
                
                // Wait for render
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const content = document.querySelector('.main-content');
                if (!content) return null;
                
                const canvas = await html2canvas(content, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#f8fafc',
                    windowWidth: 1200,
                    windowHeight: content.scrollHeight
                });
                
                return canvas;
            };
            
            // Add header to PDF
            const addHeader = (title, pageNum) => {
                pdf.setFillColor(15, 118, 110);
                pdf.rect(0, 0, pageWidth, 20, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text('EPC Weekly Report - ' + title, margin, 13);
                pdf.setFontSize(10);
                pdf.text('Week ' + (selectedReport?.weekNo || ''), pageWidth - margin - 30, 13);
                pdf.setTextColor(0, 0, 0);
            };
            
            // Add footer to PDF
            const addFooter = (pageNum, totalPages) => {
                pdf.setFontSize(8);
                pdf.setTextColor(100, 100, 100);
                pdf.text(selectedProject?.name || 'EPC Project', margin, pageHeight - 5);
                pdf.text('Page ' + pageNum + ' of ' + totalPages, pageWidth - margin - 20, pageHeight - 5);
                pdf.text(new Date().toLocaleDateString(), pageWidth / 2, pageHeight - 5, { align: 'center' });
            };
            
            let pageNum = 1;
            let totalPages = pageType === 'both' ? 2 : 1;
            
            // Capture Dashboard
            if (pageType === 'dashboard' || pageType === 'both') {
                const dashCanvas = await capturePage('dashboard', 'Dashboard');
                if (dashCanvas) {
                    addHeader('Dashboard', pageNum);
                    const imgData = dashCanvas.toDataURL('image/jpeg', 0.95);
                    const imgHeight = (dashCanvas.height * contentWidth) / dashCanvas.width;
                    
                    let heightLeft = imgHeight;
                    let position = 25;
                    
                    pdf.addImage(imgData, 'JPEG', margin, position, contentWidth, imgHeight);
                    heightLeft -= (pageHeight - position - 10);
                    
                    while (heightLeft > 0) {
                        pdf.addPage();
                        pageNum++;
                        totalPages++;
                        position = heightLeft - imgHeight + 10;
                        pdf.addImage(imgData, 'JPEG', margin, position, contentWidth, imgHeight);
                        heightLeft -= (pageHeight - 10);
                    }
                    addFooter(pageNum, totalPages);
                }
            }
            
            // Capture Risk Analysis
            if (pageType === 'analysis' || pageType === 'both') {
                if (pageType === 'both') {
                    pdf.addPage();
                    pageNum++;
                }
                const analysisCanvas = await capturePage('analysis', 'Risk Analysis');
                if (analysisCanvas) {
                    addHeader('Risk Analysis & Trend', pageNum);
                    const imgData = analysisCanvas.toDataURL('image/jpeg', 0.95);
                    const imgHeight = (analysisCanvas.height * contentWidth) / analysisCanvas.width;
                    
                    let heightLeft = imgHeight;
                    let position = 25;
                    
                    pdf.addImage(imgData, 'JPEG', margin, position, contentWidth, imgHeight);
                    heightLeft -= (pageHeight - position - 10);
                    
                    while (heightLeft > 0) {
                        pdf.addPage();
                        pageNum++;
                        totalPages++;
                        position = heightLeft - imgHeight + 10;
                        pdf.addImage(imgData, 'JPEG', margin, position, contentWidth, imgHeight);
                        heightLeft -= (pageHeight - 10);
                    }
                    addFooter(pageNum, totalPages);
                }
            }
            
            // Restore original menu
            setActiveMenu(currentMenu);
            
            // Save PDF
            setPdfProgress('Generating PDF...');
            const fileName = 'EPC_Report_Week' + (selectedReport?.weekNo || '') + '_' + pageType + '_' + new Date().toISOString().split('T')[0] + '.pdf';
            pdf.save(fileName);
            
            showNotif('PDF exported successfully!');
        } catch (error) {
            console.error('PDF Export Error:', error);
            showNotif('Export failed: ' + error.message, 'error');
        } finally {
            setExportingPDF(false);
            setPdfProgress('');
        }
    };

    const renderDataMgmt=()=>(<div>
        <h1 style={{fontSize:24,fontWeight:800,marginBottom:20}}>Data Management</h1>
        
        {/* PDF Export Section */}
        <div className="card" style={{padding:20,marginBottom:20,background:'linear-gradient(135deg,#fef2f2,#fee2e2)',border:'2px solid #ef4444'}}>
            <h3 style={{fontWeight:700,marginBottom:16,color:'#dc2626',display:'flex',alignItems:'center',gap:8}}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:20,height:20}}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 15h6"/><path d="M9 11h6"/></svg>
                Export to PDF
            </h3>
            <p style={{fontSize:13,color:'#991b1b',marginBottom:16}}>Export halaman Dashboard dan/atau Risk Analysis ke format PDF dengan tampilan identik 100% seperti di aplikasi.</p>
            
            {exportingPDF ? (
                <div style={{textAlign:'center',padding:20}}>
                    <div style={{width:40,height:40,border:'4px solid #e2e8f0',borderTop:'4px solid #dc2626',borderRadius:'50%',margin:'0 auto 12px',animation:'spin 1s linear infinite'}}></div>
                    <p style={{color:'#dc2626',fontWeight:600}}>{pdfProgress}</p>
                    <style>{`@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}`}</style>
                </div>
            ) : (
                <div className="grid-3" style={{gap:12}}>
                    <button className="btn" style={{background:'#dc2626',color:'white',fontWeight:600,padding:'12px 16px'}} onClick={()=>exportToPDF('dashboard')}>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:16,height:16}}><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>
                        Dashboard Only
                    </button>
                    <button className="btn" style={{background:'#dc2626',color:'white',fontWeight:600,padding:'12px 16px'}} onClick={()=>exportToPDF('analysis')}>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:16,height:16}}><path d="M21 21H4.6c-.6 0-1.1-.2-1.4-.6-.4-.4-.6-.9-.6-1.4V3"/><path d="m7 14 4-4 4 4 6-6"/></svg>
                        Risk Analysis Only
                    </button>
                    <button className="btn" style={{background:'#991b1b',color:'white',fontWeight:600,padding:'12px 16px'}} onClick={()=>exportToPDF('both')}>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{width:16,height:16}}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Export Both (Full Report)
                    </button>
                </div>
            )}
            
            <div style={{marginTop:16,padding:12,background:'white',borderRadius:8,border:'1px solid #fecaca'}}>
                <p style={{fontSize:11,color:'#64748b',marginBottom:8}}><strong>üìã PDF Export Features:</strong></p>
                <ul style={{fontSize:11,color:'#64748b',paddingLeft:20,margin:0}}>
                    <li>Tampilan 100% identik dengan aplikasi</li>
                    <li>Header dengan judul dan nomor minggu</li>
                    <li>Footer dengan nama proyek, halaman, dan tanggal</li>
                    <li>Multi-page support untuk konten panjang</li>
                    <li>High quality image (2x scale)</li>
                </ul>
            </div>
        </div>
        
        {/* JSON Export/Import Section */}
        <div className="grid-3" style={{gap:16}}>
            <div className="card" style={{padding:20}}>
                <h3 style={{fontWeight:700,marginBottom:12}}><Icons.Download/> Export JSON</h3>
                <p style={{fontSize:13,color:'#64748b',marginBottom:16}}>Download all data as JSON backup</p>
                <button className="btn btn-primary" style={{width:'100%'}} onClick={exportData}>Export JSON</button>
            </div>
            <div className="card" style={{padding:20}}>
                <h3 style={{fontWeight:700,marginBottom:12}}>Import JSON</h3>
                <p style={{fontSize:13,color:'#64748b',marginBottom:16}}>Restore data from JSON file</p>
                <label className="btn btn-secondary" style={{width:'100%',justifyContent:'center',cursor:'pointer'}}>
                    <input type="file" accept=".json" style={{display:'none'}} onChange={importData}/>Import JSON
                </label>
            </div>
            <div className="card" style={{padding:20}}>
                <h3 style={{fontWeight:700,marginBottom:12}}>üìä Statistics</h3>
                <p style={{marginBottom:4}}>Projects: <strong>{projects.length}</strong></p>
                <p style={{marginBottom:4}}>Reports: <strong>{reports.length}</strong></p>
                <p style={{fontSize:11,color:'#64748b',marginTop:8}}>Current: Week {selectedReport?.weekNo} | {selectedProject?.name?.substring(0,20)}...</p>
            </div>
        </div>
    </div>);

    // Report Modal with Enhanced Cash Flow Tab
    const renderReportModal=()=>{
        const tabs=[{id:'general',label:'General'},{id:'progress',label:'Progress & EVM'},{id:'cashflow',label:'üíµ Cash Flow'},{id:'hse',label:'HSE'},{id:'quality',label:'Quality'},{id:'activities',label:'Activities'},{id:'milestones',label:'Milestones'},{id:'uploads',label:'Uploads'}];
        const hse=formData.hse||defaultHSE;
        const thisWeek=formData.thisWeekActivities||defaultActivities;
        const nextWeek=formData.nextWeekPlan||defaultActivities;
        const evm=formData.evm||{};
        const bac=evm.bac||selectedProject?.bac||selectedProject?.contractPrice||0;
        
        // Get computed cash flow metrics
        const revenue=formData.evm?.bcwp||0;
        const cfRaw=formData.cashFlow||defaultCashFlow;
        const cf=calculateCashFlowPerformance(revenue,cfRaw.cashOut||0,cfRaw.billing||0,cfRaw.cashIn||0,formData.weekNo||cfRaw.weekNo||1);
        
        return(<div className="modal-overlay" onClick={()=>setShowModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div style={{padding:16,borderBottom:'1px solid #e2e8f0',display:'flex',justifyContent:'space-between',alignItems:'center'}}><h2 style={{fontSize:18,fontWeight:700}}>{editingId?'Edit':'Create'} Weekly Report</h2><button onClick={()=>setShowModal(null)} style={{background:'none',border:'none',cursor:'pointer'}}><Icons.X/></button></div><div style={{borderBottom:'1px solid #e2e8f0',display:'flex',overflowX:'auto'}}>{tabs.map(t=><button key={t.id} className={`tab-btn ${activeTab===t.id?'active':''}`} onClick={()=>setActiveTab(t.id)}>{t.label}</button>)}</div><div style={{padding:16,maxHeight:'55vh',overflowY:'auto'}}>
        
        {activeTab==='general'&&<div className="grid-2" style={{gap:12}}><div><label className="label">Project</label><select className="select" value={formData.projectId||''} onChange={e=>setFormData({...formData,projectId:Number(e.target.value)})}>{projects.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select></div><div><label className="label">Week No</label><input className="input" type="number" value={formData.weekNo||''} onChange={e=>setFormData({...formData,weekNo:Number(e.target.value)})}/></div><div><label className="label">Document Number</label><input className="input" value={formData.docNo||''} onChange={e=>setFormData({...formData,docNo:e.target.value})} placeholder="e.g. SEGSK7PMGN00RPW0052"/></div><div><label className="label">Status</label><select className="select" value={formData.status||'Draft'} onChange={e=>setFormData({...formData,status:e.target.value})}><option>Draft</option><option>Issued</option></select></div><div><label className="label">Period Start</label><input className="input" type="date" value={formData.periodStart||''} onChange={e=>setFormData({...formData,periodStart:e.target.value})}/></div><div><label className="label">Period End</label><input className="input" type="date" value={formData.periodEnd||''} onChange={e=>setFormData({...formData,periodEnd:e.target.value})}/></div><div><label className="label">Prepared By</label><input className="input" value={formData.preparedBy||''} onChange={e=>setFormData({...formData,preparedBy:e.target.value})}/></div><div><label className="label">Checked By</label><input className="input" value={formData.checkedBy||''} onChange={e=>setFormData({...formData,checkedBy:e.target.value})}/></div><div><label className="label">Approved By</label><input className="input" value={formData.approvedBy||''} onChange={e=>setFormData({...formData,approvedBy:e.target.value})}/></div><div><label className="label">Approval Status</label><select className="select" value={formData.approvalStatus||'Pending'} onChange={e=>setFormData({...formData,approvalStatus:e.target.value})}><option value="Pending">‚è≥ Pending</option><option value="Under Review">üìã Under Review</option><option value="Approved">‚úÖ Approved</option><option value="Rejected">‚ùå Rejected</option><option value="Revision Required">üîÑ Revision Required</option></select></div></div>}
        
        {activeTab==='progress'&&<div>
            <h4 style={{fontWeight:600,marginBottom:12}}>EPCC Progress (%)</h4>
            <div className="grid-4" style={{gap:10,marginBottom:16}}>{['engineering','procurement','construction','commissioning'].map(cat=>(<div key={cat} style={{background:'#f8fafc',padding:10,borderRadius:8}}><label className="label" style={{textTransform:'capitalize'}}>{cat}</label><div className="grid-2" style={{gap:6}}><div><span style={{fontSize:10}}>Plan</span><input className="input input-sm" type="number" step="0.01" value={formData.epcc?.[cat]?.plan||''} onChange={e=>setFormData({...formData,epcc:{...(formData.epcc||{}),[cat]:{...(formData.epcc?.[cat]||{}),plan:Number(e.target.value)}}})}/></div><div><span style={{fontSize:10}}>Actual</span><input className="input input-sm" type="number" step="0.01" value={formData.epcc?.[cat]?.actual||''} onChange={e=>setFormData({...formData,epcc:{...(formData.epcc||{}),[cat]:{...(formData.epcc?.[cat]||{}),actual:Number(e.target.value)}}})}/></div></div></div>))}</div>
            
            <h4 style={{fontWeight:600,marginBottom:12}}>Overall Progress</h4>
            <div className="grid-3" style={{gap:10,marginBottom:16}}><div><label className="label">Plan %</label><input className="input" type="number" step="0.01" value={formData.overallProgress?.plan||''} onChange={e=>setFormData({...formData,overallProgress:{...(formData.overallProgress||{}),plan:Number(e.target.value)}})}/></div><div><label className="label">Actual %</label><input className="input" type="number" step="0.01" value={formData.overallProgress?.actual||''} onChange={e=>setFormData({...formData,overallProgress:{...(formData.overallProgress||{}),actual:Number(e.target.value)}})}/></div><div><label className="label">Variance</label><input className="input" type="number" step="0.01" value={formData.overallProgress?.variance||''} onChange={e=>setFormData({...formData,overallProgress:{...(formData.overallProgress||{}),variance:Number(e.target.value)}})}/></div></div>
            
            <h4 style={{fontWeight:600,marginBottom:12,display:'flex',alignItems:'center',gap:8}}><Icons.Calculator/> EVM Input <span style={{fontSize:11,color:'#64748b',fontWeight:400}}>(SPI, CPI, EAC auto-calculated)</span></h4>
            <div className="grid-4" style={{gap:10,marginBottom:12}}>
                <div><label className="label">BAC</label><input className="input" type="number" value={evm.bac||bac||''} onChange={e=>handleEVMChange('bac',e.target.value)}/></div>
                <div><label className="label">BCWS (Planned Value)</label><input className="input" type="number" value={evm.bcws||''} onChange={e=>handleEVMChange('bcws',e.target.value)}/></div>
                <div><label className="label">BCWP (Earned Value)</label><input className="input" type="number" value={evm.bcwp||''} onChange={e=>handleEVMChange('bcwp',e.target.value)}/></div>
                <div><label className="label">ACWP (Actual Cost)</label><input className="input" type="number" value={evm.acwp||''} onChange={e=>handleEVMChange('acwp',e.target.value)}/></div>
            </div>
            
            <div className="formula-box">
                <h4 style={{fontWeight:600,marginBottom:12,color:'#92400e'}}>üìä Auto-Calculated Results</h4>
                <div className="grid-3" style={{gap:10,marginBottom:12}}>
                    <div style={{background:'#f0fdf4',padding:10,borderRadius:8}}><label className="label" style={{color:'#16a34a'}}>SPI = BCWP/BCWS</label><input className="input input-sm auto-calc" disabled value={(evm.spiValue||0).toFixed(4)}/></div>
                    <div style={{background:'#fef3c7',padding:10,borderRadius:8}}><label className="label" style={{color:'#d97706'}}>CPI = BCWP/ACWP</label><input className="input input-sm auto-calc" disabled value={(evm.cpiValue||0).toFixed(4)}/></div>
                    <div style={{background:'#fef2f2',padding:10,borderRadius:8}}><label className="label" style={{color:'#dc2626'}}>CV = BCWP-ACWP</label><input className="input input-sm" disabled value={`$${((evm.cv||0)/1e6).toFixed(2)}M`}/></div>
                </div>
                <div className="grid-2" style={{gap:8}}>
                    <div style={{background:'#f8fafc',padding:8,borderRadius:6,display:'flex',justifyContent:'space-between',fontSize:11}}><span>EAC (Typical) = BAC/CPI</span><strong>${((evm.eacTypical||0)/1e6).toFixed(2)}M</strong></div>
                    <div style={{background:'#f8fafc',padding:8,borderRadius:6,display:'flex',justifyContent:'space-between',fontSize:11}}><span>EAC (Atypical)</span><strong>${((evm.eacAtypical||0)/1e6).toFixed(2)}M</strong></div>
                    <div style={{background:'#f8fafc',padding:8,borderRadius:6,display:'flex',justifyContent:'space-between',fontSize:11}}><span>EAC (Combined)</span><strong>${((evm.eacCombined||0)/1e6).toFixed(2)}M</strong></div>
                    <div style={{background:(evm.vac||0)>=0?'#dcfce7':'#fee2e2',padding:8,borderRadius:6,display:'flex',justifyContent:'space-between',fontSize:11}}><span>VAC = BAC - EAC</span><strong style={{color:(evm.vac||0)>=0?'#16a34a':'#dc2626'}}>${((evm.vac||0)/1e6).toFixed(2)}M</strong></div>
                </div>
            </div>
            
            {/* Schedule & Power Output */}
            <div style={{marginTop:16,padding:16,background:'#f0f9ff',borderRadius:8,border:'1px solid #3b82f6'}}>
                <h4 style={{fontWeight:600,marginBottom:12,color:'#1d4ed8'}}>‚è±Ô∏è Schedule & Power Output</h4>
                <div className="grid-2" style={{gap:12,marginBottom:12}}>
                    <div><label className="label">Actual / Forecast Net Power Output (MW)</label><input className="input" type="number" step="0.1" value={formData.actualForecastPower||''} onChange={e=>setFormData({...formData,actualForecastPower:Number(e.target.value)})} placeholder={`Guaranteed: ${selectedProject?.guaranteedPower||0} MW`}/></div>
                    <div style={{background:'#dbeafe',padding:12,borderRadius:8}}><label className="label" style={{color:'#1d4ed8'}}>Estimated Completion Date (Auto)</label><input className="input auto-calc" disabled value={calculateEstimatedCompletion(selectedProject?.startDate,selectedProject?.finishDate,evm.spiValue,formData.overallProgress?.actual)||'N/A'}/></div>
                </div>
            </div>
            
            {/* LD Estimation */}
            {(()=>{
                const estCompletion=calculateEstimatedCompletion(selectedProject?.startDate,selectedProject?.finishDate,evm.spiValue,formData.overallProgress?.actual);
                const delayDays=calculateDelayDays(selectedProject?.finishDate,estCompletion);
                const ldDelay=calculateLDDelay(delayDays,selectedProject?.ldDelay);
                const ldPerf=calculateLDPerformance(selectedProject?.guaranteedPower,formData.actualForecastPower,selectedProject?.ldPerformance);
                const totalLD=ldDelay+ldPerf;
                return totalLD>0||delayDays>0||(formData.actualForecastPower&&formData.actualForecastPower<(selectedProject?.guaranteedPower||0))?(
                    <div style={{marginTop:16,padding:16,background:'linear-gradient(135deg,#fef2f2,#fff1f2)',borderRadius:8,border:'1px solid #dc2626'}}>
                        <h4 style={{fontWeight:600,marginBottom:12,color:'#dc2626'}}>‚ö†Ô∏è Liquidated Damages Estimation</h4>
                        <div className="grid-3" style={{gap:12}}>
                            <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}>
                                <p style={{fontSize:10,color:'#64748b'}}>Delay Days</p>
                                <p style={{fontSize:18,fontWeight:800,color:delayDays>0?'#dc2626':'#16a34a'}}>{delayDays} days</p>
                                <p style={{fontSize:9,color:'#64748b'}}>LD Rate: ${(selectedProject?.ldDelay||0).toLocaleString()}/day</p>
                            </div>
                            <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}>
                                <p style={{fontSize:10,color:'#64748b'}}>Power Shortfall</p>
                                <p style={{fontSize:18,fontWeight:800,color:(formData.actualForecastPower||0)<(selectedProject?.guaranteedPower||0)?'#dc2626':'#16a34a'}}>{((selectedProject?.guaranteedPower||0)-(formData.actualForecastPower||0)).toFixed(1)} MW</p>
                                <p style={{fontSize:9,color:'#64748b'}}>LD Rate: ${(selectedProject?.ldPerformance||0).toLocaleString()}/kW</p>
                            </div>
                            <div style={{background:'#dc2626',padding:12,borderRadius:8,textAlign:'center'}}>
                                <p style={{fontSize:10,color:'white',opacity:0.9}}>Total LD Estimation</p>
                                <p style={{fontSize:20,fontWeight:800,color:'white'}}>${totalLD.toLocaleString()}</p>
                                <p style={{fontSize:9,color:'white',opacity:0.8}}>Delay: ${ldDelay.toLocaleString()} + Perf: ${ldPerf.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                ):null;
            })()}
            
            {/* TKDN Section */}
            <div style={{marginTop:16,padding:16,background:'linear-gradient(135deg,#ecfeff,#cffafe)',borderRadius:8,border:'1px solid #0891b2'}}>
                <h4 style={{fontWeight:600,marginBottom:12,color:'#0891b2'}}>üè≠ TKDN (Tingkat Komponen Dalam Negeri)</h4>
                <p style={{fontSize:11,color:'#64748b',marginBottom:12}}>Masukkan target minimum TKDN sesuai kontrak dan realisasi aktual berdasarkan laporan TKDN.</p>
                <div className="grid-2" style={{gap:12}}>
                    <div style={{background:'white',padding:12,borderRadius:8}}>
                        <label className="label" style={{color:'#3b82f6'}}>üìã Target Minimum TKDN (Plan) %</label>
                        <input className="input" type="number" step="0.1" min="0" max="100" 
                            value={formData.tkdn?.plan||''} 
                            onChange={e=>setFormData({...formData,tkdn:{...(formData.tkdn||{}),plan:Number(e.target.value)}})}
                            placeholder="e.g. 40"/>
                        <p style={{fontSize:9,color:'#64748b',marginTop:4}}>Sesuai persyaratan kontrak atau regulasi</p>
                    </div>
                    <div style={{background:'white',padding:12,borderRadius:8}}>
                        <label className="label" style={{color:'#0891b2'}}>üìä Realisasi TKDN (Actual) %</label>
                        <input className="input" type="number" step="0.1" min="0" max="100" 
                            value={formData.tkdn?.actual||''} 
                            onChange={e=>setFormData({...formData,tkdn:{...(formData.tkdn||{}),actual:Number(e.target.value)}})}
                            placeholder="e.g. 42.5"/>
                        <p style={{fontSize:9,color:'#64748b',marginTop:4}}>Berdasarkan verifikasi surveyor independen</p>
                    </div>
                </div>
                
                {/* TKDN Auto-calculated Results */}
                {(formData.tkdn?.plan>0 || formData.tkdn?.actual>0) && (()=>{
                    const tkdnPlan=formData.tkdn?.plan||0;
                    const tkdnActual=formData.tkdn?.actual||0;
                    const tkdnVariance=tkdnActual-tkdnPlan;
                    const tkdnStatus=tkdnActual>=tkdnPlan?'green':tkdnActual>=tkdnPlan*0.9?'yellow':'red';
                    const tkdnStatusColor=tkdnStatus==='green'?'#22c55e':tkdnStatus==='yellow'?'#f59e0b':'#ef4444';
                    return(
                        <div style={{marginTop:12,padding:12,background:'white',borderRadius:8,border:`2px solid ${tkdnStatusColor}`}}>
                            <div className="grid-4" style={{gap:10}}>
                                <div style={{textAlign:'center'}}>
                                    <p style={{fontSize:10,color:'#64748b'}}>Target</p>
                                    <p style={{fontSize:20,fontWeight:800,color:'#3b82f6'}}>{tkdnPlan}%</p>
                                </div>
                                <div style={{textAlign:'center'}}>
                                    <p style={{fontSize:10,color:'#64748b'}}>Actual</p>
                                    <p style={{fontSize:20,fontWeight:800,color:'#0891b2'}}>{tkdnActual.toFixed(1)}%</p>
                                </div>
                                <div style={{textAlign:'center'}}>
                                    <p style={{fontSize:10,color:'#64748b'}}>Variance</p>
                                    <p style={{fontSize:20,fontWeight:800,color:tkdnVariance>=0?'#22c55e':'#ef4444'}}>{tkdnVariance>=0?'+':''}{tkdnVariance.toFixed(1)}%</p>
                                </div>
                                <div style={{textAlign:'center',background:tkdnStatusColor,padding:10,borderRadius:6}}>
                                    <p style={{fontSize:10,color:'white',opacity:0.9}}>Status</p>
                                    <p style={{fontSize:14,fontWeight:800,color:'white'}}>
                                        {tkdnStatus==='green'?'‚úÖ PASS':tkdnStatus==='yellow'?'‚ö†Ô∏è MONITOR':'‚ùå RISK'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    );
                })()}
            </div>
        </div>}
        
        {activeTab==='cashflow'&&<div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
                <h4 style={{fontWeight:600}}>üíµ Cash Flow Input & Performance</h4>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <span style={{fontSize:12}}>Status:</span>
                    <span style={{fontSize:14,fontWeight:700}}>{cf.overallStatus==='green'?'üü¢ Healthy':cf.overallStatus==='yellow'?'üü° At Risk':'üî¥ Critical'}</span>
                    <span className={`badge ${cf.overallStatus==='green'?'badge-success':cf.overallStatus==='yellow'?'badge-warning':'badge-danger'}`}>{(cf.overallScore*100).toFixed(0)}%</span>
                </div>
            </div>
            
            <div className="grid-2" style={{gap:16,marginBottom:16}}>
                {/* Input Section */}
                <div style={{background:'#f8fafc',padding:16,borderRadius:8}}>
                    <h5 style={{fontWeight:600,marginBottom:12,color:'#475569'}}>üì• Input Data</h5>
                    <div style={{marginBottom:12}}><label className="label" style={{color:'#16a34a'}}>Revenue (from BCWP) - Auto</label><input className="input auto-calc" disabled value={`$${(revenue/1e6).toFixed(2)}M`}/><p style={{fontSize:9,color:'#64748b',marginTop:2}}>Otomatis dari BCWP di tab Progress & EVM</p></div>
                    <div style={{marginBottom:12}}><label className="label" style={{color:'#dc2626'}}>Cash Out</label><input className="input" type="number" value={cfRaw.cashOut||''} onChange={e=>handleCashFlowChange('cashOut',e.target.value)} placeholder="Enter cash out"/></div>
                    <div style={{marginBottom:12}}><label className="label" style={{color:'#2563eb'}}>Billing</label><input className="input" type="number" value={cfRaw.billing||''} onChange={e=>handleCashFlowChange('billing',e.target.value)} placeholder="Enter billing"/></div>
                    <div><label className="label" style={{color:'#7c3aed'}}>Cash In / AR</label><input className="input" type="number" value={cfRaw.cashIn||''} onChange={e=>handleCashFlowChange('cashIn',e.target.value)} placeholder="Enter cash in"/></div>
                </div>
                
                {/* Primary KPIs */}
                <div style={{background:'#fffbeb',padding:16,borderRadius:8,border:'1px solid #fbbf24'}}>
                    <h5 style={{fontWeight:600,marginBottom:12,color:'#92400e'}}>üìä Primary Indicators</h5>
                    <div style={{display:'grid',gap:8}}>
                        <div style={{display:'flex',justifyContent:'space-between',padding:8,background:'white',borderRadius:6}}>
                            <div><strong style={{fontSize:11}}>A. Cash Flow Balance</strong><br/><span style={{fontSize:9,color:'#64748b'}}>Cash In - Cash Out</span></div>
                            <div style={{textAlign:'right'}}><strong style={{color:cf.cashFlowBalance>=0?'#16a34a':'#dc2626'}}>${(cf.cashFlowBalance/1e6).toFixed(2)}M</strong><br/><span style={{fontSize:10}}>{cf.cashFlowBalance>=0?'üü¢ Surplus':'üî¥ Deficit'}</span></div>
                        </div>
                        <div style={{display:'flex',justifyContent:'space-between',padding:8,background:'white',borderRadius:6}}>
                            <div><strong style={{fontSize:11}}>B. Billing Coverage</strong><br/><span style={{fontSize:9,color:'#64748b'}}>Billing / Revenue</span></div>
                            <div style={{textAlign:'right'}}><strong>{cf.billingCoverageRatio.toFixed(2)}</strong><br/><span style={{fontSize:10}}>{cf.billingCoverageRatio>=0.95?'üü¢':cf.billingCoverageRatio>=0.85?'üü°':'üî¥'} {cf.billingCoverageRatio>=1?'On Track':'Under-billing'}</span></div>
                        </div>
                        <div style={{display:'flex',justifyContent:'space-between',padding:8,background:'white',borderRadius:6}}>
                            <div><strong style={{fontSize:11}}>C. Collection Ratio</strong><br/><span style={{fontSize:9,color:'#64748b'}}>Cash In / Billing</span></div>
                            <div style={{textAlign:'right'}}><strong>{cf.cashCollectionRatio.toFixed(2)}</strong><br/><span style={{fontSize:10}}>{cf.cashCollectionRatio>=0.9?'üü¢ Healthy':cf.cashCollectionRatio>=0.8?'üü° At Risk':'üî¥ Late Payment'}</span></div>
                        </div>
                        <div style={{display:'flex',justifyContent:'space-between',padding:8,background:'white',borderRadius:6}}>
                            <div><strong style={{fontSize:11}}>D. Cash Adequacy</strong><br/><span style={{fontSize:9,color:'#64748b'}}>Cash In / Cash Out</span></div>
                            <div style={{textAlign:'right'}}><strong>{cf.cashAdequacyRatio.toFixed(2)}</strong><br/><span style={{fontSize:10}}>{cf.cashAdequacyRatio>=1?'üü¢ Sufficient':'üî¥ Need Funding'}</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            {/* EVM Integration Metrics */}
            <div style={{background:'#f0fdf4',padding:16,borderRadius:8,border:'1px solid #22c55e'}}>
                <h5 style={{fontWeight:600,marginBottom:12,color:'#16a34a'}}>üîó EVM Integration Metrics</h5>
                <div className="grid-4" style={{gap:10}}>
                    <div style={{background:'white',padding:10,borderRadius:6,textAlign:'center'}}>
                        <p style={{fontSize:10,color:'#64748b'}}>E. Cash Burn Rate</p>
                        <p style={{fontSize:16,fontWeight:800}}>${(cf.cashBurnRate/1e6).toFixed(2)}M/wk</p>
                        <p style={{fontSize:8,color:'#64748b'}}>Cash Out / Week</p>
                    </div>
                    <div style={{background:'white',padding:10,borderRadius:6,textAlign:'center'}}>
                        <p style={{fontSize:10,color:'#64748b'}}>F. Earned Cash Ratio</p>
                        <p style={{fontSize:16,fontWeight:800,color:cf.earnedCashRatio>=1?'#16a34a':cf.earnedCashRatio>=0.85?'#f59e0b':'#dc2626'}}>{cf.earnedCashRatio.toFixed(2)}</p>
                        <p style={{fontSize:8,color:'#64748b'}}>Cash In / BCWP</p>
                    </div>
                    <div style={{background:'white',padding:10,borderRadius:6,textAlign:'center'}}>
                        <p style={{fontSize:10,color:'#64748b'}}>G. Billing Lag</p>
                        <p style={{fontSize:16,fontWeight:800,color:cf.billingLag<=0?'#16a34a':cf.billingLag<=2e6?'#f59e0b':'#dc2626'}}>${(cf.billingLag/1e6).toFixed(2)}M</p>
                        <p style={{fontSize:8,color:'#64748b'}}>BCWP - Billing</p>
                    </div>
                    <div style={{background:'white',padding:10,borderRadius:6,textAlign:'center'}}>
                        <p style={{fontSize:10,color:'#64748b'}}>H. Cash Gap (Critical)</p>
                        <p style={{fontSize:16,fontWeight:800,color:cf.cashGap<=0?'#16a34a':'#dc2626'}}>${(cf.cashGap/1e6).toFixed(2)}M</p>
                        <p style={{fontSize:8,color:'#64748b'}}>Cash Out - Cash In</p>
                    </div>
                </div>
            </div>
        </div>}
        
        {activeTab==='hse'&&<div><h4 style={{fontWeight:600,marginBottom:12,color:'#dc2626'}}>Lagging Indicators</h4><div className="grid-4" style={{gap:10,marginBottom:16}}>{[{k:'fatality',l:'Fatality'},{k:'lti',l:'LTI'},{k:'medicalTreatment',l:'Medical Treatment'},{k:'firstAid',l:'First Aid'}].map(({k,l})=>(<div key={k}><label className="label">{l}</label><input className="input input-sm" type="number" value={hse.lagging?.[k]||''} onChange={e=>setFormData({...formData,hse:{...hse,lagging:{...hse.lagging,[k]:Number(e.target.value)}}})}/></div>))}</div><h4 style={{fontWeight:600,marginBottom:12,color:'#16a34a'}}>Leading Indicators</h4><div className="grid-4" style={{gap:10,marginBottom:16}}>{[{k:'nearMiss',l:'Near Miss'},{k:'safetyObservation',l:'Safety Observation'},{k:'hsseInspection',l:'Inspection'},{k:'hsseTraining',l:'Training'}].map(({k,l})=>(<div key={k}><label className="label">{l}</label><input className="input input-sm" type="number" value={hse.leading?.[k]||''} onChange={e=>setFormData({...formData,hse:{...hse,leading:{...hse.leading,[k]:Number(e.target.value)}}})}/></div>))}</div><h4 style={{fontWeight:600,marginBottom:12}}>Manpower</h4><div className="grid-3" style={{gap:10}}><div><label className="label">Office</label><input className="input input-sm" type="number" value={hse.manpower?.office||''} onChange={e=>setFormData({...formData,hse:{...hse,manpower:{...hse.manpower,office:Number(e.target.value),total:Number(e.target.value)+(hse.manpower?.siteSubcontractor||0)}}})}/></div><div><label className="label">Site</label><input className="input input-sm" type="number" value={hse.manpower?.siteSubcontractor||''} onChange={e=>setFormData({...formData,hse:{...hse,manpower:{...hse.manpower,siteSubcontractor:Number(e.target.value),total:(hse.manpower?.office||0)+Number(e.target.value)}}})}/></div><div><label className="label">Safe Hours</label><input className="input input-sm" type="number" value={hse.safeHours||''} onChange={e=>setFormData({...formData,hse:{...hse,safeHours:Number(e.target.value)}})}/></div></div></div>}
        
        {activeTab==='quality'&&(()=>{
            const disciplines=['process','mechanical','piping','electrical','instrument','civil'];
            const q=formData.quality||{};
            const ho=q.headOffice||{};
            const so=q.siteOffice||{};
            const welding=so.welding||{};
            const ndtTotal=(welding.ndtAccepted||0)+(welding.ndtRejected||0);
            const rejectionRate=ndtTotal>0?((welding.ndtRejected||0)/ndtTotal)*100:0;
            const rejectionPlan=welding.rejectionRatePlan||2;
            const weldingStatus=rejectionRate<=rejectionPlan?'Pass':rejectionRate<=rejectionPlan*1.5?'Warning':'Fail';
            
            const updateQuality=(path,value)=>{
                const paths=path.split('.');
                setFormData(prev=>{
                    const newQ={...(prev.quality||{})};
                    let current=newQ;
                    for(let i=0;i<paths.length-1;i++){
                        current[paths[i]]=current[paths[i]]?{...current[paths[i]]}:{};
                        current=current[paths[i]];
                    }
                    current[paths[paths.length-1]]=value;
                    return{...prev,quality:newQ};
                });
            };
            
            return(<div style={{maxHeight:'50vh',overflowY:'auto'}}>
                {/* Tab Navigation */}
                <div style={{display:'flex',gap:8,marginBottom:16}}>
                    <button className={`btn ${!formData.qualityTab||formData.qualityTab==='headOffice'?'btn-primary':'btn-secondary'}`} style={{flex:1}} onClick={()=>setFormData({...formData,qualityTab:'headOffice'})}>üè¢ Head Office (Shop)</button>
                    <button className={`btn ${formData.qualityTab==='siteOffice'?'btn-primary':'btn-secondary'}`} style={{flex:1}} onClick={()=>setFormData({...formData,qualityTab:'siteOffice'})}>üèóÔ∏è Site Office (Construction)</button>
                </div>
                
                {/* Head Office Section */}
                {(!formData.qualityTab||formData.qualityTab==='headOffice')&&<div>
                    <h4 style={{fontWeight:700,marginBottom:12,color:'#0f766e',background:'#f0fdfa',padding:10,borderRadius:6}}>üè¢ HEAD OFFICE (SHOP)</h4>
                    
                    {/* AFI */}
                    <div style={{marginBottom:16}}>
                        <h5 style={{fontWeight:600,marginBottom:8,color:'#3b82f6'}}>üìã Application for Inspection (AFI)</h5>
                        <div style={{overflowX:'auto'}}>
                            <table className="table" style={{fontSize:11}}>
                                <thead><tr><th>Discipline</th><th style={{width:60,textAlign:'center'}}>Fail</th><th style={{width:60,textAlign:'center'}}>On Going</th><th style={{width:60,textAlign:'center'}}>Pass</th><th style={{width:60,textAlign:'center'}}>Total</th></tr></thead>
                                <tbody>
                                    {disciplines.map(d=>{const afi=ho.afi?.[d]||{};const total=(afi.fail||0)+(afi.ongoing||0)+(afi.pass||0);return(
                                        <tr key={d}><td style={{textTransform:'capitalize',fontWeight:600}}>{d}</td>
                                        <td><input className="input input-sm" type="number" style={{width:50,textAlign:'center'}} value={afi.fail||''} onChange={e=>updateQuality(`headOffice.afi.${d}.fail`,Number(e.target.value))}/></td>
                                        <td><input className="input input-sm" type="number" style={{width:50,textAlign:'center'}} value={afi.ongoing||''} onChange={e=>updateQuality(`headOffice.afi.${d}.ongoing`,Number(e.target.value))}/></td>
                                        <td><input className="input input-sm" type="number" style={{width:50,textAlign:'center'}} value={afi.pass||''} onChange={e=>updateQuality(`headOffice.afi.${d}.pass`,Number(e.target.value))}/></td>
                                        <td style={{textAlign:'center',fontWeight:600}}>{total}</td></tr>
                                    );})}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {/* NCR */}
                    <div style={{marginBottom:16}}>
                        <h5 style={{fontWeight:600,marginBottom:8,color:'#dc2626'}}>üìù NCR (Non-Conformance Report)</h5>
                        <div className="grid-2" style={{gap:12}}>
                            <div style={{background:'#fef2f2',padding:10,borderRadius:6}}>
                                <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#991b1b'}}>Owner ‚Üí Contractor</p>
                                <table className="table" style={{fontSize:10}}>
                                    <thead><tr><th>Discipline</th><th style={{width:50}}>Open</th><th style={{width:50}}>Closed</th></tr></thead>
                                    <tbody>{disciplines.map(d=>{const ncr=ho.ncr?.ownerToContractor?.[d]||{};return(<tr key={d}><td style={{textTransform:'capitalize'}}>{d}</td><td><input className="input input-sm" type="number" style={{width:45}} value={ncr.open||''} onChange={e=>updateQuality(`headOffice.ncr.ownerToContractor.${d}.open`,Number(e.target.value))}/></td><td><input className="input input-sm" type="number" style={{width:45}} value={ncr.closed||''} onChange={e=>updateQuality(`headOffice.ncr.ownerToContractor.${d}.closed`,Number(e.target.value))}/></td></tr>);})}</tbody>
                                </table>
                            </div>
                            <div style={{background:'#fff7ed',padding:10,borderRadius:6}}>
                                <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#9a3412'}}>Contractor ‚Üí Vendor</p>
                                <table className="table" style={{fontSize:10}}>
                                    <thead><tr><th>Discipline</th><th style={{width:50}}>Open</th><th style={{width:50}}>Closed</th></tr></thead>
                                    <tbody>{disciplines.map(d=>{const ncr=ho.ncr?.contractorToVendor?.[d]||{};return(<tr key={d}><td style={{textTransform:'capitalize'}}>{d}</td><td><input className="input input-sm" type="number" style={{width:45}} value={ncr.open||''} onChange={e=>updateQuality(`headOffice.ncr.contractorToVendor.${d}.open`,Number(e.target.value))}/></td><td><input className="input input-sm" type="number" style={{width:45}} value={ncr.closed||''} onChange={e=>updateQuality(`headOffice.ncr.contractorToVendor.${d}.closed`,Number(e.target.value))}/></td></tr>);})}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    {/* Punch List */}
                    <div>
                        <h5 style={{fontWeight:600,marginBottom:8,color:'#f59e0b'}}>üìå Punch List</h5>
                        <div className="grid-2" style={{gap:12}}>
                            <div style={{background:'#fefce8',padding:10,borderRadius:6}}>
                                <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#854d0e'}}>Owner ‚Üí Contractor</p>
                                <table className="table" style={{fontSize:10}}>
                                    <thead><tr><th>Discipline</th><th style={{width:50}}>Open</th><th style={{width:50}}>Closed</th></tr></thead>
                                    <tbody>{disciplines.map(d=>{const pl=ho.punchList?.ownerToContractor?.[d]||{};return(<tr key={d}><td style={{textTransform:'capitalize'}}>{d}</td><td><input className="input input-sm" type="number" style={{width:45}} value={pl.open||''} onChange={e=>updateQuality(`headOffice.punchList.ownerToContractor.${d}.open`,Number(e.target.value))}/></td><td><input className="input input-sm" type="number" style={{width:45}} value={pl.closed||''} onChange={e=>updateQuality(`headOffice.punchList.ownerToContractor.${d}.closed`,Number(e.target.value))}/></td></tr>);})}</tbody>
                                </table>
                            </div>
                            <div style={{background:'#f0fdf4',padding:10,borderRadius:6}}>
                                <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#166534'}}>Contractor ‚Üí Vendor</p>
                                <table className="table" style={{fontSize:10}}>
                                    <thead><tr><th>Discipline</th><th style={{width:50}}>Open</th><th style={{width:50}}>Closed</th></tr></thead>
                                    <tbody>{disciplines.map(d=>{const pl=ho.punchList?.contractorToVendor?.[d]||{};return(<tr key={d}><td style={{textTransform:'capitalize'}}>{d}</td><td><input className="input input-sm" type="number" style={{width:45}} value={pl.open||''} onChange={e=>updateQuality(`headOffice.punchList.contractorToVendor.${d}.open`,Number(e.target.value))}/></td><td><input className="input input-sm" type="number" style={{width:45}} value={pl.closed||''} onChange={e=>updateQuality(`headOffice.punchList.contractorToVendor.${d}.closed`,Number(e.target.value))}/></td></tr>);})}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>}
                
                {/* Site Office Section */}
                {formData.qualityTab==='siteOffice'&&<div>
                    <h4 style={{fontWeight:700,marginBottom:12,color:'#7c3aed',background:'#faf5ff',padding:10,borderRadius:6}}>üèóÔ∏è SITE OFFICE (CONSTRUCTION)</h4>
                    
                    {/* AFI */}
                    <div style={{marginBottom:16}}>
                        <h5 style={{fontWeight:600,marginBottom:8,color:'#3b82f6'}}>üìã Application for Inspection (AFI)</h5>
                        <div style={{overflowX:'auto'}}>
                            <table className="table" style={{fontSize:11}}>
                                <thead><tr><th>Discipline</th><th style={{width:60,textAlign:'center'}}>Fail</th><th style={{width:60,textAlign:'center'}}>On Going</th><th style={{width:60,textAlign:'center'}}>Pass</th><th style={{width:60,textAlign:'center'}}>Total</th></tr></thead>
                                <tbody>
                                    {disciplines.map(d=>{const afi=so.afi?.[d]||{};const total=(afi.fail||0)+(afi.ongoing||0)+(afi.pass||0);return(
                                        <tr key={d}><td style={{textTransform:'capitalize',fontWeight:600}}>{d}</td>
                                        <td><input className="input input-sm" type="number" style={{width:50,textAlign:'center'}} value={afi.fail||''} onChange={e=>updateQuality(`siteOffice.afi.${d}.fail`,Number(e.target.value))}/></td>
                                        <td><input className="input input-sm" type="number" style={{width:50,textAlign:'center'}} value={afi.ongoing||''} onChange={e=>updateQuality(`siteOffice.afi.${d}.ongoing`,Number(e.target.value))}/></td>
                                        <td><input className="input input-sm" type="number" style={{width:50,textAlign:'center'}} value={afi.pass||''} onChange={e=>updateQuality(`siteOffice.afi.${d}.pass`,Number(e.target.value))}/></td>
                                        <td style={{textAlign:'center',fontWeight:600}}>{total}</td></tr>
                                    );})}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {/* NCR */}
                    <div style={{marginBottom:16}}>
                        <h5 style={{fontWeight:600,marginBottom:8,color:'#dc2626'}}>üìù NCR (Non-Conformance Report)</h5>
                        <div className="grid-2" style={{gap:12}}>
                            <div style={{background:'#fef2f2',padding:10,borderRadius:6}}>
                                <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#991b1b'}}>Owner ‚Üí Contractor</p>
                                <table className="table" style={{fontSize:10}}>
                                    <thead><tr><th>Discipline</th><th style={{width:50}}>Open</th><th style={{width:50}}>Closed</th></tr></thead>
                                    <tbody>{disciplines.map(d=>{const ncr=so.ncr?.ownerToContractor?.[d]||{};return(<tr key={d}><td style={{textTransform:'capitalize'}}>{d}</td><td><input className="input input-sm" type="number" style={{width:45}} value={ncr.open||''} onChange={e=>updateQuality(`siteOffice.ncr.ownerToContractor.${d}.open`,Number(e.target.value))}/></td><td><input className="input input-sm" type="number" style={{width:45}} value={ncr.closed||''} onChange={e=>updateQuality(`siteOffice.ncr.ownerToContractor.${d}.closed`,Number(e.target.value))}/></td></tr>);})}</tbody>
                                </table>
                            </div>
                            <div style={{background:'#fff7ed',padding:10,borderRadius:6}}>
                                <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#9a3412'}}>Contractor ‚Üí Vendor</p>
                                <table className="table" style={{fontSize:10}}>
                                    <thead><tr><th>Discipline</th><th style={{width:50}}>Open</th><th style={{width:50}}>Closed</th></tr></thead>
                                    <tbody>{disciplines.map(d=>{const ncr=so.ncr?.contractorToVendor?.[d]||{};return(<tr key={d}><td style={{textTransform:'capitalize'}}>{d}</td><td><input className="input input-sm" type="number" style={{width:45}} value={ncr.open||''} onChange={e=>updateQuality(`siteOffice.ncr.contractorToVendor.${d}.open`,Number(e.target.value))}/></td><td><input className="input input-sm" type="number" style={{width:45}} value={ncr.closed||''} onChange={e=>updateQuality(`siteOffice.ncr.contractorToVendor.${d}.closed`,Number(e.target.value))}/></td></tr>);})}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    {/* Punch List */}
                    <div style={{marginBottom:16}}>
                        <h5 style={{fontWeight:600,marginBottom:8,color:'#f59e0b'}}>üìå Punch List</h5>
                        <div className="grid-2" style={{gap:12}}>
                            <div style={{background:'#fefce8',padding:10,borderRadius:6}}>
                                <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#854d0e'}}>Owner ‚Üí Contractor</p>
                                <table className="table" style={{fontSize:10}}>
                                    <thead><tr><th>Discipline</th><th style={{width:50}}>Open</th><th style={{width:50}}>Closed</th></tr></thead>
                                    <tbody>{disciplines.map(d=>{const pl=so.punchList?.ownerToContractor?.[d]||{};return(<tr key={d}><td style={{textTransform:'capitalize'}}>{d}</td><td><input className="input input-sm" type="number" style={{width:45}} value={pl.open||''} onChange={e=>updateQuality(`siteOffice.punchList.ownerToContractor.${d}.open`,Number(e.target.value))}/></td><td><input className="input input-sm" type="number" style={{width:45}} value={pl.closed||''} onChange={e=>updateQuality(`siteOffice.punchList.ownerToContractor.${d}.closed`,Number(e.target.value))}/></td></tr>);})}</tbody>
                                </table>
                            </div>
                            <div style={{background:'#f0fdf4',padding:10,borderRadius:6}}>
                                <p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#166534'}}>Contractor ‚Üí Vendor</p>
                                <table className="table" style={{fontSize:10}}>
                                    <thead><tr><th>Discipline</th><th style={{width:50}}>Open</th><th style={{width:50}}>Closed</th></tr></thead>
                                    <tbody>{disciplines.map(d=>{const pl=so.punchList?.contractorToVendor?.[d]||{};return(<tr key={d}><td style={{textTransform:'capitalize'}}>{d}</td><td><input className="input input-sm" type="number" style={{width:45}} value={pl.open||''} onChange={e=>updateQuality(`siteOffice.punchList.contractorToVendor.${d}.open`,Number(e.target.value))}/></td><td><input className="input input-sm" type="number" style={{width:45}} value={pl.closed||''} onChange={e=>updateQuality(`siteOffice.punchList.contractorToVendor.${d}.closed`,Number(e.target.value))}/></td></tr>);})}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    {/* Welding Performance */}
                    <div style={{background:weldingStatus==='Pass'?'#f0fdf4':weldingStatus==='Warning'?'#fffbeb':'#fef2f2',padding:16,borderRadius:8,border:`2px solid ${weldingStatus==='Pass'?'#22c55e':weldingStatus==='Warning'?'#f59e0b':'#ef4444'}`}}>
                        <h5 style={{fontWeight:700,marginBottom:12,color:weldingStatus==='Pass'?'#16a34a':weldingStatus==='Warning'?'#d97706':'#dc2626'}}>üîß Welding Performance</h5>
                        <div className="grid-3" style={{gap:12,marginBottom:12}}>
                            <div><label className="label">NDT Accepted</label><input className="input" type="number" value={welding.ndtAccepted||''} onChange={e=>updateQuality('siteOffice.welding.ndtAccepted',Number(e.target.value))}/></div>
                            <div><label className="label">NDT Rejected</label><input className="input" type="number" value={welding.ndtRejected||''} onChange={e=>updateQuality('siteOffice.welding.ndtRejected',Number(e.target.value))}/></div>
                            <div><label className="label">Rejection Rate Plan (%)</label><input className="input" type="number" step="0.1" value={welding.rejectionRatePlan||''} onChange={e=>updateQuality('siteOffice.welding.rejectionRatePlan',Number(e.target.value))} placeholder="e.g. 2"/></div>
                        </div>
                        <div className="grid-4" style={{gap:12}}>
                            <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Total NDT (Auto)</p><p style={{fontSize:20,fontWeight:800}}>{ndtTotal}</p></div>
                            <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Rejection Rate (Auto)</p><p style={{fontSize:20,fontWeight:800,color:rejectionRate<=rejectionPlan?'#16a34a':'#dc2626'}}>{rejectionRate.toFixed(2)}%</p></div>
                            <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Target Plan</p><p style={{fontSize:20,fontWeight:800,color:'#3b82f6'}}>‚â§{rejectionPlan}%</p></div>
                            <div style={{background:weldingStatus==='Pass'?'#16a34a':weldingStatus==='Warning'?'#f59e0b':'#dc2626',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'white',opacity:0.9}}>Status</p><p style={{fontSize:18,fontWeight:800,color:'white'}}>{weldingStatus==='Pass'?'‚úÖ PASS':weldingStatus==='Warning'?'‚ö†Ô∏è WARNING':'‚ùå FAIL'}</p></div>
                        </div>
                    </div>
                </div>}
                
                {/* Certificate Section - Always Visible */}
                <div style={{marginTop:16,background:'linear-gradient(135deg,#faf5ff,#f3e8ff)',padding:16,borderRadius:8,border:'2px solid #a855f7'}}>
                    <h5 style={{fontWeight:700,marginBottom:12,color:'#7c3aed'}}>üìú Certificate Status</h5>
                    <div className="grid-4" style={{gap:12}}>
                        <div><label className="label">Not Yet Applied</label><input className="input" type="number" value={q.certificate?.notYetApplied||''} onChange={e=>updateQuality('certificate.notYetApplied',Number(e.target.value))} placeholder="0"/></div>
                        <div><label className="label">Under Application</label><input className="input" type="number" value={q.certificate?.underApplication||''} onChange={e=>updateQuality('certificate.underApplication',Number(e.target.value))} placeholder="0"/></div>
                        <div><label className="label">Completed</label><input className="input" type="number" value={q.certificate?.completed||''} onChange={e=>updateQuality('certificate.completed',Number(e.target.value))} placeholder="0"/></div>
                        <div style={{background:'white',padding:12,borderRadius:8,textAlign:'center',border:'2px solid #7c3aed'}}><p style={{fontSize:10,color:'#64748b'}}>Total Certificate (Auto)</p><p style={{fontSize:24,fontWeight:800,color:'#7c3aed'}}>{(q.certificate?.notYetApplied||0)+(q.certificate?.underApplication||0)+(q.certificate?.completed||0)}</p></div>
                    </div>
                    <div style={{marginTop:12}}>
                        <p style={{fontSize:11,color:'#64748b',marginBottom:8}}>Progress</p>
                        <div style={{height:20,background:'#e2e8f0',borderRadius:10,overflow:'hidden',display:'flex'}}>
                            {(()=>{
                                const cert=q.certificate||{};
                                const total=(cert.notYetApplied||0)+(cert.underApplication||0)+(cert.completed||0);
                                const compPct=total>0?((cert.completed||0)/total)*100:0;
                                const underPct=total>0?((cert.underApplication||0)/total)*100:0;
                                const notYetPct=total>0?((cert.notYetApplied||0)/total)*100:0;
                                return(<>
                                    {compPct>0&&<div style={{width:`${compPct}%`,background:'#22c55e',display:'flex',alignItems:'center',justifyContent:'center'}}><span style={{fontSize:9,color:'white',fontWeight:600}}>{compPct.toFixed(0)}%</span></div>}
                                    {underPct>0&&<div style={{width:`${underPct}%`,background:'#f59e0b',display:'flex',alignItems:'center',justifyContent:'center'}}><span style={{fontSize:9,color:'white',fontWeight:600}}>{underPct.toFixed(0)}%</span></div>}
                                    {notYetPct>0&&<div style={{width:`${notYetPct}%`,background:'#94a3b8',display:'flex',alignItems:'center',justifyContent:'center'}}><span style={{fontSize:9,color:'white',fontWeight:600}}>{notYetPct.toFixed(0)}%</span></div>}
                                </>);
                            })()}
                        </div>
                        <div style={{display:'flex',justifyContent:'center',gap:16,marginTop:8}}>
                            <span style={{fontSize:9,display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,background:'#22c55e',borderRadius:2}}></span>Completed</span>
                            <span style={{fontSize:9,display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,background:'#f59e0b',borderRadius:2}}></span>Under Application</span>
                            <span style={{fontSize:9,display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,background:'#94a3b8',borderRadius:2}}></span>Not Yet Applied</span>
                        </div>
                    </div>
                </div>
            </div>);
        })()}
        
        {activeTab==='activities'&&<div className="grid-2" style={{gap:16}}><div><h4 style={{fontWeight:600,marginBottom:12,color:'#0f766e'}}>This Week</h4>{['engineering','procurement','construction','precommissioning'].map(cat=>(<div key={cat} style={{marginBottom:12}}><label className="label" style={{textTransform:'capitalize'}}>{cat}</label>{(thisWeek[cat]||['']).map((item,i)=>(<div key={i} style={{display:'flex',gap:6,marginBottom:4}}><input className="input input-sm" value={item} onChange={e=>updateActivity('thisWeekActivities',cat,i,e.target.value)}/><button className="btn btn-danger btn-xs" onClick={()=>removeActivityItem('thisWeekActivities',cat,i)}><Icons.X/></button></div>))}<button className="btn btn-secondary btn-xs" onClick={()=>addActivityItem('thisWeekActivities',cat)}><Icons.Plus/></button></div>))}</div><div><h4 style={{fontWeight:600,marginBottom:12,color:'#3b82f6'}}>Next Week</h4>{['engineering','procurement','construction','precommissioning'].map(cat=>(<div key={cat} style={{marginBottom:12}}><label className="label" style={{textTransform:'capitalize'}}>{cat}</label>{(nextWeek[cat]||['']).map((item,i)=>(<div key={i} style={{display:'flex',gap:6,marginBottom:4}}><input className="input input-sm" value={item} onChange={e=>updateActivity('nextWeekPlan',cat,i,e.target.value)}/><button className="btn btn-danger btn-xs" onClick={()=>removeActivityItem('nextWeekPlan',cat,i)}><Icons.X/></button></div>))}<button className="btn btn-secondary btn-xs" onClick={()=>addActivityItem('nextWeekPlan',cat)}><Icons.Plus/></button></div>))}</div></div>}
        
        {activeTab==='milestones'&&<div className="grid-2" style={{gap:16}}>
            <div>
                <div style={{display:'flex',justifyContent:'space-between',marginBottom:12}}><h4 style={{fontWeight:600,color:'#0f766e'}}>üìÖ Schedule Milestones</h4><button className="btn btn-primary btn-xs" onClick={()=>addMilestone('schedule')}><Icons.Plus/> Add</button></div>
                {(formData.milestonesSchedule||[]).map((m,i)=>(<div key={i} style={{background:'#f8fafc',padding:12,borderRadius:8,marginBottom:8}}>
                    <div style={{display:'flex',gap:6,marginBottom:8}}>
                        <input className="input input-sm" style={{width:40}} placeholder="#" value={m.no} onChange={e=>updateMilestone('schedule',i,'no',Number(e.target.value))}/>
                        <input className="input input-sm" style={{flex:1}} placeholder="Description" value={m.description} onChange={e=>updateMilestone('schedule',i,'description',e.target.value)}/>
                        <button className="btn btn-danger btn-xs" onClick={()=>removeMilestone('schedule',i)}><Icons.Delete/></button>
                    </div>
                    <div className="grid-3" style={{gap:6}}>
                        <div><label style={{fontSize:10,color:'#64748b',display:'block',marginBottom:2}}>Plan Date</label><input className="input input-sm" type="date" value={m.planDate||''} onChange={e=>updateMilestone('schedule',i,'planDate',e.target.value)}/></div>
                        <div><label style={{fontSize:10,color:'#64748b',display:'block',marginBottom:2}}>Actual / Forecast Date</label><input className="input input-sm" type="date" value={m.actualForecastDate||''} onChange={e=>updateMilestone('schedule',i,'actualForecastDate',e.target.value)}/></div>
                        <div><label style={{fontSize:10,color:'#64748b',display:'block',marginBottom:2}}>Status</label><select className="select" style={{padding:8,fontSize:12}} value={m.status||'On Track'} onChange={e=>updateMilestone('schedule',i,'status',e.target.value)}><option value="Delay">üî¥ Delay</option><option value="On Track">üü° On Track</option><option value="Completed">üü¢ Completed</option></select></div>
                    </div>
                </div>))}
                {(!formData.milestonesSchedule||formData.milestonesSchedule.length===0)&&<p style={{textAlign:'center',color:'#94a3b8',fontSize:12,padding:20}}>No schedule milestones</p>}
            </div>
            <div>
                <div style={{display:'flex',justifyContent:'space-between',marginBottom:12}}><h4 style={{fontWeight:600,color:'#f59e0b'}}>üí∞ Payment Milestones</h4><button className="btn btn-primary btn-xs" onClick={()=>addMilestone('payment')}><Icons.Plus/> Add</button></div>
                {(formData.milestonesPayment||[]).map((m,i)=>(<div key={i} style={{background:'#fef3c7',padding:12,borderRadius:8,marginBottom:8}}>
                    <div style={{display:'flex',gap:6,marginBottom:8}}>
                        <input className="input input-sm" style={{width:40}} placeholder="#" value={m.no} onChange={e=>updateMilestone('payment',i,'no',Number(e.target.value))}/>
                        <input className="input input-sm" style={{flex:1}} placeholder="Description" value={m.description} onChange={e=>updateMilestone('payment',i,'description',e.target.value)}/>
                        <button className="btn btn-danger btn-xs" onClick={()=>removeMilestone('payment',i)}><Icons.Delete/></button>
                    </div>
                    <div className="grid-3" style={{gap:6}}>
                        <div><label style={{fontSize:10,color:'#64748b',display:'block',marginBottom:2}}>Plan Date</label><input className="input input-sm" type="date" value={m.planDate||''} onChange={e=>updateMilestone('payment',i,'planDate',e.target.value)}/></div>
                        <div><label style={{fontSize:10,color:'#64748b',display:'block',marginBottom:2}}>Actual / Forecast Date</label><input className="input input-sm" type="date" value={m.actualForecastDate||''} onChange={e=>updateMilestone('payment',i,'actualForecastDate',e.target.value)}/></div>
                        <div><label style={{fontSize:10,color:'#64748b',display:'block',marginBottom:2}}>Status</label><select className="select" style={{padding:8,fontSize:12}} value={m.status||'On Track'} onChange={e=>updateMilestone('payment',i,'status',e.target.value)}><option value="Delay">üî¥ Delay</option><option value="On Track">üü° On Track</option><option value="Completed">üü¢ Completed</option></select></div>
                    </div>
                </div>))}
                {(!formData.milestonesPayment||formData.milestonesPayment.length===0)&&<p style={{textAlign:'center',color:'#94a3b8',fontSize:12,padding:20}}>No payment milestones</p>}
            </div>
        </div>}
        
        {activeTab==='uploads'&&<div className="grid-3" style={{gap:10}}>{['sCurveGeneral','cashFlow','qrPhotos','qrVideos','qrReport'].map(field=>(<div key={field} style={{background:'#f8fafc',padding:10,borderRadius:8}}><label className="label">{field.replace(/([A-Z])/g,' $1')}</label>{formData.uploads?.[field]?<div><img src={formData.uploads[field].data} style={{width:'100%',height:60,objectFit:'cover',borderRadius:4,marginBottom:4}}/><button className="btn btn-danger btn-xs" style={{width:'100%'}} onClick={()=>setFormData({...formData,uploads:{...formData.uploads,[field]:null}})}>Remove</button></div>:<label style={{display:'block',padding:12,border:'1px dashed #cbd5e1',borderRadius:6,textAlign:'center',cursor:'pointer'}}><input type="file" accept="image/*" style={{display:'none'}} onChange={e=>handleFileUpload(field,e)}/><span style={{fontSize:11,color:'#64748b'}}>Upload</span></label>}</div>))}</div>}
        
        </div><div style={{padding:12,borderTop:'1px solid #e2e8f0',display:'flex',justifyContent:'flex-end',gap:8}}><button className="btn btn-secondary" onClick={()=>setShowModal(null)}>Cancel</button><button className="btn btn-primary" onClick={saveReport}><Icons.Save/> Save</button></div></div></div>);
    };

    // View Report Modal
    const renderViewReportModal=()=>{
        if(!viewReportData)return null;
        const r=viewReportData;
        const proj=projects.find(p=>p.id===r.projectId);
        const cfm=getCashFlowMetrics(r);
        const cf=cfm||defaultCashFlow;
        
        return(<div className="modal-overlay" onClick={()=>{setShowModal(null);setViewReportData(null);}}><div className="modal" style={{maxWidth:1000}} onClick={e=>e.stopPropagation()}><div style={{padding:16,borderBottom:'1px solid #e2e8f0',display:'flex',justifyContent:'space-between',alignItems:'center',background:'linear-gradient(135deg,#0d9488,#0f766e)',color:'white'}}><div><h2 style={{fontSize:18,fontWeight:700}}>Weekly Report - Week {r.weekNo}</h2><p style={{fontSize:12,opacity:0.9}}>{r.docNo} | {proj?.name}</p></div><button onClick={()=>{setShowModal(null);setViewReportData(null);}} style={{background:'rgba(255,255,255,0.2)',border:'none',cursor:'pointer',padding:'6px 12px',borderRadius:6,color:'white'}}><Icons.X/></button></div>
        <div style={{padding:20,maxHeight:'75vh',overflowY:'auto'}}>
            <div style={{marginBottom:20}}><h4 style={{fontWeight:700,marginBottom:12,color:'#0f766e'}}>üìã General Information</h4><div className="grid-4" style={{gap:12}}><div style={{background:'#f8fafc',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Period</p><p style={{fontWeight:600,fontSize:13}}>{r.periodStart} - {r.periodEnd}</p></div><div style={{background:'#f8fafc',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Status</p><p><span className={`badge ${r.status==='Issued'?'badge-success':'badge-warning'}`}>{r.status}</span></p></div><div style={{background:'#f8fafc',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Prepared By</p><p style={{fontWeight:600,fontSize:13}}>{r.preparedBy||'-'}</p></div><div style={{background:'#f8fafc',padding:12,borderRadius:8}}><p style={{fontSize:10,color:'#64748b'}}>Checked By</p><p style={{fontWeight:600,fontSize:13}}>{r.checkedBy||'-'}</p></div></div></div>
            <div style={{marginBottom:20}}><h4 style={{fontWeight:700,marginBottom:12,color:'#3b82f6'}}>üìä Progress & EVM</h4><div className="grid-3" style={{gap:8,marginBottom:12}}><div style={{background:'#f8fafc',padding:10,borderRadius:8,textAlign:'center'}}><p style={{fontSize:9,color:'#64748b'}}>Plan</p><p style={{fontSize:16,fontWeight:700}}>{r.overallProgress?.plan?.toFixed(2)||0}%</p></div><div style={{background:'#f0fdf4',padding:10,borderRadius:8,textAlign:'center'}}><p style={{fontSize:9,color:'#64748b'}}>Actual</p><p style={{fontSize:16,fontWeight:700,color:'#16a34a'}}>{r.overallProgress?.actual?.toFixed(2)||0}%</p></div><div style={{background:(r.overallProgress?.variance||0)>=0?'#dcfce7':'#fee2e2',padding:10,borderRadius:8,textAlign:'center'}}><p style={{fontSize:9,color:'#64748b'}}>Variance</p><p style={{fontSize:16,fontWeight:700,color:(r.overallProgress?.variance||0)>=0?'#16a34a':'#dc2626'}}>{r.overallProgress?.variance?.toFixed(2)||0}%</p></div></div><div className="grid-4" style={{gap:8}}><div style={{background:(r.evm?.spiValue||1)>=1?'#dcfce7':'#fee2e2',padding:8,borderRadius:6,textAlign:'center'}}><p style={{fontSize:9,color:'#64748b'}}>SPI</p><p style={{fontSize:14,fontWeight:700}}>{r.evm?.spiValue?.toFixed(3)||'1.000'}</p></div><div style={{background:(r.evm?.cpiValue||1)>=1?'#dcfce7':'#fef3c7',padding:8,borderRadius:6,textAlign:'center'}}><p style={{fontSize:9,color:'#64748b'}}>CPI</p><p style={{fontSize:14,fontWeight:700}}>{r.evm?.cpiValue?.toFixed(2)||'1.00'}</p></div><div style={{background:'#f8fafc',padding:8,borderRadius:6,textAlign:'center'}}><p style={{fontSize:9,color:'#64748b'}}>EAC</p><p style={{fontSize:14,fontWeight:700}}>${((r.evm?.eac||0)/1e6).toFixed(1)}M</p></div><div style={{background:(r.evm?.vac||0)>=0?'#dcfce7':'#fee2e2',padding:8,borderRadius:6,textAlign:'center'}}><p style={{fontSize:9,color:'#64748b'}}>VAC</p><p style={{fontSize:14,fontWeight:700}}>${((r.evm?.vac||0)/1e6).toFixed(2)}M</p></div></div></div>
            <div style={{marginBottom:20}}><h4 style={{fontWeight:700,marginBottom:12,color:'#10b981'}}>üíµ Cash Flow</h4><div className="grid-4" style={{gap:12}}><div style={{background:'#f0fdf4',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Revenue</p><p style={{fontSize:16,fontWeight:700,color:'#16a34a'}}>${((cf.revenue||0)/1e6).toFixed(2)}M</p></div><div style={{background:'#fee2e2',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Cash Out</p><p style={{fontSize:16,fontWeight:700,color:'#dc2626'}}>${((cf.cashOut||0)/1e6).toFixed(2)}M</p></div><div style={{background:'#dbeafe',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Billing</p><p style={{fontSize:16,fontWeight:700,color:'#2563eb'}}>${((cf.billing||0)/1e6).toFixed(2)}M</p></div><div style={{background:'#f3e8ff',padding:12,borderRadius:8,textAlign:'center'}}><p style={{fontSize:10,color:'#64748b'}}>Cash In</p><p style={{fontSize:16,fontWeight:700,color:'#7c3aed'}}>${((cf.cashIn||0)/1e6).toFixed(2)}M</p></div></div><div style={{marginTop:12,padding:12,background:cf.overallStatus==='green'?'#dcfce7':cf.overallStatus==='yellow'?'#fef3c7':'#fee2e2',borderRadius:8,textAlign:'center'}}><p style={{fontSize:12}}>Status: <strong>{cf.overallStatus==='green'?'üü¢ Healthy':cf.overallStatus==='yellow'?'üü° At Risk':'üî¥ Critical'}</strong> (Score: {(cf.overallScore*100).toFixed(0)}%)</p></div></div>
            <div style={{marginBottom:20}}><h4 style={{fontWeight:700,marginBottom:12,color:'#6366f1'}}>üìÖ Milestones</h4><div className="grid-2" style={{gap:16}}><div><p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#0f766e'}}>Schedule Milestones</p><table className="table" style={{fontSize:11}}><thead><tr><th>#</th><th>Description</th><th>Plan</th><th>Actual/FC</th><th>Status</th></tr></thead><tbody>{(r.milestonesSchedule||[]).map((m,i)=>(<tr key={i}><td>{m.no}</td><td>{m.description}</td><td>{m.planDate||m.targetPlan||'-'}</td><td>{m.actualForecastDate||'-'}</td><td><span style={{background:m.status==='Completed'?'#dcfce7':m.status==='On Track'?'#fef3c7':'#fee2e2',color:m.status==='Completed'?'#16a34a':m.status==='On Track'?'#d97706':'#dc2626',padding:'2px 6px',borderRadius:999,fontSize:9,fontWeight:600}}>{m.status==='Completed'?'üü¢':m.status==='On Track'?'üü°':'üî¥'} {m.status}</span></td></tr>))}{(!r.milestonesSchedule||r.milestonesSchedule.length===0)&&<tr><td colSpan={5} style={{textAlign:'center',color:'#94a3b8'}}>No milestones</td></tr>}</tbody></table></div><div><p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#f59e0b'}}>Payment Milestones</p><table className="table" style={{fontSize:11}}><thead><tr><th>#</th><th>Description</th><th>Plan</th><th>Actual/FC</th><th>Status</th></tr></thead><tbody>{(r.milestonesPayment||[]).map((m,i)=>(<tr key={i}><td>{m.no}</td><td>{m.description}</td><td>{m.planDate||m.targetPlan||'-'}</td><td>{m.actualForecastDate||'-'}</td><td><span style={{background:m.status==='Completed'?'#dcfce7':m.status==='On Track'?'#fef3c7':'#fee2e2',color:m.status==='Completed'?'#16a34a':m.status==='On Track'?'#d97706':'#dc2626',padding:'2px 6px',borderRadius:999,fontSize:9,fontWeight:600}}>{m.status==='Completed'?'üü¢':m.status==='On Track'?'üü°':'üî¥'} {m.status}</span></td></tr>))}{(!r.milestonesPayment||r.milestonesPayment.length===0)&&<tr><td colSpan={5} style={{textAlign:'center',color:'#94a3b8'}}>No milestones</td></tr>}</tbody></table></div></div></div>
            <div><h4 style={{fontWeight:700,marginBottom:12,color:'#0891b2'}}>üìã Activities</h4><div className="grid-2" style={{gap:16}}><div style={{background:'#f0fdfa',padding:12,borderRadius:8}}><p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#0f766e'}}>This Week</p>{Object.entries(r.thisWeekActivities||{}).map(([cat,items])=>(<div key={cat} style={{marginBottom:8}}><p style={{fontWeight:600,fontSize:10,color:'#0f766e',textTransform:'capitalize'}}>{cat}</p><ul style={{paddingLeft:14,margin:0}}>{(Array.isArray(items)?items:[]).filter(i=>i).map((item,j)=><li key={j} style={{fontSize:11,color:'#475569'}}>{item}</li>)}</ul></div>))}</div><div style={{background:'#eff6ff',padding:12,borderRadius:8}}><p style={{fontSize:11,fontWeight:600,marginBottom:8,color:'#3b82f6'}}>Next Week Plan</p>{Object.entries(r.nextWeekPlan||{}).map(([cat,items])=>(<div key={cat} style={{marginBottom:8}}><p style={{fontWeight:600,fontSize:10,color:'#3b82f6',textTransform:'capitalize'}}>{cat}</p><ul style={{paddingLeft:14,margin:0}}>{(Array.isArray(items)?items:[]).filter(i=>i).map((item,j)=><li key={j} style={{fontSize:11,color:'#475569'}}>{item}</li>)}</ul></div>))}</div></div></div>
        </div>
        <div style={{padding:12,borderTop:'1px solid #e2e8f0',display:'flex',justifyContent:'flex-end',gap:8}}><button className="btn btn-secondary" onClick={()=>{setShowModal(null);setViewReportData(null);}}>Close</button><button className="btn btn-primary" onClick={()=>{setSelectedReportId(r.id);setActiveMenu('dashboard');setShowModal(null);setViewReportData(null);}}>Go to Dashboard</button></div></div></div>);
    };

    const renderProjectModal=()=>{
        const scheduleDuration=calculateScheduleDuration(formData.startDate,formData.finishDate);
        return(<div className="modal-overlay" onClick={()=>setShowModal(null)}><div className="modal" style={{maxWidth:900}} onClick={e=>e.stopPropagation()}><div style={{padding:16,borderBottom:'1px solid #e2e8f0'}}><h2 style={{fontSize:18,fontWeight:700}}>{editingId?'Edit':'Add'} Project</h2></div><div style={{padding:16,maxHeight:'70vh',overflowY:'auto'}}>
        <h4 style={{fontWeight:600,marginBottom:12,color:'#0f766e'}}>üìã Basic Information</h4>
        <div className="grid-2" style={{gap:12,marginBottom:16}}>
            <div style={{gridColumn:'span 2'}}><label className="label">Project Name</label><input className="input" value={formData.name||''} onChange={e=>setFormData({...formData,name:e.target.value})}/></div>
            <div><label className="label">Owner</label><input className="input" value={formData.owner||''} onChange={e=>setFormData({...formData,owner:e.target.value})}/></div>
            <div><label className="label">Contractor</label><input className="input" value={formData.contractor||''} onChange={e=>setFormData({...formData,contractor:e.target.value})}/></div>
            <div><label className="label">Technology Provider</label><input className="input" value={formData.technologyProvider||''} onChange={e=>setFormData({...formData,technologyProvider:e.target.value})}/></div>
            <div><label className="label">Contract Type</label><select className="select" value={formData.contractType||''} onChange={e=>setFormData({...formData,contractType:e.target.value})}><option value="">Select...</option><option value="EPC Turnkey">EPC Turnkey</option><option value="EPC Lumpsum">EPC Lumpsum</option><option value="EPCM">EPCM</option><option value="Design & Build">Design & Build</option></select></div>
        </div>
        
        <h4 style={{fontWeight:600,marginBottom:12,color:'#3b82f6'}}>üí∞ Contract & Payment</h4>
        <div className="grid-3" style={{gap:12,marginBottom:16}}>
            <div><label className="label">Contract Price (USD)</label><input className="input" type="number" value={formData.contractPrice||''} onChange={e=>setFormData({...formData,contractPrice:Number(e.target.value)})}/></div>
            <div><label className="label">BAC (USD)</label><input className="input" type="number" value={formData.bac||''} onChange={e=>setFormData({...formData,bac:Number(e.target.value)})}/></div>
            <div><label className="label">Term of Payment</label><select className="select" value={formData.termOfPayment||''} onChange={e=>setFormData({...formData,termOfPayment:e.target.value})}><option value="">Select...</option><option value="Progress Payment">Progress Payment</option><option value="Milestone">Milestone</option><option value="BOT">BOT</option><option value="Progress Payment & Milestone">Progress Payment & Milestone</option></select></div>
        </div>
        
        <h4 style={{fontWeight:600,marginBottom:12,color:'#dc2626'}}>‚ö†Ô∏è Liquidated Damages (LD)</h4>
        <div className="grid-2" style={{gap:12,marginBottom:16}}>
            <div><label className="label">LD Delay (USD/day)</label><input className="input" type="number" value={formData.ldDelay||''} onChange={e=>setFormData({...formData,ldDelay:Number(e.target.value)})} placeholder="e.g. 50000"/></div>
            <div><label className="label">LD Performance (USD/kW)</label><input className="input" type="number" value={formData.ldPerformance||''} onChange={e=>setFormData({...formData,ldPerformance:Number(e.target.value)})} placeholder="e.g. 100000"/></div>
        </div>
        
        <h4 style={{fontWeight:600,marginBottom:12,color:'#8b5cf6'}}>üìÖ Schedule</h4>
        <div className="grid-4" style={{gap:12,marginBottom:16}}>
            <div><label className="label">Start Date</label><input className="input" type="date" value={formData.startDate||''} onChange={e=>setFormData({...formData,startDate:e.target.value})}/></div>
            <div><label className="label">Finish Date</label><input className="input" type="date" value={formData.finishDate||''} onChange={e=>setFormData({...formData,finishDate:e.target.value})}/></div>
            <div><label className="label">NTP Date</label><input className="input" type="date" value={formData.ntpDate||''} onChange={e=>setFormData({...formData,ntpDate:e.target.value})}/></div>
            <div><label className="label">COD Date</label><input className="input" type="date" value={formData.codDate||''} onChange={e=>setFormData({...formData,codDate:e.target.value})}/></div>
        </div>
        <div className="grid-2" style={{gap:12,marginBottom:16}}>
            <div style={{background:'#f0fdf4',padding:12,borderRadius:8}}><label className="label" style={{color:'#16a34a'}}>Schedule Duration (Auto)</label><input className="input auto-calc" disabled value={`${scheduleDuration} days`}/></div>
            <div><label className="label">Guaranteed Net Power Output (MW)</label><input className="input" type="number" step="0.1" value={formData.guaranteedPower||''} onChange={e=>setFormData({...formData,guaranteedPower:Number(e.target.value)})} placeholder="e.g. 45"/></div>
        </div>
        
        <h4 style={{fontWeight:600,marginBottom:12,color:'#f59e0b'}}>üìù Scope</h4>
        <div style={{marginBottom:16}}><label className="label">Scope by Owner</label><textarea className="input" style={{minHeight:80}} value={formData.scopeByOwner||''} onChange={e=>setFormData({...formData,scopeByOwner:e.target.value})} placeholder="e.g. Site preparation, access road, temporary facilities..."/></div>
        
        </div><div style={{padding:12,borderTop:'1px solid #e2e8f0',display:'flex',justifyContent:'flex-end',gap:8}}><button className="btn btn-secondary" onClick={()=>setShowModal(null)}>Cancel</button><button className="btn btn-primary" onClick={saveProject}><Icons.Save/> Save</button></div></div></div>);
    };

    return(<div style={{display:'flex',minHeight:'100vh'}}><div className={`sidebar ${sidebarCollapsed?'collapsed':''}`}><div style={{display:'flex',alignItems:'center',gap:10,marginBottom:24,paddingLeft:4}}><div style={{width:36,height:36,background:'rgba(255,255,255,0.2)',borderRadius:8,display:'flex',alignItems:'center',justifyContent:'center'}}><Icons.Chart/></div><span className="sidebar-text" style={{fontWeight:800,fontSize:14,color:'white'}}>EPC Dashboard v4</span></div><nav>{[{id:'dashboard',icon:<Icons.Dashboard/>,label:'Dashboard'},{id:'projects',icon:<Icons.Project/>,label:'Projects'},{id:'reports',icon:<Icons.Report/>,label:'Weekly Reports'},{id:'scurve',icon:<Icons.Chart/>,label:'S-Curve & QR'},{id:'analysis',icon:<Icons.Analysis/>,label:'Risk Analysis'},{id:'data',icon:<Icons.Database/>,label:'Data Mgmt'}].map(item=>(<div key={item.id} className={`nav-item ${activeMenu===item.id?'active':''}`} onClick={()=>setActiveMenu(item.id)}>{item.icon}<span className="sidebar-text">{item.label}</span></div>))}</nav><div style={{position:'absolute',bottom:20,left:12,right:12}}><div className="nav-item" onClick={()=>setSidebarCollapsed(!sidebarCollapsed)}><Icons.Menu/><span className="sidebar-text">Collapse</span></div></div></div><div className={`main-content ${sidebarCollapsed?'expanded':''}`}>{activeMenu==='dashboard'&&renderDashboard()}{activeMenu==='projects'&&renderProjects()}{activeMenu==='reports'&&renderReports()}{activeMenu==='scurve'&&renderSCurve()}{activeMenu==='analysis'&&renderAnalysis()}{activeMenu==='data'&&renderDataMgmt()}</div>{showModal==='project'&&renderProjectModal()}{showModal==='report'&&renderReportModal()}{showModal==='viewReport'&&renderViewReportModal()}{imageViewer&&<div className="modal-overlay" style={{background:'rgba(0,0,0,0.9)'}} onClick={()=>setImageViewer(null)}><div style={{position:'relative',maxWidth:'90vw',maxHeight:'90vh'}}><div style={{position:'absolute',top:-36,left:0,right:0,display:'flex',justifyContent:'space-between',alignItems:'center'}}><h3 style={{color:'white',fontWeight:600,fontSize:13}}>{imageViewer.title}</h3><button onClick={()=>setImageViewer(null)} style={{background:'rgba(255,255,255,0.2)',border:'none',borderRadius:6,padding:'4px 10px',color:'white',cursor:'pointer',fontSize:11}}>‚úï Close</button></div><img src={imageViewer.src} alt={imageViewer.title} style={{maxWidth:'90vw',maxHeight:'85vh',objectFit:'contain',borderRadius:8}} onClick={e=>e.stopPropagation()}/></div></div>}{notification&&<div className="toast" style={{background:notification.type==='error'?'#dc2626':'#0f766e'}}><Icons.Check/>{notification.msg}</div>}</div>);
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
